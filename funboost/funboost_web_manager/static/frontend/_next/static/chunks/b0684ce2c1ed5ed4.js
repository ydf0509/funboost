(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,38645,e=>{"use strict";var s=e.i(43476),a=e.i(71645),t=e.i(62162),l=e.i(38171),n=e.i(57998),r=e.i(75254);let i=(0,r.default)("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),c=(0,r.default)("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]);var u=e.i(63209),o=e.i(37727);function d({message:e,type:t="info",duration:l=3e3,onClose:n}){let[r,d]=(0,a.useState)(!0);(0,a.useEffect)(()=>{let e=setTimeout(()=>{d(!1),setTimeout(n,300)},l);return()=>clearTimeout(e)},[l,n]);let m={success:(0,s.jsx)(i,{className:"h-5 w-5 text-[hsl(var(--success))]"}),error:(0,s.jsx)(c,{className:"h-5 w-5 text-[hsl(var(--danger))]"}),warning:(0,s.jsx)(u.AlertCircle,{className:"h-5 w-5 text-[hsl(var(--warning))]"}),info:(0,s.jsx)(u.AlertCircle,{className:"h-5 w-5 text-[hsl(var(--accent))]"})};return(0,s.jsxs)("div",{className:`flex items-center gap-3 rounded-xl border px-4 py-3 shadow-lg backdrop-blur-sm transition-all duration-300 ${{success:"border-[hsl(var(--success))]/30 bg-[hsl(var(--success))]/10",error:"border-[hsl(var(--danger))]/30 bg-[hsl(var(--danger))]/10",warning:"border-[hsl(var(--warning))]/30 bg-[hsl(var(--warning))]/10",info:"border-[hsl(var(--accent))]/30 bg-[hsl(var(--accent))]/10"}[t]} ${r?"translate-y-0 opacity-100":"translate-y-2 opacity-0"}`,children:[m[t],(0,s.jsx)("span",{className:"text-sm text-[hsl(var(--ink))]",children:e}),(0,s.jsx)("button",{onClick:()=>{d(!1),setTimeout(n,300)},className:"ml-2 p-1 rounded-full hover:bg-[hsl(var(--sand-2))] text-[hsl(var(--ink-muted))] hover:text-[hsl(var(--ink))]",children:(0,s.jsx)(o.X,{className:"h-4 w-4"})})]})}function m({toasts:e,onRemove:a}){return(0,s.jsx)("div",{className:"fixed bottom-4 right-4 z-50 flex flex-col-reverse gap-2",children:e.map(e=>(0,s.jsx)(d,{message:e.message,type:e.type,onClose:()=>a(e.id)},e.id))})}var x=e.i(9165),h=e.i(68402),p=e.i(84030),_=e.i(80580);let j=0,v=[60,120,180,360,720,1440,8640],g=[{value:5,label:"5秒"},{value:10,label:"10秒"},{value:30,label:"30秒"},{value:60,label:"60秒"}];var f=e.i(3116),N=e.i(16715),b=e.i(39312),w=e.i(59544),y=e.i(39964),k=e.i(3812),C=e.i(56660);function S({search:e,activeOnly:a,onSearchChange:t,onActiveOnlyChange:l,loading:n,autoRefresh:r,refreshInterval:i,canOperateQueue:c,onRefresh:u,onRefreshAllMsgCounts:o,onStartAutoConsume:d,onToggleAutoRefresh:m,onIntervalChange:x}){return(0,s.jsx)(y.Card,{children:(0,s.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-sm text-[hsl(var(--ink-muted))]",children:"队列搜索"}),(0,s.jsx)(k.Input,{placeholder:"请输入队列名称搜索...",value:e,onChange:e=>t(e.target.value),className:"w-64"})]}),(0,s.jsx)(C.Toggle,{checked:a,onChange:l,label:"仅显示消费队列"})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,s.jsxs)(w.Button,{variant:"secondary",size:"sm",onClick:o,className:"cursor-pointer",children:[(0,s.jsx)(N.RefreshCw,{className:"h-4 w-4"}),"刷新消息数量"]}),(0,s.jsxs)(w.Button,{variant:"primary",size:"sm",onClick:d,className:"cursor-pointer",disabled:!c,children:[(0,s.jsx)(b.Zap,{className:"h-4 w-4"}),"启动自动消费"]}),(0,s.jsxs)(w.Button,{variant:"outline",size:"sm",onClick:u,disabled:n,children:[(0,s.jsx)(N.RefreshCw,{className:`h-4 w-4 ${n?"animate-spin":""}`}),"数据刷新"]}),(0,s.jsxs)("div",{className:"flex items-center gap-1 rounded-full border border-[hsl(var(--line))] p-0.5",children:[(0,s.jsx)("span",{className:"px-2 text-xs text-[hsl(var(--ink-muted))]",children:"刷新间隔:"}),g.map(e=>(0,s.jsx)("button",{onClick:()=>x(e.value),className:`px-2 py-1 text-xs rounded-full transition cursor-pointer ${i===e.value?"bg-[hsl(var(--accent))] text-white":"text-[hsl(var(--ink-muted))] hover:text-[hsl(var(--ink))]"}`,children:e.label},e.value))]}),(0,s.jsxs)(w.Button,{variant:r?"primary":"outline",size:"sm",onClick:m,children:[(0,s.jsx)(f.Clock,{className:"h-4 w-4"}),r?"刷新中...":"已暂停"]})]})]})})}let q=(0,r.default)("chart-line",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]]);var B=e.i(64659);let T=(0,r.default)("chevron-up",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]);var $=e.i(86536),I=e.i(94827),R=e.i(52571),z=e.i(95242),P=e.i(31343),D=e.i(27612),O=e.i(96640),F=e.i(40803),M=e.i(58700),E=e.i(75379);function A({queues:e,loading:a,currentPage:t,pageSize:l,totalCount:n,sortField:r,sortDirection:i,canOperateQueue:c,canClearQueue:u,onPageChange:o,onPageSizeChange:d,onSort:m,onViewConfig:x,onViewChart:h,onViewConsumers:p,onOpenInsight:_,onQueueAction:j}){let v=({field:e})=>r!==e?(0,s.jsx)(B.ChevronDown,{className:"h-3 w-3 opacity-30"}):"asc"===i?(0,s.jsx)(T,{className:"h-3 w-3"}):(0,s.jsx)(B.ChevronDown,{className:"h-3 w-3"}),g=({field:e,children:a})=>(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap cursor-pointer hover:text-[hsl(var(--ink))]",onClick:()=>m(e),children:(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[a,(0,s.jsx)(v,{field:e})]})});return(0,s.jsxs)(y.Card,{children:[(0,s.jsx)("div",{className:"overflow-x-auto",children:a?(0,s.jsxs)("div",{className:"py-8 text-center text-sm text-[hsl(var(--ink-muted))]",children:[(0,s.jsx)(N.RefreshCw,{className:"h-8 w-8 mx-auto mb-2 animate-spin text-[hsl(var(--accent))]"}),"正在加载队列..."]}):0===e.length?(0,s.jsx)(F.EmptyState,{title:"未找到队列",subtitle:"调整筛选条件或刷新列表。"}):(0,s.jsxs)("table",{className:"w-full text-sm",children:[(0,s.jsx)("thead",{className:"text-left text-xs uppercase tracking-wider text-[hsl(var(--ink-muted))] bg-[hsl(var(--sand-2))]",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"洞察"}),(0,s.jsx)(g,{field:"queue_name",children:"名称"}),(0,s.jsx)(g,{field:"active_consumers",children:"消费者数量"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"Broker类型"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"消费函数"}),(0,s.jsx)(g,{field:"all_consumers_last_execute_task_time",children:"最近执行时间"}),(0,s.jsx)(g,{field:"msg_num_in_broker",children:"消息数量"}),(0,s.jsx)(g,{field:"history_run_count",children:"历史运行次数"}),(0,s.jsx)(g,{field:"history_run_fail_count",children:"历史失败次数"}),(0,s.jsx)(g,{field:"all_consumers_last_x_s_execute_count",children:"近10秒完成"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"近10秒失败"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"累计平均耗时"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"状态"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"操作"})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-[hsl(var(--line))]",children:e.map(e=>{let a=(e.active_consumers?.length??0)>0,t=1===e.pause_flag,l=e.queue_params?.consuming_function_name??"-";return(0,s.jsxs)("tr",{className:"hover:bg-[hsl(var(--sand-2))]/50 transition-colors",children:[(0,s.jsx)("td",{className:"px-3 py-3",children:(0,s.jsxs)(w.Button,{variant:"secondary",size:"sm",className:"h-7 px-2",onClick:()=>_(e),children:[(0,s.jsx)(I.Gauge,{className:"h-3 w-3"}),"洞察"]})}),(0,s.jsx)("td",{className:"px-3 py-3",children:(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"font-medium text-[hsl(var(--ink))]",children:e.queue_name}),a?(0,s.jsx)(O.Badge,{tone:"success",children:"消费"}):(0,s.jsx)(O.Badge,{tone:"neutral",children:"等待"}),t&&(0,s.jsx)(O.Badge,{tone:"warning",children:"已暂停"})]})}),(0,s.jsx)("td",{className:"px-3 py-3 text-center",children:(0,s.jsx)(O.Badge,{tone:a?"success":"neutral",children:e.active_consumers?.length??0})}),(0,s.jsx)("td",{className:"px-3 py-3",children:(0,s.jsx)(O.Badge,{tone:"info",children:e.queue_params?.broker_kind??"-"})}),(0,s.jsx)("td",{className:"px-3 py-3 text-[hsl(var(--ink))]",children:(0,s.jsx)("code",{className:"text-xs bg-[hsl(var(--sand-2))] px-1.5 py-0.5 rounded",children:l})}),(0,s.jsx)("td",{className:"px-3 py-3 text-xs text-[hsl(var(--ink-muted))] whitespace-nowrap",children:(0,E.formatDateTime)(e.all_consumers_last_execute_task_time??null)}),(0,s.jsx)("td",{className:"px-3 py-3 text-center",children:(0,s.jsx)(O.Badge,{tone:"warning",children:(0,E.formatNumber)(e.msg_num_in_broker??0)})}),(0,s.jsx)("td",{className:"px-3 py-3 text-center text-[hsl(var(--ink))]",children:(0,E.formatNumber)(e.history_run_count??0)}),(0,s.jsx)("td",{className:"px-3 py-3 text-center",children:(0,s.jsx)("span",{className:e.history_run_fail_count?"text-[hsl(var(--danger))]":"text-[hsl(var(--ink-muted))]",children:(0,E.formatNumber)(e.history_run_fail_count??0)})}),(0,s.jsx)("td",{className:"px-3 py-3 text-center text-[hsl(var(--ink))]",children:e.all_consumers_last_x_s_execute_count??0}),(0,s.jsx)("td",{className:"px-3 py-3 text-center",children:(0,s.jsx)("span",{className:e.all_consumers_last_x_s_execute_count_fail?"text-[hsl(var(--danger))]":"text-[hsl(var(--ink-muted))]",children:e.all_consumers_last_x_s_execute_count_fail??0})}),(0,s.jsx)("td",{className:"px-3 py-3 text-center text-[hsl(var(--ink))]",children:e.all_consumers_avarage_function_spend_time_from_start?`${e.all_consumers_avarage_function_spend_time_from_start.toFixed(3)}s`:"-"}),(0,s.jsx)("td",{className:"px-3 py-3",children:t?(0,s.jsx)(O.Badge,{tone:"warning",children:"暂停中"}):a?(0,s.jsx)(O.Badge,{tone:"success",children:"运行中"}):(0,s.jsx)(O.Badge,{tone:"neutral",children:"空闲"})}),(0,s.jsx)("td",{className:"px-3 py-3",children:(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)(w.Button,{variant:"secondary",size:"sm",className:"h-7 px-2",onClick:()=>x(e),children:(0,s.jsx)($.Eye,{className:"h-3 w-3"})}),(0,s.jsx)(w.Button,{variant:"ghost",size:"sm",className:"h-7 px-2",onClick:()=>h(e),children:(0,s.jsx)(q,{className:"h-3 w-3"})}),(0,s.jsx)(w.Button,{variant:"ghost",size:"sm",className:"h-7 px-2",onClick:()=>p(e),children:(0,s.jsx)(R.Info,{className:"h-3 w-3"})}),(0,s.jsx)(w.Button,{variant:"ghost",size:"sm",className:"h-7 px-2",onClick:()=>j(e,t?"resume":"pause"),disabled:!c,children:t?(0,s.jsx)(P.Play,{className:"h-3 w-3"}):(0,s.jsx)(z.Pause,{className:"h-3 w-3"})}),(0,s.jsx)(w.Button,{variant:"ghost",size:"sm",className:"h-7 px-2 text-[hsl(var(--danger))]",onClick:()=>j(e,"clear"),disabled:!u,children:(0,s.jsx)(D.Trash2,{className:"h-3 w-3"})})]})})]},e.queue_name)})})]})}),(0,s.jsx)(M.Pagination,{currentPage:t,pageSize:l,totalCount:n,onPageChange:o,onPageSizeChange:d,loading:a})]})}var J=e.i(21218),U=e.i(17923),V=e.i(68054),Q=e.i(61911),H=e.i(32098),L=e.i(34084);function G({queue:e,onOpenJson:t}){let n=(0,a.useMemo)(()=>{let s=e.all_consumers_last_x_s_execute_count??0,a=e.all_consumers_last_x_s_execute_count_fail??0;return{qps:s/10,failRate:s?a/s*100:0,backlog:e.msg_num_in_broker??0,avgTime:e.all_consumers_avarage_function_spend_time_from_start??0}},[e]);return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[(0,s.jsx)(l.StatCard,{label:"QPS",value:n.qps.toFixed(2),helper:"近10秒均值",tone:"info"}),(0,s.jsx)(l.StatCard,{label:"失败率",value:`${n.failRate.toFixed(1)}%`,helper:"近10秒",tone:"danger"}),(0,s.jsx)(l.StatCard,{label:"积压",value:(0,E.formatNumber)(n.backlog),helper:"消息数",tone:"warning"}),(0,s.jsx)(l.StatCard,{label:"平均耗时",value:`${n.avgTime.toFixed(3)}s`,helper:"累计",tone:"success"})]}),(0,s.jsx)(y.Card,{children:(0,s.jsxs)("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(L.SectionHeader,{title:"基础信息",subtitle:"队列核心参数概览"}),(0,s.jsxs)("div",{className:"mt-3 grid gap-3 text-sm text-[hsl(var(--ink))]",children:[(0,s.jsxs)("div",{className:"flex flex-wrap gap-3",children:[(0,s.jsxs)(O.Badge,{tone:"info",children:["Broker: ",e.queue_params?.broker_kind??"-"]}),(0,s.jsxs)(O.Badge,{tone:"neutral",children:["函数: ",e.queue_params?.consuming_function_name??"-"]}),1===e.pause_flag&&(0,s.jsx)(O.Badge,{tone:"warning",children:"暂停中"})]}),(0,s.jsxs)("div",{className:"text-xs text-[hsl(var(--ink-muted))]",children:["最近执行: ",(0,E.formatDateTime)(e.all_consumers_last_execute_task_time??null)]})]})]}),(0,s.jsx)("div",{className:"flex items-center gap-2",children:(0,s.jsx)(w.Button,{variant:"secondary",size:"sm",onClick:()=>t("队列配置",JSON.stringify(e.queue_params??{},null,2)),children:"查看配置"})})]})})]})}var K=e.i(43531),X=e.i(74886),Z=e.i(67073);let W=[{minutes:1,label:"1分钟"},{minutes:10,label:"10分钟"},{minutes:60,label:"1小时"},{minutes:360,label:"6小时"},{minutes:1440,label:"1天"}],Y=[{value:5,label:"5秒"},{value:10,label:"10秒"},{value:30,label:"30秒"},{value:60,label:"60秒"}];function ee({queueName:e,projectId:t,canOperateQueue:n,onOpenJson:r}){let[i,c]=(0,a.useState)([]),[u,o]=(0,a.useState)(!1),[d,m]=(0,a.useState)("all"),[p,_]=(0,a.useState)(""),[j,v]=(0,a.useState)(""),[g,b]=(0,a.useState)(""),[C,S]=(0,a.useState)(""),[q,B]=(0,a.useState)(""),[T,I]=(0,a.useState)(null),[R,z]=(0,a.useState)(null),[P,D]=(0,a.useState)(0),[F,A]=(0,a.useState)(10),[J,U]=(0,a.useState)(0),[V,Q]=(0,a.useState)(null),H=(0,a.useCallback)(async()=>{if(e&&C&&q){o(!0);try{let s=(0,x.buildQuery)({col_name:e,start_time:(0,E.toBackendDateTime)(C),end_time:(0,E.toBackendDateTime)(q),is_success:"all"===d?"":d,function_params:p,task_id:j,page:P,page_size:F,project_id:t||""}),a=await (0,x.apiFetch)(`/query_result?${s}`);c(a.data),U(a.total_count);let l=(0,x.buildQuery)({col_name:e,start_time:(0,E.toBackendDateTime)(C),end_time:(0,E.toBackendDateTime)(q),project_id:t||""}),n=await (0,x.apiFetch)(`/speed_stats?${l}`);I(n);let r=await (0,x.funboostFetch)(`/funboost/get_msg_count?queue_name=${encodeURIComponent(e)}${t?`&project_id=${t}`:""}`);z(r.count)}finally{o(!1)}}},[e,C,q,d,p,j,P,F,t]),{enabled:G,toggle:ee,intervalMs:es,setIntervalMs:ea}=(0,h.useAutoRefresh)(H,!1,3e4),et=es/1e3;(0,a.useEffect)(()=>{if(!e)return;let s=new Date,a=new Date(s.getTime()-36e5);S((0,E.toDateTimeInputValue)(a)),B((0,E.toDateTimeInputValue)(s)),D(0),m("all"),_(""),v(""),b("")},[e]),(0,a.useEffect)(()=>{e&&C&&q&&H()},[e,C,q,H]);let el=async e=>{await navigator.clipboard.writeText(e),Q(e),setTimeout(()=>Q(null),1500)},en=async s=>{if(!n)return;let a=JSON.parse(s.params_str||"{}");await (0,x.funboostFetch)("/funboost/publish",{method:"POST",json:{queue_name:e,msg_body:a,task_id:s.task_id,project_id:t}})},er=(0,a.useMemo)(()=>{if(!g)return i;let e=Number(g);return Number.isNaN(e)?i:i.filter(s=>s.time_cost>=e)},[i,g]),ei=(e,s=40)=>{if(null==e)return"-";let a="string"==typeof e?e:JSON.stringify(e);return a?a.length<=s?a:`${a.slice(0,s)}...`:"-"};return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center justify-end gap-2",children:[(0,s.jsxs)(w.Button,{variant:"outline",size:"sm",onClick:H,disabled:u,children:[(0,s.jsx)(N.RefreshCw,{className:`h-4 w-4 ${u?"animate-spin":""}`}),"数据刷新"]}),(0,s.jsxs)("div",{className:"flex items-center gap-1 rounded-full border border-[hsl(var(--line))] p-0.5",children:[(0,s.jsx)("span",{className:"px-2 text-xs text-[hsl(var(--ink-muted))]",children:"刷新间隔:"}),Y.map(e=>(0,s.jsx)("button",{onClick:()=>ea(1e3*e.value),className:`px-2 py-1 text-xs rounded-full transition ${et===e.value?"bg-[hsl(var(--accent))] text-white":"text-[hsl(var(--ink-muted))] hover:text-[hsl(var(--ink))]"}`,children:e.label},e.value))]}),(0,s.jsxs)(w.Button,{variant:G?"primary":"outline",size:"sm",onClick:ee,children:[(0,s.jsx)(f.Clock,{className:"h-4 w-4"}),G?"刷新中...":"已暂停"]})]}),(0,s.jsxs)(y.Card,{children:[(0,s.jsxs)("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsx)("label",{className:"text-xs font-medium text-[hsl(var(--ink-muted))]",children:"起始时间"}),(0,s.jsx)(k.Input,{type:"datetime-local",value:C,onChange:e=>S(e.target.value)})]}),(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsx)("label",{className:"text-xs font-medium text-[hsl(var(--ink-muted))]",children:"截止时间"}),(0,s.jsx)(k.Input,{type:"datetime-local",value:q,onChange:e=>B(e.target.value)})]}),(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsx)("label",{className:"text-xs font-medium text-[hsl(var(--ink-muted))]",children:"运行状态"}),(0,s.jsxs)(Z.Select,{value:d,onChange:e=>m(e.target.value),children:[(0,s.jsx)("option",{value:"all",children:"全部"}),(0,s.jsx)("option",{value:"2",children:"成功"}),(0,s.jsx)("option",{value:"3",children:"失败"})]})]}),(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsx)("label",{className:"text-xs font-medium text-[hsl(var(--ink-muted))]",children:"Task ID"}),(0,s.jsx)(k.Input,{placeholder:"输入 task_id...",value:j,onChange:e=>v(e.target.value)})]})]}),(0,s.jsxs)("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[(0,s.jsx)("span",{className:"text-xs text-[hsl(var(--ink-muted))]",children:"快捷时间:"}),W.map(e=>(0,s.jsxs)("button",{onClick:()=>{let s=new Date,a=new Date(s.getTime()-60*e.minutes*1e3);S((0,E.toDateTimeInputValue)(a)),B((0,E.toDateTimeInputValue)(s))},className:"px-3 py-1.5 text-xs rounded-full border border-[hsl(var(--line))] text-[hsl(var(--ink-muted))] hover:border-[hsl(var(--accent))] hover:text-[hsl(var(--accent))]",children:["近",e.label]},e.minutes)),(0,s.jsx)("div",{className:"flex-1"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("label",{className:"text-xs text-[hsl(var(--ink-muted))]",children:"函数参数"}),(0,s.jsx)(k.Input,{className:"w-40",placeholder:"参数关键字",value:p,onChange:e=>_(e.target.value)})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("label",{className:"text-xs text-[hsl(var(--ink-muted))]",children:"最小耗时(秒)"}),(0,s.jsx)(k.Input,{className:"w-20",placeholder:"如 1",value:g,onChange:e=>b(e.target.value)})]}),(0,s.jsxs)(w.Button,{variant:"primary",onClick:()=>{D(0),H()},children:[(0,s.jsx)(N.RefreshCw,{className:"h-4 w-4"}),"查询"]})]})]}),(0,s.jsxs)("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[(0,s.jsx)(l.StatCard,{label:"当前队列",value:e,helper:"已选范围"}),(0,s.jsx)(l.StatCard,{label:"查询统计",value:T?(0,s.jsxs)("span",{children:[(0,s.jsxs)("span",{className:"text-[hsl(var(--success))]",children:["成功: ",(0,E.formatNumber)(T.success_num)]})," / ",(0,s.jsxs)("span",{className:"text-[hsl(var(--danger))]",children:["失败: ",(0,E.formatNumber)(T.fail_num)]})]}):"-",helper:"时间范围内"}),(0,s.jsx)(l.StatCard,{label:"队列剩余",value:null!==R?(0,E.formatNumber)(R):"-",helper:"当前消息"}),(0,s.jsx)(l.StatCard,{label:"失败率",value:T?`${(T.fail_num/Math.max(T.success_num+T.fail_num,1)*100).toFixed(1)}%`:"-",helper:"时间范围",tone:"danger"})]}),(0,s.jsxs)(y.Card,{children:[(0,s.jsx)("div",{className:"flex items-center justify-between mb-3",children:(0,s.jsx)(L.SectionHeader,{title:"执行记录列表",subtitle:""})}),(0,s.jsx)("div",{className:"overflow-x-auto",children:u?(0,s.jsxs)("div",{className:"py-8 text-center text-sm text-[hsl(var(--ink-muted))]",children:[(0,s.jsx)(N.RefreshCw,{className:"h-8 w-8 mx-auto mb-2 animate-spin text-[hsl(var(--accent))]"}),"正在加载结果..."]}):0===er.length?(0,s.jsx)("div",{className:"py-8 text-center text-sm text-[hsl(var(--ink-muted))]",children:"暂无结果"}):(0,s.jsxs)("table",{className:"w-full text-sm",children:[(0,s.jsx)("thead",{className:"text-left text-xs uppercase tracking-wider text-[hsl(var(--ink-muted))] bg-[hsl(var(--sand-2))]",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"函数"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"Task ID"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"参数"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"结果/异常"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"耗时"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"状态"}),(0,s.jsx)("th",{className:"px-3 py-3 font-medium whitespace-nowrap",children:"操作"})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-[hsl(var(--line))]",children:er.map((e,a)=>{let t=!e.success,l="running"===e.run_status;return(0,s.jsxs)("tr",{className:"hover:bg-[hsl(var(--sand-2))]/50 transition-colors",children:[(0,s.jsx)("td",{className:"px-3 py-3 font-medium text-[hsl(var(--ink))] whitespace-nowrap max-w-[160px]",children:(0,s.jsx)("span",{className:"truncate block",title:e.function,children:e.function})}),(0,s.jsx)("td",{className:"px-3 py-3 text-xs text-[hsl(var(--ink-muted))] max-w-[180px]",children:(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"truncate block",title:e.task_id,children:ei(e.task_id,20)}),(0,s.jsx)("button",{onClick:()=>el(e.task_id),className:"p-1 rounded hover:bg-[hsl(var(--sand-2))] text-[hsl(var(--ink-muted))] hover:text-[hsl(var(--accent))]",title:"复制 Task ID",children:V===e.task_id?(0,s.jsx)(K.Check,{className:"h-3 w-3 text-[hsl(var(--success))]"}):(0,s.jsx)(X.Copy,{className:"h-3 w-3"})})]})}),(0,s.jsx)("td",{className:"px-3 py-3 max-w-[160px]",children:(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"text-xs text-[hsl(var(--ink-muted))] truncate block max-w-[80px]",children:ei(e.params_str,20)}),e.params_str&&"-"!==e.params_str&&(0,s.jsx)(w.Button,{variant:"ghost",size:"sm",className:"p-1 h-auto",onClick:()=>r("函数入参",e.params_str),children:(0,s.jsx)($.Eye,{className:"h-3 w-3"})})]})}),(0,s.jsx)("td",{className:"px-3 py-3 max-w-[160px]",children:(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"text-xs text-[hsl(var(--ink-muted))] truncate block max-w-[80px]",children:ei(e.result||e.exception,20)}),(e.result||e.exception)&&(0,s.jsx)(w.Button,{variant:"ghost",size:"sm",className:"p-1 h-auto",onClick:()=>r(t?"异常信息":"函数结果",e.result||e.exception),children:(0,s.jsx)($.Eye,{className:"h-3 w-3"})})]})}),(0,s.jsxs)("td",{className:"px-3 py-3 text-[hsl(var(--ink))] whitespace-nowrap",children:[e.time_cost?.toFixed(3)||"-","s"]}),(0,s.jsx)("td",{className:"px-3 py-3 whitespace-nowrap",children:l?(0,s.jsx)(O.Badge,{tone:"info",children:"运行中"}):t?(0,s.jsx)(O.Badge,{tone:"danger",children:"失败"}):(0,s.jsx)(O.Badge,{tone:"success",children:"成功"})}),(0,s.jsx)("td",{className:"px-3 py-3 whitespace-nowrap",children:t?(0,s.jsx)(w.Button,{variant:"outline",size:"sm",className:"h-7 px-2",onClick:()=>en(e),disabled:!n,children:"重试"}):(0,s.jsx)("span",{className:"text-xs text-[hsl(var(--ink-muted))]",children:"-"})})]},`${e.task_id}-${a}`)})})]})}),(0,s.jsx)(M.Pagination,{currentPage:P,pageSize:F,totalCount:J,onPageChange:D,onPageSizeChange:e=>{A(e),D(0)},loading:u})]})]})}var es=e.i(22726);function ea({queueName:e,projectId:t}){let[n,r]=(0,a.useState)([]),[i,c]=(0,a.useState)(!1),[u,o]=(0,a.useState)(360),[d,m]=(0,a.useState)(""),[p,_]=(0,a.useState)(""),j=(0,a.useCallback)(async()=>{if(e&&d&&p){c(!0);try{let s=Math.floor(new Date(d).getTime()/1e3),a=Math.floor(new Date(p).getTime()/1e3),l=`/queue/get_time_series_data/${encodeURIComponent(e)}?start_ts=${s}&end_ts=${a}&curve_samples_count=${u}`;t&&(l+=`&project_id=${t}`);let n=await (0,x.apiFetch)(l);r(n)}finally{c(!1)}}},[e,d,p,u,t]),{enabled:g,toggle:b,intervalMs:y,setIntervalMs:k}=(0,h.useAutoRefresh)(j,!1,3e4),C=y/1e3;(0,a.useEffect)(()=>{if(!e)return;let s=new Date,a=new Date(s.getTime()-36e5);m((0,E.toDateTimeInputValue)(a)),_((0,E.toDateTimeInputValue)(s))},[e]),(0,a.useEffect)(()=>{e&&d&&p&&j()},[e,d,p,j]);let S=(0,a.useMemo)(()=>{if(0===n.length)return{totalSuccess:0,totalFail:0,qps:0};let e=n[0],s=n[n.length-1],a=Math.max(0,(s.report_data.history_run_count??0)-(e.report_data.history_run_count??0)),t=Math.max(0,(s.report_data.history_run_fail_count??0)-(e.report_data.history_run_fail_count??0));return{totalSuccess:a,totalFail:t,qps:(a+t)/Math.max(s.report_ts-e.report_ts,1)}},[n]);return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center justify-end gap-2",children:[(0,s.jsxs)(w.Button,{variant:"outline",size:"sm",onClick:j,disabled:i,children:[(0,s.jsx)(N.RefreshCw,{className:`h-4 w-4 ${i?"animate-spin":""}`}),"数据刷新"]}),(0,s.jsxs)("div",{className:"flex items-center gap-1 rounded-full border border-[hsl(var(--line))] p-0.5",children:[(0,s.jsx)("span",{className:"px-2 text-xs text-[hsl(var(--ink-muted))]",children:"刷新间隔:"}),Y.map(e=>(0,s.jsx)("button",{onClick:()=>k(1e3*e.value),className:`px-2 py-1 text-xs rounded-full transition ${C===e.value?"bg-[hsl(var(--accent))] text-white":"text-[hsl(var(--ink-muted))] hover:text-[hsl(var(--ink))]"}`,children:e.label},e.value))]}),(0,s.jsxs)(w.Button,{variant:g?"primary":"outline",size:"sm",onClick:b,children:[(0,s.jsx)(f.Clock,{className:"h-4 w-4"}),g?"刷新中...":"已暂停"]})]}),(0,s.jsxs)("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[(0,s.jsx)(l.StatCard,{label:"成功",value:(0,E.formatNumber)(S.totalSuccess),helper:"累计",tone:"success"}),(0,s.jsx)(l.StatCard,{label:"失败",value:(0,E.formatNumber)(S.totalFail),helper:"累计",tone:"danger"}),(0,s.jsx)(l.StatCard,{label:"总计",value:(0,E.formatNumber)(S.totalSuccess+S.totalFail),helper:"事件",tone:"info"}),(0,s.jsx)(l.StatCard,{label:"QPS",value:S.qps.toFixed(2),helper:"平均速率",tone:"warning"})]}),(0,s.jsx)(es.QueueTimeSeriesChart,{queueName:e,data:n,loading:i,startTime:d,endTime:p,sampleCount:u,sampleOptions:v,onStartTimeChange:m,onEndTimeChange:_,onSampleCountChange:o,onRefresh:j})]})}var et=e.i(14764),el=e.i(82744);function en({queueName:e,canOperateQueue:t}){let[l,n]=(0,a.useState)("{}"),[r,i]=(0,a.useState)(!0),[c,u]=(0,a.useState)(60),[o,d]=(0,a.useState)(""),[m,h]=(0,a.useState)(30),[p,_]=(0,a.useState)(null),[j,v]=(0,a.useState)(!1),[g,f]=(0,a.useState)(!1),[b,S]=(0,a.useState)("-"),[q,B]=(0,a.useState)(null),[T,$]=(0,a.useState)(null),I=(0,a.useMemo)(()=>(T?.active_consumers??[]).length>0,[T]),R=(0,a.useCallback)(async()=>{if(!e)return;let s=await (0,x.funboostFetch)(`/funboost/get_one_queue_config?queue_name=${encodeURIComponent(e)}`);S(s?.queue_params?.consuming_function_name||s?.auto_generate_info?.function_name||"-"),$(await (0,x.funboostFetch)(`/funboost/get_queue_run_info?queue_name=${encodeURIComponent(e)}`));let a=s.auto_generate_info?.final_func_input_params_info;if(B(a||null),a){let e={};a.must_arg_name_list?.forEach(s=>{e[s]=""}),a.optional_arg_name_list?.forEach(s=>{e[s]=null}),n(JSON.stringify(e,null,2))}else n("{}")},[e]);(0,a.useEffect)(()=>{e&&(_(null),d(""),R())},[e,R]);let z=async()=>{if(t)try{v(!0),_(null);let s=JSON.parse(l||"{}"),a=await (0,x.funboostFetch)("/funboost/publish",{method:"POST",json:{queue_name:e,msg_body:s,need_result:r,timeout:c}});_({task_id:a.task_id,...a.status_and_result}),d(a.task_id)}finally{v(!1)}},P=async()=>{if(o)try{f(!0);let e=await (0,x.funboostFetch)(`/funboost/get_result?task_id=${encodeURIComponent(o)}&timeout=${m}`);_({task_id:e.task_id,...e.status_and_result})}finally{f(!1)}};return(0,s.jsx)("div",{className:"space-y-4",children:(0,s.jsxs)("div",{className:"grid gap-4 md:grid-cols-2",children:[(0,s.jsxs)(y.Card,{children:[(0,s.jsx)(L.SectionHeader,{title:"RPC 参数",subtitle:"输入 JSON 参数并发送"}),(0,s.jsxs)("div",{className:"mt-3 space-y-3",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,s.jsxs)(O.Badge,{tone:"info",children:["函数: ",b]}),(0,s.jsx)(O.Badge,{tone:I?"success":"warning",children:I?"消费者在线":"无消费者"})]}),q&&(0,s.jsxs)("div",{className:"text-xs text-[hsl(var(--ink-muted))]",children:["必填: ",(q.must_arg_name_list??[]).join(", ")||"-"," | 可选: ",(q.optional_arg_name_list??[]).join(", ")||"-"]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-xs font-medium text-[hsl(var(--ink-muted))]",children:"JSON 参数"}),(0,s.jsx)("textarea",{className:"w-full min-h-[180px] rounded-xl border border-[hsl(var(--line))] bg-[hsl(var(--sand))] p-3 text-xs font-mono",value:l,onChange:e=>n(e.target.value)})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,s.jsx)(C.Toggle,{checked:r,onChange:i,label:"需要结果"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("label",{className:"text-xs text-[hsl(var(--ink-muted))]",children:"超时"}),(0,s.jsx)(k.Input,{type:"number",className:"w-20",value:c,onChange:e=>u(Number(e.target.value))})]}),(0,s.jsxs)(w.Button,{variant:"primary",onClick:z,disabled:j||!t,children:[(0,s.jsx)(et.Send,{className:"h-4 w-4"}),"发送 RPC"]})]})]})]}),(0,s.jsxs)(y.Card,{children:[(0,s.jsx)(L.SectionHeader,{title:"结果",subtitle:"执行回执"}),(0,s.jsxs)("div",{className:"mt-3 space-y-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("label",{className:"text-xs text-[hsl(var(--ink-muted))]",children:"Task ID"}),(0,s.jsx)(k.Input,{value:o,onChange:e=>d(e.target.value),placeholder:"任务ID"}),(0,s.jsx)(k.Input,{type:"number",className:"w-20",value:m,onChange:e=>h(Number(e.target.value)),placeholder:"超时"}),(0,s.jsxs)(w.Button,{variant:"outline",size:"sm",onClick:P,disabled:g,children:[(0,s.jsx)(N.RefreshCw,{className:`h-4 w-4 ${g?"animate-spin":""}`}),"查询"]})]}),(0,s.jsx)(el.JsonViewer,{data:p,maxHeight:"320px"})]})]})]})})}function er({queueName:e,projectId:t,onOpenJson:n}){let[r,i]=(0,a.useState)([]),[c,u]=(0,a.useState)(!1),o=(0,a.useCallback)(async()=>{if(e){u(!0);try{let s=`/running_consumer/hearbeat_info_by_queue_name?queue_name=${encodeURIComponent(e)}`;t&&(s+=`&project_id=${t}`);let a=await (0,x.apiFetch)(s);i(a)}finally{u(!1)}}},[e,t]);return(0,a.useEffect)(()=>{e&&o()},[e,o]),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("div",{className:"flex items-center justify-end",children:(0,s.jsxs)(w.Button,{variant:"outline",size:"sm",onClick:o,disabled:c,children:[(0,s.jsx)(N.RefreshCw,{className:`h-4 w-4 ${c?"animate-spin":""}`}),"刷新消费者"]})}),(0,s.jsxs)("div",{className:"grid gap-4 md:grid-cols-3",children:[(0,s.jsx)(l.StatCard,{label:"当前队列",value:e,helper:"洞察范围"}),(0,s.jsx)(l.StatCard,{label:"消费者",value:r.length,helper:"当前运行"}),(0,s.jsx)(l.StatCard,{label:"当前心跳",value:r[0]?.hearbeat_datetime_str??"-",helper:"最近记录"})]}),(0,s.jsxs)(y.Card,{children:[(0,s.jsx)(L.SectionHeader,{title:"消费者列表",subtitle:"心跳与吞吐详情。"}),(0,s.jsx)("div",{className:"mt-4 overflow-x-auto",children:c?(0,s.jsx)("div",{className:"text-sm text-[hsl(var(--ink-muted))]",children:"正在加载消费者..."}):0===r.length?(0,s.jsx)("div",{className:"text-sm text-[hsl(var(--ink-muted))]",children:"暂无心跳数据。"}):(0,s.jsxs)("table",{className:"min-w-full text-sm",children:[(0,s.jsx)("thead",{className:"text-left text-xs uppercase tracking-[0.18em] text-[hsl(var(--ink-muted))]",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"pb-3",children:"队列"}),(0,s.jsx)("th",{className:"pb-3",children:"函数"}),(0,s.jsx)("th",{className:"pb-3",children:"主机"}),(0,s.jsx)("th",{className:"pb-3",children:"心跳"}),(0,s.jsx)("th",{className:"pb-3",children:"近 10 秒"}),(0,s.jsx)("th",{className:"pb-3",children:"累计"}),(0,s.jsx)("th",{className:"pb-3",children:"操作"})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-[hsl(var(--line))]",children:r.map((e,a)=>(0,s.jsxs)("tr",{className:"hover:bg-[hsl(var(--sand-2))]/50 transition-colors",children:[(0,s.jsx)("td",{className:"py-4 font-semibold text-[hsl(var(--ink))]",children:e.queue_name??"-"}),(0,s.jsx)("td",{className:"py-4 text-[hsl(var(--ink-muted))]",children:e.consuming_function??"-"}),(0,s.jsxs)("td",{className:"py-4 text-[hsl(var(--ink-muted))]",children:[(0,s.jsx)("div",{children:e.computer_ip??"-"}),(0,s.jsx)("div",{className:"text-xs text-[hsl(var(--ink-muted))]",children:e.computer_name??"-"})]}),(0,s.jsxs)("td",{className:"py-4 text-xs text-[hsl(var(--ink-muted))]",children:[(0,s.jsxs)("div",{children:["启动 ",e.start_datetime_str??"-"]}),(0,s.jsxs)("div",{children:["心跳 ",e.hearbeat_datetime_str??"-"]})]}),(0,s.jsxs)("td",{className:"py-4 text-xs text-[hsl(var(--ink-muted))]",children:[(0,s.jsxs)("div",{children:["成功 ",e.last_x_s_execute_count??0]}),(0,s.jsxs)("div",{children:["失败 ",e.last_x_s_execute_count_fail??0]})]}),(0,s.jsxs)("td",{className:"py-4 text-xs text-[hsl(var(--ink-muted))]",children:[(0,s.jsxs)("div",{children:["累计 ",e.total_consume_count_from_start??0]}),(0,s.jsxs)("div",{children:["失败 ",e.total_consume_count_from_start_fail??0]})]}),(0,s.jsx)("td",{className:"py-4",children:(0,s.jsx)(w.Button,{variant:"outline",size:"sm",onClick:()=>n("消费者详情",JSON.stringify(e??{},null,2)),children:"详情"})})]},`${e.queue_name}-${e.process_id}-${a}`))})]})})]})]})}function ei({open:e,queue:t,activeTab:l,onTabChange:r,onClose:i}){let{currentProject:c}=(0,_.useProject)(),{canExecute:u}=(0,p.useActionPermissions)("queue"),o=c?.permission_level??"admin",d=!c||"write"===o||"admin"===o,m=u&&d,[x,h]=(0,a.useState)(!1),[j,v]=(0,a.useState)(""),[g,f]=(0,a.useState)(""),N=(e,s)=>{v(e),f(s),h(!0)};if(!t)return null;let b=[{id:"overview",label:"概览",icon:(0,s.jsx)(I.Gauge,{className:"h-4 w-4"})},{id:"results",label:"结果",icon:(0,s.jsx)(J.Activity,{className:"h-4 w-4"})},{id:"speed",label:"速率",icon:(0,s.jsx)(U.BarChart3,{className:"h-4 w-4"})},{id:"rpc",label:"RPC",icon:(0,s.jsx)(V.Terminal,{className:"h-4 w-4"})},{id:"consumers",label:"消费者",icon:(0,s.jsx)(Q.Users,{className:"h-4 w-4"})}];return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(H.Modal,{open:e,title:`队列洞察 \xb7 ${t.queue_name}`,subtitle:t.queue_params?.consuming_function_name||"",onClose:i,size:"xxl",contentMaxHeight:"78vh",footer:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-xs text-[hsl(var(--ink-muted))]",children:[(0,s.jsx)("span",{children:"状态:"}),1===t.pause_flag?(0,s.jsx)(O.Badge,{tone:"warning",children:"暂停"}):(t.active_consumers?.length??0)>0?(0,s.jsx)(O.Badge,{tone:"success",children:"运行中"}):(0,s.jsx)(O.Badge,{tone:"neutral",children:"空闲"}),(0,s.jsx)("span",{className:"ml-2",children:"消费者:"}),(0,s.jsx)(O.Badge,{tone:(t.active_consumers?.length??0)>0?"success":"neutral",children:t.active_consumers?.length??0}),(0,s.jsx)("span",{className:"ml-2",children:"消息:"}),(0,s.jsx)(O.Badge,{tone:"warning",children:t.msg_num_in_broker??0})]}),(0,s.jsx)(w.Button,{variant:"outline",onClick:i,children:"关闭"})]}),children:(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("div",{className:"flex flex-wrap items-center gap-2 border-b border-[hsl(var(--line))]/60 pb-3",children:b.map(e=>(0,s.jsxs)("button",{onClick:()=>r(e.id),className:`inline-flex items-center gap-2 rounded-full border px-3 py-1.5 text-xs transition ${l===e.id?"border-[hsl(var(--accent))] bg-[hsl(var(--accent))] text-white":"border-[hsl(var(--line))] text-[hsl(var(--ink-muted))] hover:text-[hsl(var(--ink))]"}`,children:[e.icon,e.label]},e.id))}),"overview"===l&&(0,s.jsx)(G,{queue:t,onOpenJson:N}),"results"===l&&(0,s.jsx)(ee,{queueName:t.queue_name,projectId:c?.id?.toString(),canOperateQueue:m,onOpenJson:N}),"speed"===l&&(0,s.jsx)(ea,{queueName:t.queue_name,projectId:c?.id?.toString()}),"rpc"===l&&(0,s.jsx)(en,{queueName:t.queue_name,canOperateQueue:m}),"consumers"===l&&(0,s.jsx)(er,{queueName:t.queue_name,projectId:c?.id?.toString(),onOpenJson:N})]})}),(0,s.jsx)(n.JsonViewerModal,{open:x,title:j,content:g,onClose:()=>h(!1)})]})}function ec(){let[e,r]=(0,a.useState)([]),[i,c]=(0,a.useState)(!1),[u,o]=(0,a.useState)(""),[d,v]=(0,a.useState)(!1),[g,f]=(0,a.useState)(0),[N,b]=(0,a.useState)(20),[w,y]=(0,a.useState)("queue_name"),[k,C]=(0,a.useState)("asc"),[q,B]=(0,a.useState)(null),[T,$]=(0,a.useState)("overview"),[I,R]=(0,a.useState)(!1),[z,P]=(0,a.useState)(""),[D,O]=(0,a.useState)(""),{currentProject:F,careProjectName:M}=(0,_.useProject)(),{canExecute:E}=(0,p.useActionPermissions)("queue"),J=F?.permission_level??"admin",U=!F||"write"===J||"admin"===J,V=E&&U,Q=function(){let[e,s]=(0,a.useState)([]),t=(0,a.useCallback)((e,a="info")=>{let t=++j;s(s=>[...s,{id:t,message:e,type:a}])},[]),l=(0,a.useCallback)(e=>{s(s=>s.filter(s=>s.id!==e))},[]),n=(0,a.useCallback)(e=>t(e,"success"),[t]),r=(0,a.useCallback)(e=>t(e,"error"),[t]),i=(0,a.useCallback)(e=>t(e,"warning"),[t]),c=(0,a.useCallback)(e=>t(e,"info"),[t]);return{toasts:e,showToast:t,removeToast:l,success:n,error:r,warning:i,info:c}}(),H=(0,a.useRef)(Q);H.current=Q;let L=(0,a.useCallback)(async()=>{c(!0);try{let e="/queue/params_and_active_consumers";F?.id&&(e+=`?project_id=${F.id}`);let s=await (0,x.apiFetch)(e),a=Object.entries(s).map(([e,s])=>({queue_name:e,...s}));r(a)}catch(e){H.current.error(e instanceof Error?e.message:"加载队列失败。")}finally{c(!1)}},[F?.id,M]),{enabled:G,toggle:K,intervalMs:X,setIntervalMs:Z}=(0,h.useAutoRefresh)(L,!1,3e4);(0,a.useEffect)(()=>{L()},[L]);let W=(0,a.useMemo)(()=>{let s=e.filter(e=>(e.active_consumers?.length??0)>0),a=e.reduce((e,s)=>e+(s.active_consumers?.length??0),0),t=e.reduce((e,s)=>e+(s.history_run_fail_count??0),0);return{active:s.length,idle:e.length-s.length,consumers:a,retryCount:t}},[e]),Y=(0,a.useMemo)(()=>e.filter(e=>(!d||(e.active_consumers?.length??0)!==0)&&(!u||!!e.queue_name.toLowerCase().includes(u.toLowerCase()))),[e,u,d]),ee=(0,a.useMemo)(()=>[...Y].sort((e,s)=>{let a=0,t=0;switch(w){case"queue_name":a=e.queue_name,t=s.queue_name;break;case"active_consumers":a=e.active_consumers?.length??0,t=s.active_consumers?.length??0;break;case"msg_num_in_broker":a=e.msg_num_in_broker??0,t=s.msg_num_in_broker??0;break;case"history_run_count":a=e.history_run_count??0,t=s.history_run_count??0;break;case"history_run_fail_count":a=e.history_run_fail_count??0,t=s.history_run_fail_count??0;break;case"all_consumers_last_x_s_execute_count":a=e.all_consumers_last_x_s_execute_count??0,t=s.all_consumers_last_x_s_execute_count??0;break;case"all_consumers_last_execute_task_time":a=e.all_consumers_last_execute_task_time??0,t=s.all_consumers_last_execute_task_time??0}return"string"==typeof a&&"string"==typeof t?"asc"===k?a.localeCompare(t):t.localeCompare(a):"asc"===k?a-t:t-a}),[Y,w,k]),es=ee.length,ea=(0,a.useMemo)(()=>{let e=g*N;return ee.slice(e,e+N)},[ee,g,N]),et=async()=>{try{let s=await Promise.all(e.map(async e=>{try{let s=`/funboost/get_msg_count?queue_name=${encodeURIComponent(e.queue_name)}`;F?.id&&(s+=`&project_id=${F.id}`);let a=await (0,x.funboostFetch)(s);return{...e,msg_num_in_broker:a.count}}catch{return e}}));r(s),Q.success("消息数量已刷新。")}catch(e){Q.error(e instanceof Error?e.message:"刷新失败。")}},el=async()=>{if(!V)return void Q.warning("当前项目无写权限。");Q.info("正在启动自动消费...");try{await L(),Q.success("自动消费已启动。")}catch(e){Q.error(e instanceof Error?e.message:"启动失败。")}},en=async(e,s)=>{try{if(("pause"===s||"resume"===s)&&!V||"clear"===s&&!V)return void Q.warning("当前项目无写权限。");if("clear"===s&&await (0,x.funboostFetch)("/funboost/clear_queue",{method:"POST",json:{queue_name:e.queue_name,project_id:F?.id}}),"pause"===s){let s=`/queue/pause/${encodeURIComponent(e.queue_name)}`;F?.id&&(s+=`?project_id=${F.id}`),await (0,x.apiFetch)(s,{method:"POST"})}if("resume"===s){let s=`/queue/resume/${encodeURIComponent(e.queue_name)}`;F?.id&&(s+=`?project_id=${F.id}`),await (0,x.apiFetch)(s,{method:"POST"})}await L(),Q.success("操作已完成。")}catch(e){Q.error(e instanceof Error?e.message:"操作失败。")}},er=(e,s="overview")=>{B(e),$(s)};return(0,s.jsx)(t.RequirePermission,{permissions:["queue:read"],projectLevel:"read",children:(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid gap-4 grid-cols-2 lg:grid-cols-4",children:[(0,s.jsx)(l.StatCard,{label:"远程队列",value:e.length,helper:"总数",tone:"info"}),(0,s.jsx)(l.StatCard,{label:"消费队列",value:W.active,helper:"活跃",tone:"success"}),(0,s.jsx)(l.StatCard,{label:"消费者监控",value:W.consumers,helper:"在线",tone:"warning"}),(0,s.jsx)(l.StatCard,{label:"重试次数",value:W.retryCount,helper:"累计",tone:"danger"})]}),(0,s.jsx)(S,{search:u,activeOnly:d,onSearchChange:o,onActiveOnlyChange:v,loading:i,autoRefresh:G,refreshInterval:X/1e3,canOperateQueue:V,onRefresh:L,onRefreshAllMsgCounts:et,onStartAutoConsume:el,onToggleAutoRefresh:K,onIntervalChange:e=>Z(1e3*e)}),(0,s.jsx)(A,{queues:ea,loading:i,currentPage:g,pageSize:N,totalCount:es,sortField:w,sortDirection:k,canOperateQueue:V,canClearQueue:V,onPageChange:f,onPageSizeChange:e=>{b(e),f(0)},onSort:e=>{w===e?C("asc"===k?"desc":"asc"):(y(e),C("desc"))},onViewConfig:e=>{P(`队列配置: ${e.queue_name}`),O(JSON.stringify(e.queue_params??{},null,2)),R(!0)},onViewChart:e=>er(e,"speed"),onViewConsumers:e=>er(e,"consumers"),onOpenInsight:e=>er(e,"overview"),onQueueAction:en}),(0,s.jsx)(n.JsonViewerModal,{open:I,title:z,content:D,onClose:()=>R(!1)}),(0,s.jsx)(ei,{open:null!==q,queue:q,activeTab:T,onTabChange:$,onClose:()=>B(null)}),(0,s.jsx)(m,{toasts:Q.toasts,onRemove:Q.removeToast})]})})}e.s(["default",()=>ec],38645)}]);