<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜Ÿåˆ—æ“ä½œ</title>
    <!-- Bootstrap CSS -->
    <link href="{{ url_for('static',filename='css_cdn/twitter-bootstrap/3.3.7/css/bootstrap.min.css') }}" rel="stylesheet">
    <!-- Tabulator CSS -->
    <link href="{{ url_for('static',filename='css_cdn/tabulator-tables@5.5.0/tabulator.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static',filename='css_cdn/tabulator-tables@5.5.0/tabulator_bootstrap3.min.css') }}" rel="stylesheet">
    <!-- Select2 CSS -->
    <link href="{{ url_for('static',filename='css_cdn/select2/4.0.13/css/select2.min.css') }}" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="{{ url_for('static',filename='css_cdn/font-awesome/4.7.0/css/font-awesome.min.css') }}" rel="stylesheet">

    <!-- jQuery -->
    <script src="{{ url_for('static',filename='js/jquery-1.11.0.min.js') }}" type="text/javascript"></script>
    <!-- Bootstrap JS -->
    <script src="{{ url_for('static',filename='js_cdn/bootstrap/3.3.7/js/bootstrap.min.js') }}"></script>
    <!-- Tabulator JS -->
    <script type="text/javascript" src="{{ url_for('static',filename='js_cdn/tabulator-tables@5.5.0/dist/js/tabulator.min.js') }}"></script>
    <!-- Select2 JS -->
    <script src="{{ url_for('static',filename='/js/select2.min.js') }}"></script>
    <script src="{{ url_for('static',filename='js_cdn/chart.js') }}"></script>

    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }

        /* é¡µé¢ä¸»å®¹å™¨ */
        .main-container {
            padding: 20px 25px;
            max-width: 100%;
        }

        /* é¡µé¢æ ‡é¢˜åŒºåŸŸ */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding: 20px 25px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 16px;
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
        }

        .header-icon i {
            font-size: 28px;
            color: white;
        }

        .header-title h1 {
            margin: 0 0 5px 0;
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(90deg, #ffffff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title p {
            margin: 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-cards {
            display: flex;
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.8) 0%, rgba(40, 40, 80, 0.6) 100%);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 15px 25px;
            text-align: center;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .stat-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
        }

        .stat-card.inactive {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-card.inactive .stat-value {
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 3px;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: linear-gradient(135deg, rgba(30, 30, 60, 0.6) 0%, rgba(40, 40, 80, 0.4) 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-group label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            white-space: nowrap;
        }

        /* Select2 è‡ªå®šä¹‰æ ·å¼ */
        .select2-container--default .select2-selection--single {
            background: rgba(30, 30, 60, 0.8) !important;
            border: 1px solid rgba(139, 92, 246, 0.3) !important;
            border-radius: 10px !important;
            height: 42px !important;
            padding: 5px 10px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #e0e0e0 !important;
            line-height: 30px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px !important;
        }

        .select2-dropdown {
            background: #1e1e3f !important;
            border: 1px solid rgba(139, 92, 246, 0.3) !important;
            border-radius: 10px !important;
        }

        .select2-container--default .select2-search--dropdown .select2-search__field {
            background: rgba(30, 30, 60, 0.8) !important;
            border: 1px solid rgba(139, 92, 246, 0.3) !important;
            color: #e0e0e0 !important;
            border-radius: 8px !important;
            padding: 8px 12px !important;
        }

        .select2-results__option {
            padding: 12px 16px !important;
            font-size: 14px !important;
            color: #e0e0e0 !important;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%) !important;
        }

        .select2-container--default .select2-results>.select2-results__options {
            max-height: 400px !important;
        }

        /* å¼€å…³æ ·å¼ */
        .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(30, 30, 60, 0.5);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .toggle-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
            user-select: none;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-modern {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary-modern {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-primary-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        .btn-success-modern {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-success-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        .btn-danger-modern {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .btn-danger-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }

        .btn-info-modern {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }

        .btn-info-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.5);
        }

        .btn-outline-modern {
            background: transparent;
            border: 1px solid rgba(139, 92, 246, 0.5);
            color: #a5b4fc;
        }

        .btn-outline-modern:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.8);
        }

        /* è¡¨æ ¼å®¹å™¨ */
        .table-container {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.8) 0%, rgba(30, 30, 60, 0.6) 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 5px;
            overflow: hidden;
        }

        /* Tabulator è¡¨æ ¼æ ·å¼ */
        .tabulator {
            background: transparent !important;
            border: none !important;
            font-size: 13px;
        }

        .tabulator .tabulator-header {
            background: linear-gradient(90deg, #2d1b69 0%, #3d2a7a 100%) !important;
            border-bottom: 2px solid rgba(167, 139, 250, 0.5) !important;
        }

        .tabulator .tabulator-header .tabulator-col {
            background: transparent !important;
            border-right: 1px solid rgba(167, 139, 250, 0.25) !important;
            min-height: 55px !important;
            padding: 8px 5px !important;
        }

        .tabulator .tabulator-header .tabulator-col .tabulator-col-content .tabulator-col-title {
            color: #ffffff !important;
            font-weight: 700;
            font-size: 12px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            white-space: normal !important;
            line-height: 1.5 !important;
            word-break: break-word !important;
        }

        .tabulator-row {
            background: rgba(15, 15, 35, 0.9) !important;
            border-bottom: 1px solid rgba(139, 92, 246, 0.15) !important;
        }

        .tabulator-row:nth-child(even) {
            background: rgba(25, 25, 50, 0.9) !important;
        }

        .tabulator-row:hover {
            background: rgba(99, 102, 241, 0.35) !important;
        }
        
        .tabulator-row:hover .tabulator-cell {
            color: #ffffff !important;
            text-shadow: 0 0 1px rgba(255, 255, 255, 0.5);
        }

        .tabulator-row .tabulator-cell {
            border-right: 1px solid rgba(139, 92, 246, 0.15) !important;
            color: #ffffff !important;
            padding: 12px 15px !important;
            font-weight: 500;
        }

        .tabulator .tabulator-footer {
            background: linear-gradient(90deg, #1e1e3f 0%, #2a2a4a 100%) !important;
            border-top: 1px solid rgba(139, 92, 246, 0.2) !important;
        }

        .tabulator .tabulator-footer .tabulator-page {
            background: rgba(99, 102, 241, 0.2) !important;
            border: 1px solid rgba(139, 92, 246, 0.3) !important;
            color: #e0e0e0 !important;
            border-radius: 6px !important;
            margin: 0 3px !important;
        }

        .tabulator .tabulator-footer .tabulator-page.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
            color: white !important;
        }

        /* é˜Ÿåˆ—åç§°å•å…ƒæ ¼æ ·å¼ */
        .queue-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .queue-name {
            font-weight: 600;
            font-size: 13px;
        }

        .queue-active {
            color: #4ade80;
            text-shadow: 0 0 8px rgba(74, 222, 128, 0.3);
        }

        .queue-inactive {
            color: #fcd34d;
            text-shadow: 0 0 8px rgba(252, 211, 77, 0.3);
        }

        .queue-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-active {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .badge-inactive {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: #1a1a2e;
        }

        /* è¡¨æ ¼å†…æŒ‰é’® */
        .table-btn {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2px;
        }

        .table-btn-chart {
            background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            color: white;
        }

        .table-btn-chart:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
        }

        .table-btn-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%);
            color: white;
        }

        .table-btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
        }

        .table-btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: #1a1a2e;
        }

        .table-btn-success {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
        }

        .table-btn-deprecate {
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            color: white;
        }

        .table-btn:hover {
            transform: scale(1.05);
        }

        /* æ¶ˆæ¯æ•°é‡æ˜¾ç¤º */
        .msg-count-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .msg-count-value {
            font-weight: 700;
            font-size: 15px;
            min-width: 80px;
            text-align: right;
        }

        .msg-diff-up {
            color: #f87171;
            font-size: 12px;
            font-weight: 600;
        }

        .msg-diff-down {
            color: #4ade80;
            font-size: 12px;
            font-weight: 600;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-content {
            background: linear-gradient(135deg, #1e1e3f 0%, #2a2a4a 100%) !important;
            border: 1px solid rgba(139, 92, 246, 0.3) !important;
            border-radius: 16px !important;
            color: #e0e0e0;
        }

        .modal-header {
            border-bottom: 1px solid rgba(139, 92, 246, 0.2) !important;
            padding: 20px 25px !important;
        }

        .modal-title {
            color: #ffffff !important;
            font-weight: 600;
        }

        .modal-body {
            padding: 25px !important;
        }

        .modal-footer {
            border-top: 1px solid rgba(139, 92, 246, 0.2) !important;
            padding: 15px 25px !important;
        }

        .close {
            color: #a5b4fc !important;
            opacity: 1 !important;
            font-size: 28px;
        }

        .close:hover {
            color: #ffffff !important;
        }

        /* å›¾è¡¨æ¨¡æ€æ¡† */
        .modal-xl-custom {
            width: 90%;
            max-width: 1600px;
        }

        .chart-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(30, 30, 60, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .chart-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-control-group label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
            white-space: nowrap;
        }

        .chart-control-group input,
        .chart-control-group select {
            background: rgba(30, 30, 60, 0.8) !important;
            border: 1px solid rgba(139, 92, 246, 0.3) !important;
            color: #e0e0e0 !important;
            border-radius: 8px !important;
            padding: 8px 12px !important;
        }

        .chart-canvas-container {
            background: rgba(20, 20, 40, 0.5);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        /* æ¶ˆè´¹è€…è¯¦æƒ…è¡¨æ ¼ */
        .consumer-detail-table {
            width: 100%;
            border-collapse: collapse;
        }

        .consumer-detail-table th {
            background: linear-gradient(90deg, #1e1e3f 0%, #2a2a4a 100%);
            color: #ffffff;
            padding: 12px 10px;
            font-size: 12px;
            font-weight: 600;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        .consumer-detail-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            font-size: 13px;
        }

        .consumer-detail-table tr:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        /* JSON æ˜¾ç¤º */
        .json-display {
            background: #0d0d1a;
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            color: #a5b4fc;
            max-height: 60vh;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* æš‚åœçŠ¶æ€ */
        .pause-badge {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* è‡ªåŠ¨åˆ·æ–°æŒ‡ç¤ºå™¨ */
        .refresh-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            font-size: 13px;
            color: #34d399;
        }

        .refresh-indicator.active .refresh-dot {
            animation: blink 1s infinite;
        }

        .refresh-dot {
            width: 8px;
            height: 8px;
            background: #34d399;
            border-radius: 50%;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .page-header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }
            
            .stats-cards {
                width: 100%;
                justify-content: flex-start;
            }
            
            .control-panel {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <div class="header-left">
                <div class="header-icon">
                    <i class="fa fa-sliders"></i>
                </div>
                <div class="header-title">
                    <h1>é˜Ÿåˆ—æ“ä½œä¸­å¿ƒ</h1>
                    <p>å®æ—¶ç›‘æ§å’Œç®¡ç†æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—çš„çŠ¶æ€ä¸é…ç½®</p>
                </div>
            </div>
            <div class="stats-cards">
                <div class="stat-card active">
                    <div class="stat-value" id="active_queue_count">0</div>
                    <div class="stat-label">æ´»è·ƒé˜Ÿåˆ—</div>
                </div>
                <div class="stat-card inactive">
                    <div class="stat-value" id="inactive_queue_count">0</div>
                    <div class="stat-label">é—²ç½®é˜Ÿåˆ—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total_consumer_count">0</div>
                    <div class="stat-label">æ¶ˆè´¹è€…æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total_msg_count">-</div>
                    <div class="stat-label">æ¶ˆæ¯æ€»æ•°</div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="search-group">
                <label><i class="fa fa-search"></i> é˜Ÿåˆ—æœç´¢</label>
                <select id="queueSearchSelect" class="form-control" style="width: 500px;">
                    <option value="">è¯·é€‰æ‹©é˜Ÿåˆ—åå­—...</option>
                </select>
            </div>

            <div class="toggle-switch-container">
                <label class="switch">
                    <input type="checkbox" id="showActiveQueuesOnly" onchange="toggleActiveQueuesFilter()">
                    <span class="slider round"></span>
                </label>
                <span class="toggle-label" onclick="document.getElementById('showActiveQueuesOnly').click();">
                    <i class="fa fa-filter"></i> ä»…æ˜¾ç¤ºæ´»è·ƒé˜Ÿåˆ—
                </span>
            </div>

            <button id="refresh-all-msg-counts" class="btn-modern btn-primary-modern">
                <i class="fa fa-refresh"></i> åˆ·æ–°æ‰€æœ‰æ¶ˆæ¯æ•°é‡
            </button>

            <button id="toggle-auto-refresh" class="btn-modern btn-success-modern">
                <i class="fa fa-play"></i> å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
            </button>

            <button id="show-explanation-btn" class="btn-modern btn-outline-modern">
                <i class="fa fa-info-circle"></i> è¯´æ˜
            </button>

            <div class="refresh-indicator" id="refresh-indicator" style="display: none;">
                <div class="refresh-dot"></div>
                <span>æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°</span>
            </div>
        </div>

        <!-- è¡¨æ ¼å®¹å™¨ -->
        <div class="table-container">
            <div id="queue-table"></div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="modal fade" id="chartModal" tabindex="-1" role="dialog" aria-labelledby="chartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-xl-custom" role="document">
            <div class="modal-content">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h4 class="modal-title" style="margin: 0;">
                        <i class="fa fa-line-chart" style="color: #ec4899; margin-right: 10px;"></i>
                        é˜Ÿåˆ—æ•°æ®æ›²çº¿å›¾: <span id="chartQueueName" style="color: #a5b4fc;"></span>
                    </h4>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <button type="button" class="btn-modern btn-outline-modern" onclick="showChartDataExplanation()" style="padding: 6px 14px; font-size: 12px;">
                            <i class="fa fa-question-circle"></i> æ•°æ®è¯´æ˜
                        </button>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin: 0;"><span aria-hidden="true">&times;</span></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-controls">
                        <div class="chart-control-group">
                            <label><i class="fa fa-calendar"></i> èµ·å§‹æ—¶é—´</label>
                            <input type="datetime-local" id="chartStartTime">
                        </div>
                        <div class="chart-control-group">
                            <label><i class="fa fa-calendar"></i> ç»“æŸæ—¶é—´</label>
                            <input type="datetime-local" id="chartEndTime">
                        </div>
                        <div class="chart-control-group">
                            <label><i class="fa fa-cog"></i> é‡‡æ ·ç‚¹æ•°</label>
                            <select id="curveSamplesCount" class="form-control" title="æ¨èä½¿ç”¨360-720ä¸ªé‡‡æ ·ç‚¹ä»¥è·å¾—æœ€ä½³æ˜¾ç¤ºæ•ˆæœ">
                                <option value="60">60 (ç²—ç•¥)</option>
                                <option value="120">120 (ç®€å•)</option>
                                <option value="180">180 (æ¸…æ™°)</option>
                                <option value="360" selected>360 (æ¨è)</option>
                                <option value="720">720 (ç²¾ç»†)</option>
                                <option value="1440">1440 (è¶…ç²¾ç»†)</option>
                                <option value="8640">8640 (æç²¾ç»†)</option>
                            </select>
                        </div>
                        <button class="btn-modern btn-primary-modern" onclick="reloadQueueChartWithTimeRange()">
                            <i class="fa fa-search"></i> æŸ¥è¯¢
                        </button>
                    </div>
                    <div class="chart-canvas-container">
                        <canvas id="queueDataChart" style="height:550px;max-height:550px;"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-outline-modern" data-dismiss="modal">
                        <i class="fa fa-times"></i> å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Data Explanation Modal -->
    <div class="modal fade" id="chartDataExplanationModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">
                        <i class="fa fa-info-circle" style="color: #ec4899; margin-right: 10px;"></i>
                        æ›²çº¿å›¾æ•°æ®æ¥æºè¯´æ˜
                    </h4>
                </div>
                <div class="modal-body">
                    <div style="background: linear-gradient(145deg, rgba(236,72,153,0.1) 0%, rgba(168,85,247,0.05) 100%); border-left: 4px solid #ec4899; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h5 style="margin: 0 0 10px 0; color: #f9a8d4; font-size: 15px;"><i class="fa fa-heartbeat"></i> æ•°æ®æ¥æº</h5>
                        <p style="margin: 0; color: #e0e0e0; font-size: 14px; line-height: 1.8;">
                            æ­¤æ›²çº¿å›¾çš„æ•°æ®æ¥æºäº <strong style="color: #f472b6;">funboost æ¶ˆè´¹è€…å¿ƒè·³ä¸ŠæŠ¥åˆ° Redis</strong> çš„ç»Ÿè®¡æ•°æ®ã€‚<br>
                            æ¯ä¸ªæ¶ˆè´¹è€…æ¯éš” <strong style="color: #a78bfa;">10 ç§’</strong> ä¼šå‘ Redis ä¸ŠæŠ¥ä¸€æ¬¡è‡ªèº«çš„è¿è¡ŒçŠ¶æ€æ•°æ®ã€‚
                        </p>
                    </div>
                    
                    <div style="background: rgba(30, 30, 60, 0.5); border-radius: 8px; padding: 15px 20px; margin-bottom: 15px;">
                        <h5 style="margin: 0 0 12px 0; color: #a5b4fc; font-size: 14px;"><i class="fa fa-list-ul"></i> å¯æŸ¥çœ‹çš„æŒ‡æ ‡</h5>
                        <ul style="margin: 0; padding-left: 20px; color: #c4b5fd; line-height: 2;">
                            <li><span style="color: #f87171;">å†å²è¿è¡Œæ¬¡æ•°</span> / <span style="color: #60a5fa;">å†å²å¤±è´¥æ¬¡æ•°</span></li>
                            <li><span style="color: #4ade80;">è¿‘10ç§’å®Œæˆæ•°</span> / <span style="color: #fb923c;">è¿‘10ç§’å¤±è´¥æ•°</span></li>
                            <li><span style="color: #fde047;">è¿‘10ç§’å¹³å‡è€—æ—¶</span> / <span style="color: #f0abfc;">ç´¯è®¡å¹³å‡è€—æ—¶</span></li>
                            <li><span style="color: #67e8f9;">æ¶ˆæ¯æ•°é‡</span>ï¼ˆBroker ä¸­å¾…æ¶ˆè´¹çš„æ¶ˆæ¯æ•°ï¼‰</li>
                        </ul>
                    </div>
                    
                    <div style="background: linear-gradient(145deg, rgba(59,130,246,0.1) 0%, rgba(99,102,241,0.05) 100%); border-left: 4px solid #3b82f6; padding: 15px 20px; border-radius: 8px;">
                        <h5 style="margin: 0 0 10px 0; color: #93c5fd; font-size: 14px;"><i class="fa fa-lightbulb-o"></i> æç¤º</h5>
                        <p style="margin: 0; color: #e0e0e0; font-size: 13px; line-height: 1.7;">
                            â€¢ æ•°æ®ç²¾åº¦ä¸º <strong style="color: #60a5fa;">10 ç§’çº§</strong>ï¼Œä¸æ˜¯æ¯«ç§’çº§å®æ—¶<br>
                            â€¢ å¦‚æœé˜Ÿåˆ—æ²¡æœ‰å¯åŠ¨æ¶ˆè´¹è€…ï¼Œåˆ™ä¸ä¼šæœ‰å¿ƒè·³ä¸ŠæŠ¥æ•°æ®<br>
                            â€¢ å¯é€šè¿‡è°ƒæ•´"é‡‡æ ·ç‚¹æ•°"æ§åˆ¶å›¾è¡¨ç²¾ç»†ç¨‹åº¦
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-outline-modern" data-dismiss="modal">
                        <i class="fa fa-check"></i> çŸ¥é“äº†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div class="modal fade" id="explanationModal" tabindex="-1" role="dialog" aria-labelledby="explanationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">
                        <i class="fa fa-info-circle" style="color: #6366f1; margin-right: 10px;"></i>
                        åŠŸèƒ½è¯´æ˜
                    </h4>
                </div>
                <div class="modal-body">
                    <ul id="explanation-text" style="line-height: 2; padding-left: 20px;"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-outline-modern" data-dismiss="modal">
                        <i class="fa fa-check"></i> çŸ¥é“äº†
                    </button>
                </div>
            </div>
        </div>
    </div>

   
    <script>
        // å…¨å±€é”™è¯¯å¤„ç†å™¨
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯æ•è·:', e.error);
        });

        // æ£€æŸ¥Chart.jsæ˜¯å¦æ­£ç¡®åŠ è½½
        if (typeof Chart === 'undefined') {
            console.error('Chart.jsæœªæ­£ç¡®åŠ è½½ï¼');
        } else {
            console.log('Chart.jså·²æ­£ç¡®åŠ è½½ï¼Œç‰ˆæœ¬:', Chart.version);
        }

        // åˆå§‹åŒ–é˜Ÿåˆ—é€‰æ‹©å™¨
        function initializeQueueSelector(data) {
            if (!data || data.length === 0) return;
            
            let html = '<option value="">è¯·é€‰æ‹©é˜Ÿåˆ—åå­—...</option>';
            data.forEach(function(item) {
                const queueName = item.queue_name;
                const consumerCount = item.consumer_count || 0;
                const statusIcon = consumerCount > 0 ? 'ğŸŸ¢' : 'ğŸŸ¡';
                html += `<option value="${queueName}">${statusIcon} ${queueName} (${consumerCount}ä¸ªæ¶ˆè´¹è€…)</option>`;
            });
            
            if ($("#queueSearchSelect").hasClass("select2-hidden-accessible")) {
                $("#queueSearchSelect").select2('destroy');
            }
            
            $("#queueSearchSelect").html(html);
            
            $("#queueSearchSelect").select2({
                placeholder: "è¯·è¾“å…¥é˜Ÿåˆ—åç§°æœç´¢...",
                allowClear: true,
                width: '500px',
                minimumResultsForSearch: 0
            }).on('change', function() {
                const selectedQueue = $(this).val();
                if (selectedQueue) {
                    table.setFilter("queue_name", "=", selectedQueue);
                } else {
                    table.clearFilter();
                    updateTableFilters();
                }
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(data) {
            let activeCount = 0, inactiveCount = 0, totalConsumers = 0, totalMsg = 0;
            let hasMsgData = false;
            
            data.forEach(item => {
                if (item.consumer_count > 0) {
                    activeCount++;
                } else {
                    inactiveCount++;
                }
                totalConsumers += item.consumer_count || 0;
                if (item.msg_count !== null && item.msg_count !== undefined) {
                    totalMsg += item.msg_count;
                    hasMsgData = true;
                }
            });
            
            $('#active_queue_count').text(activeCount);
            $('#inactive_queue_count').text(inactiveCount);
            $('#total_consumer_count').text(totalConsumers);
            $('#total_msg_count').text(hasMsgData ? totalMsg.toLocaleString() : '-');
        }

        var table = new Tabulator("#queue-table", {
            ajaxURL: "/queue/params_and_active_consumers",
            ajaxResponse: function(url, params, response) {
                const tableData = Object.entries(response).map(([queue_name, data]) => ({
                    queue_name: queue_name,
                    broker_kind: data.queue_params.broker_kind,
                    consuming_function_name: data.queue_params.consuming_function_name,
                    history_run_count: data.history_run_count,
                    history_run_fail_count: data.history_run_fail_count,
                    all_consumers_last_x_s_execute_count: data.all_consumers_last_x_s_execute_count,
                    all_consumers_last_x_s_execute_count_fail: data.all_consumers_last_x_s_execute_count_fail,
                    all_consumers_last_execute_task_time: data.all_consumers_last_execute_task_time,
                    msg_count: data.msg_num_in_broker, 
                    consumer_count: data.active_consumers.length,
                    active_consumers: data.active_consumers,
                    queue_params: data.queue_params,
                    pause_flag: data.pause_flag,
                    all_consumers_last_x_s_avarage_function_spend_time: data.all_consumers_last_x_s_avarage_function_spend_time,
                    all_consumers_avarage_function_spend_time_from_start: data.all_consumers_avarage_function_spend_time_from_start
                }));

                initializeQueueSelector(tableData);
                updateStats(tableData);

                return tableData;
            },
            layout: "fitDataFill",
            responsiveLayout: false,
            pagination: true,
            paginationSize: 100,
            height: "auto",
            locale: true,
            dataLoaded: function(data) {
                setTimeout(function() {
                    updateTableFilters();
                }, 100);
            },
            tableBuilt: function() {
                this.initialized = true;
            },
            langs: {
                "zh-cn": {
                    "pagination": {
                        "first": "é¦–é¡µ",
                        "last": "æœ«é¡µ",
                        "prev": "ä¸Šä¸€é¡µ",
                        "next": "ä¸‹ä¸€é¡µ",
                    }
                }
            },
            columns: [
                {
                    title: "é˜Ÿåˆ—åç§°",
                    field: "queue_name",
                    sorter: "string",
                    headerSort: true,
                    hozAlign: "left",
                    width: 380,
                    frozen: true,
                    formatter: function(cell) {
                        const queueName = cell.getValue();
                        const rowData = cell.getRow().getData();
                        const isActive = rowData.consumer_count > 0;
                        const statusClass = isActive ? 'queue-active' : 'queue-inactive';
                        const badgeClass = isActive ? 'badge-active' : 'badge-inactive';
                        const badgeText = isActive ? 'æ´»è·ƒ' : 'é—²ç½®';
                        
                        return `<div class="queue-cell">
                                    <span class="queue-name ${statusClass}">${queueName}</span>
                                    <div style="display: flex; gap: 8px; align-items: center;">
                                        <span class="queue-badge ${badgeClass}">${badgeText}</span>
                                        <button class="table-btn table-btn-chart" onclick="showQueueChart('${queueName}')">
                                            <i class="fa fa-line-chart"></i> æ›²çº¿å›¾
                                        </button>
                                    </div>
                                </div>`;
                    }
                },
                {
                    title: "æ¶ˆè´¹è€…æ•°é‡",
                    field: "consumer_count",
                    sorter: "number",
                    width: 180,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const row = cell.getRow().getData();
                        const count = cell.getValue() || 0;
                        const color = count > 0 ? '#86efac' : '#fcd34d';
                        const shadow = count > 0 ? 'rgba(134, 239, 172, 0.4)' : 'rgba(252, 211, 77, 0.4)';
                        return `<div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    <span style="color: ${color}; font-weight: 700; font-size: 18px; text-shadow: 0 0 10px ${shadow};">${count}</span>
                                    <button class="table-btn table-btn-info" onclick='showConsumerDetails(${JSON.stringify(row.active_consumers)}, "${row.queue_name}")'>
                                        <i class="fa fa-eye"></i> è¯¦æƒ…
                                    </button>
                                </div>`;
                    }
                },
                {
                    title: "Brokerç±»å‹",
                    field: "broker_kind",
                    sorter: "string",
                    width: 130,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const value = cell.getValue();
                        const colors = {
                            'REDIS': '#f87171',
                            'RABBITMQ_AMQPSTORM': '#fbbf24',
                            'KAFKA': '#4ade80',
                            'MONGODB': '#60a5fa'
                        };
                        const color = colors[value] || '#a78bfa';
                        return `<span style="background: ${color}33; color: ${color}; padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 11px; text-shadow: 0 0 8px ${color}44;">${value}</span>`;
                    }
                },
                {
                    title: "æ¶ˆè´¹å‡½æ•°",
                    field: "consuming_function_name",
                    sorter: "string",
                    width: 140,
                    formatter: function(cell) {
                        return `<code style="background: rgba(167,139,250,0.25); color: #e0d4ff; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;">${cell.getValue()}</code>`;
                    }
                },
                {
                    title: "æœ€åæ‰§è¡Œæ—¶é—´",
                    field: "all_consumers_last_execute_task_time",
                    sorter: "number",
                    width: 160,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const val = cell.getValue();
                        if (val === null || val === undefined) return '<span style="color: #888;">-</span>';
                        const d = new Date(val * 1000);
                        const timeStr = d.toLocaleString('zh-CN', { hour12: false, month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                        // è®¡ç®—è·ä»Šå¤šä¹…
                        const now = Date.now() / 1000;
                        const diffSec = Math.floor(now - val);
                        let agoStr = '';
                        if (diffSec < 60) {
                            agoStr = `${diffSec}ç§’å‰`;
                        } else if (diffSec < 3600) {
                            agoStr = `${Math.floor(diffSec / 60)}åˆ†é’Ÿå‰`;
                        } else if (diffSec < 86400) {
                            agoStr = `${Math.floor(diffSec / 3600)}å°æ—¶å‰`;
                        } else {
                            agoStr = `${Math.floor(diffSec / 86400)}å¤©å‰`;
                        }
                        const color = diffSec < 60 ? '#4ade80' : (diffSec < 300 ? '#fbbf24' : '#f87171');
                        return `<div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
                                    <span style="color: ${color}; font-weight: 600; font-size: 11px;">${agoStr}</span>
                                    <span style="color: #888; font-size: 10px;">${timeStr}</span>
                                </div>`;
                    }
                },
                {
                    title: "æ¶ˆæ¯æ•°é‡",
                    field: "msg_count",
                    sorter: "number",
                    width: 200,
                    formatter: function(cell) {
                        const row = cell.getRow().getData();
                        const initialCount = cell.getValue() === null ? '' : cell.getValue();
                        const initialCountStr = initialCount === '' ? '0' : String(initialCount);
                        return `<div class="msg-count-cell">
                                    <span id="msg-count-${row.queue_name}" data-last-count="${initialCountStr}" class="msg-count-value" style="color: #93c5fd;">${initialCount}</span>
                                    <button class="table-btn table-btn-info" onclick="getMessageCount('${row.queue_name}')">
                                        <i class="fa fa-refresh"></i> è·å–
                                    </button>
                                </div>`;
                    }
                },
                {
                    title: "å†å²è¿è¡Œæ¬¡æ•°",
                    field: "history_run_count",
                    sorter: "number",
                    width: 120,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const val = cell.getValue() || 0;
                        return `<span style="color: #67e8f9; font-weight: 700; text-shadow: 0 0 8px rgba(103, 232, 249, 0.3);">${val.toLocaleString()}</span>`;
                    }
                },
                {
                    title: "å†å²å¤±è´¥æ¬¡æ•°",
                    field: "history_run_fail_count",
                    sorter: "number",
                    width: 120,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const val = cell.getValue() || 0;
                        const color = val > 0 ? '#fca5a5' : '#888';
                        return `<span style="color: ${color}; font-weight: 700;">${val.toLocaleString()}</span>`;
                    }
                },
                {
                    title: "è¿‘10ç§’å®Œæˆ",
                    field: "all_consumers_last_x_s_execute_count",
                    sorter: "number",
                    width: 100,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const val = cell.getValue() || 0;
                        const color = val > 0 ? '#86efac' : '#888';
                        return `<span style="color: ${color}; font-weight: 700;">${val}</span>`;
                    }
                },
                {
                    title: "è¿‘10ç§’å¤±è´¥",
                    field: "all_consumers_last_x_s_execute_count_fail",
                    sorter: "number",
                    width: 100,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const val = cell.getValue() || 0;
                        const color = val > 0 ? '#fca5a5' : '#888';
                        return `<span style="color: ${color}; font-weight: 700;">${val}</span>`;
                    }
                },
                {
                    title: "è¿‘10ç§’å¹³å‡è€—æ—¶",
                    field: "all_consumers_last_x_s_avarage_function_spend_time",
                    sorter: "number",
                    width: 120,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const val = cell.getValue();
                        if (val === null || val === undefined) return '<span style="color: #888;">-</span>';
                        return `<span style="color: #fde047; font-weight: 600;">${val.toFixed(3)}s</span>`;
                    }
                },
                {
                    title: "ç´¯è®¡å¹³å‡è€—æ—¶",
                    field: "all_consumers_avarage_function_spend_time_from_start",
                    sorter: "number",
                    width: 120,
                    hozAlign: "center",
                    formatter: function(cell) {
                        const val = cell.getValue();
                        if (val === null || val === undefined) return '<span style="color: #888;">-</span>';
                        return `<span style="color: #fdba74; font-weight: 600;">${val.toFixed(3)}s</span>`;
                    }
                },
                {
                    title: "çŠ¶æ€",
                    field: "pause_flag",
                    width: 80,
                    hozAlign: "center",
                    formatter: function(cell) {
                        return cell.getValue() === 1 ? '<span class="pause-badge">å·²æš‚åœ</span>' : '';
                    }
                },
                {
                    title: "æ“ä½œ",
                    width: 450,
                    formatter: function(cell) {
                        const row = cell.getRow().getData();
                        const btnId = 'showParamsBtn_' + Math.random().toString(36).substr(2, 9);
                        setTimeout(() => {
                            document.getElementById(btnId)?.addEventListener('click', () => showParams(row.queue_params));
                        }, 0);
                        return `<div class="action-btn-group">
                                    <button id="${btnId}" class="table-btn table-btn-info"><i class="fa fa-cog"></i> é…ç½®</button>
                                    <button class="table-btn table-btn-danger" onclick="clearQueue('${row.queue_name}')"><i class="fa fa-trash"></i> æ¸…ç©º</button>
                                    <button class="table-btn table-btn-warning" onclick="pauseConsume('${row.queue_name}')"><i class="fa fa-pause"></i> æš‚åœ</button>
                                    <button class="table-btn table-btn-success" onclick="resumeConsume('${row.queue_name}')"><i class="fa fa-play"></i> æ¢å¤</button>
                                    <button class="table-btn table-btn-deprecate" onclick="deprecateQueue('${row.queue_name}')"><i class="fa fa-ban"></i> ä½œåºŸ</button>
                                </div>`;
                    }
                },
            ],
        });

        function updateTableFilters() {
            if (!table || !table.initialized) return;

            try {
                const selectedQueue = $("#queueSearchSelect").val();
                const showActiveOnly = document.getElementById('showActiveQueuesOnly').checked;
                const filters = [];

                if (selectedQueue && selectedQueue.trim() !== "") {
                    filters.push({field: "queue_name", type: "=", value: selectedQueue});
                }

                if (showActiveOnly) {
                    filters.push({field: "consumer_count", type: ">", value: 0});
                }

                table.clearFilter();
                if (filters.length > 0) {
                    table.setFilter(filters);
                }
            } catch (error) {
                console.error("æ›´æ–°è¡¨æ ¼è¿‡æ»¤å™¨æ—¶å‡ºé”™:", error);
            }
        }

        function showParams(params) {
            if ($("#paramsModal").length) {
                $("#paramsModal").remove();
            }

            const modalHtml = `
                <div class="modal" id="paramsModal" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                <h4 class="modal-title"><i class="fa fa-cog" style="color: #6366f1; margin-right: 10px;"></i>æ¶ˆè´¹è€…é…ç½®è¯¦æƒ…</h4>
                            </div>
                            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                                <pre class="json-display">${JSON.stringify(params, null, 2)}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn-modern btn-outline-modern" data-dismiss="modal"><i class="fa fa-times"></i> å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $("body").append(modalHtml);
            $("#paramsModal").modal({ backdrop: "static", keyboard: false });
        }

        function getMessageCount(queueName) {
            let countSpan = document.getElementById(`msg-count-${queueName}`);
            let previous_count_str = countSpan.getAttribute('data-last-count') || '0';
            let previous_count = parseInt(previous_count_str);
            if (isNaN(previous_count)) previous_count = 0;

            countSpan.innerHTML = '<span class="loading-spinner"></span>';

            $.get(`/funboost/get_msg_count?queue_name=${encodeURIComponent(queueName)}`, function(response) {
                if (response.succ) {
                    const new_count = parseInt(response.data.count);
                    if (isNaN(new_count)) {
                        countSpan.innerHTML = '<span style="color: #ef4444;">é”™è¯¯</span>';
                        countSpan.setAttribute('data-last-count', '0');
                        return;
                    } 

                    const difference = new_count - previous_count;
                    let diff_display_html = '';
                    if (countSpan.getAttribute('data-last-count') !== '0' || previous_count_str !== '') {
                        if (difference > 0) {
                            diff_display_html = ` <span class="msg-diff-up">â†‘ +${difference}</span>`;
                        } else if (difference < 0) {
                            diff_display_html = ` <span class="msg-diff-down">â†“ ${difference}</span>`;
                        }
                    }

                    countSpan.innerHTML = `${new_count.toLocaleString()}${diff_display_html}`;
                    countSpan.setAttribute('data-last-count', new_count.toString());
                } else {
                    countSpan.innerHTML = '<span style="color: #ef4444;">é”™è¯¯</span>';
                    countSpan.setAttribute('data-last-count', '0');
                }
            }).fail(function() {
                countSpan.innerHTML = '<span style="color: #ef4444;">é”™è¯¯</span>';
                countSpan.setAttribute('data-last-count', '0');
            });
        }

        function clearQueue(queueName) {
            if (confirm(`ç¡®å®šè¦æ¸…ç©ºé˜Ÿåˆ— "${queueName}" çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                $.ajax({
                    url: '/funboost/clear_queue',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ queue_name: queueName }),
                    success: function(response) {
                        if (response.succ) {
                            alert(`âœ… æ¸…ç©º "${queueName}" é˜Ÿåˆ—æˆåŠŸ`);
                            getMessageCount(queueName);
                        } else {
                            alert(`âŒ æ¸…ç©ºé˜Ÿåˆ—å¤±è´¥ï¼š${response.msg}`);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert(`âŒ æ¸…ç©ºé˜Ÿåˆ—å¤±è´¥ï¼š${error}`);
                    }
                });
            }
        }

        function pauseConsume(queueName) {
            $.post(`/queue/pause/${queueName}`, function(response) {
                if (response.success) {
                    alert("âœ… æš‚åœæ¶ˆè´¹æˆåŠŸ");
                    const row = table.getRows().find(row => row.getData().queue_name === queueName);
                    if (row) row.update({pause_flag: 1});
                }
            });
        }

        function resumeConsume(queueName) {
            $.post(`/queue/resume/${queueName}`, function(response) {
                if (response.success) {
                    alert("âœ… æ¢å¤æ¶ˆè´¹æˆåŠŸ");
                    const row = table.getRows().find(row => row.getData().queue_name === queueName);
                    if (row) row.update({pause_flag: 0});
                }
            });
        }

        function deprecateQueue(queueName) {
            if (!confirm(`ç¡®å®šè¦ä½œåºŸé˜Ÿåˆ— "${queueName}" å—ï¼Ÿ\n\nä½œåºŸåï¼Œè¯¥é˜Ÿåˆ—å°†ä»Rediså…ƒæ•°æ®ä¸­ç§»é™¤ã€‚\nå¦‚éœ€å†æ¬¡ä½¿ç”¨ï¼Œéœ€è¦é‡æ–°å¯åŠ¨æ¶ˆè´¹è€…ã€‚`)) {
                return;
            }
            
            $.ajax({
                url: '/funboost/deprecate_queue',
                type: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ queue_name: queueName }),
                success: function(response) {
                    if (response.succ) {
                        alert(`âœ… é˜Ÿåˆ— "${queueName}" å·²æˆåŠŸä½œåºŸï¼`);
                        table.replaceData();
                    } else {
                        alert(`âŒ ä½œåºŸé˜Ÿåˆ—å¤±è´¥ï¼š${response.msg}`);
                    }
                },
                error: function(xhr, status, error) {
                    alert(`âŒ ä½œåºŸé˜Ÿåˆ—å¤±è´¥ï¼š${error}`);
                }
            });
        }

        function showConsumerDetails(consumers, queueName) {
            $.ajax({
                url: '/running_consumer/hearbeat_info_by_queue_name',
                data: { queue_name: queueName },
                success: function(consumers) {
                    let consumerRows = '';
                    consumers.forEach(consumer => {
                        consumerRows += `
                            <tr>
                                <td style="color: #60a5fa;">${consumer.computer_ip}</td>
                                <td>${consumer.computer_name}</td>
                                <td style="color: #a5b4fc;">${consumer.process_id}</td>
                                <td style="color: #8b5cf6;">${consumer.hearbeat_datetime_str}</td>
                                <td>${consumer.start_datetime_str}</td>
                                <td style="color: #34d399; font-weight: 600;">${consumer.last_x_s_execute_count}</td>
                                <td style="color: ${consumer.last_x_s_execute_count_fail > 0 ? '#f87171' : '#666'}; font-weight: 600;">${consumer.last_x_s_execute_count_fail}</td>
                                <td style="color: #fbbf24;">${consumer.last_x_s_avarage_function_spend_time?.toFixed(3) || '-'}s</td>
                                <td style="color: #22d3ee;">${consumer.total_consume_count_from_start?.toLocaleString() || 0}</td>
                                <td style="color: ${consumer.total_consume_count_from_start_fail > 0 ? '#f87171' : '#666'};">${consumer.total_consume_count_from_start_fail?.toLocaleString() || 0}</td>
                                <td style="color: #fb923c;">${consumer.avarage_function_spend_time_from_start?.toFixed(3) || '-'}s</td>
                                <td style="font-size: 11px; color: #888;" title="${consumer.code_filename}">${consumer.code_filename.split(/[\\/]/).pop()}</td>
                                <td style="font-size: 10px; color: #666;">${consumer.consumer_uuid}</td>
                            </tr>
                        `;
                    });
                
                    const modalHtml = `
                        <div class="modal" id="consumerDetailsModal" tabindex="-1" role="dialog">
                            <div class="modal-dialog" style="width: 95%;" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                        <h4 class="modal-title">
                                            <i class="fa fa-users" style="color: #10b981; margin-right: 10px;"></i>
                                            é˜Ÿåˆ— <span style="color: #a5b4fc;">${queueName}</span> çš„æ¶ˆè´¹è€…è¯¦æƒ…
                                        </h4>
                                    </div>
                                    <div class="modal-body" style="overflow-x: auto;">
                                        <table class="consumer-detail-table">
                                            <thead>
                                                <tr>
                                                    <th>IPåœ°å€</th>
                                                    <th>ä¸»æœºå</th>
                                                    <th>è¿›ç¨‹ID</th>
                                                    <th>æœ€åå¿ƒè·³</th>
                                                    <th>å¯åŠ¨æ—¶é—´</th>
                                                    <th>è¿‘10ç§’å®Œæˆ</th>
                                                    <th>è¿‘10ç§’å¤±è´¥</th>
                                                    <th>è¿‘10ç§’è€—æ—¶</th>
                                                    <th>ç´¯è®¡å®Œæˆ</th>
                                                    <th>ç´¯è®¡å¤±è´¥</th>
                                                    <th>ç´¯è®¡è€—æ—¶</th>
                                                    <th>ä»£ç æ–‡ä»¶</th>
                                                    <th>æ¶ˆè´¹è€…UUID</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${consumerRows}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn-modern btn-outline-modern" data-dismiss="modal"><i class="fa fa-times"></i> å…³é—­</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                
                    $('#consumerDetailsModal').remove();
                    $('body').append(modalHtml);
                    $('#consumerDetailsModal').modal('show');
                },
                error: function() {
                    alert('è·å–æ¶ˆè´¹è€…è¯¦æƒ…å¤±è´¥');
                }
            });
        }

        document.getElementById("refresh-all-msg-counts").onclick = function() {
            table.getRows().forEach(row => {
                const queueName = row.getData().queue_name;
                getMessageCount(queueName);
            });
        };

        // è‡ªåŠ¨åˆ·æ–°é€»è¾‘
        let isAutoRefreshing = false;
        let autoRefreshIntervalId = null;
        const AUTO_REFRESH_INTERVAL = 10000;
        let chartInstance = null;

        const CHARTABLE_FIELDS_MAP = {
            "history_run_count": "å†å²è¿è¡Œæ¬¡æ•°",
            "history_run_fail_count": "å†å²è¿è¡Œå¤±è´¥æ¬¡æ•°",
            "all_consumers_last_x_s_execute_count": "è¿‘10ç§’å®Œæˆ",
            "all_consumers_last_x_s_execute_count_fail": "è¿‘10ç§’å¤±è´¥",
            "all_consumers_last_x_s_avarage_function_spend_time": "è¿‘10ç§’å‡½æ•°è¿è¡Œå¹³å‡è€—æ—¶",
            "all_consumers_avarage_function_spend_time_from_start": "ç´¯è®¡å‡½æ•°è¿è¡Œå¹³å‡è€—æ—¶",
            "msg_num_in_broker": "æ¶ˆæ¯æ•°é‡"
        };

        const PREDEFINED_COLORS = [
            '#E60012', '#005AC8', '#00A600', '#FF9900', '#8B28B7', '#9A6324', '#5E8C78', '#F58231', '#42D4F4', '#BF6131', '#3CB44B', '#4363D8', '#F032E6', '#BCF60C', '#FABEBE', '#AAFFC3', '#E6BEFF', '#FFFAC8'
        ];

        function refreshTableData() {
            table.replaceData()
                .then(() => console.log("Auto-refresh: æ•°æ®åˆ·æ–°æˆåŠŸ"))
                .catch(error => console.error("Auto-refresh: åˆ·æ–°å¤±è´¥:", error));
        }

        function toggleAutoRefresh() {
            const button = document.getElementById("toggle-auto-refresh");
            const indicator = document.getElementById("refresh-indicator");
            
            if (isAutoRefreshing) {
                clearInterval(autoRefreshIntervalId);
                isAutoRefreshing = false;
                button.innerHTML = '<i class="fa fa-play"></i> å¯åŠ¨è‡ªåŠ¨åˆ·æ–°';
                button.classList.remove("btn-danger-modern");
                button.classList.add("btn-success-modern");
                indicator.style.display = 'none';
                indicator.classList.remove('active');
            } else {
                isAutoRefreshing = true;
                button.innerHTML = '<i class="fa fa-pause"></i> æš‚åœè‡ªåŠ¨åˆ·æ–°';
                button.classList.remove("btn-success-modern");
                button.classList.add("btn-danger-modern");
                indicator.style.display = 'flex';
                indicator.classList.add('active');
                refreshTableData();
                autoRefreshIntervalId = setInterval(refreshTableData, AUTO_REFRESH_INTERVAL);
            }
        }

        document.getElementById("toggle-auto-refresh").addEventListener("click", toggleAutoRefresh);

        let currentChartQueueName = null;
        let endTimeUserChanged = false;
        
        document.getElementById("chartEndTime").addEventListener("input", function() {
            endTimeUserChanged = true;
        });

        function toDatetimeLocalString(date) {
            const pad = n => n < 10 ? '0' + n : n;
            return date.getFullYear() + '-' +
                pad(date.getMonth() + 1) + '-' +
                pad(date.getDate()) + 'T' +
                pad(date.getHours()) + ':' +
                pad(date.getMinutes());
        }

        function showQueueChart(queueName) {
            currentChartQueueName = queueName;
            document.getElementById("chartQueueName").textContent = queueName;
            
            const now = new Date();
            const start = new Date(now.getTime() - 60 * 60 * 1000);
            document.getElementById("chartStartTime").value = toDatetimeLocalString(start);
            document.getElementById("chartEndTime").value = toDatetimeLocalString(now);
            endTimeUserChanged = false;
            
            loadQueueChartData(queueName, Math.floor(start.getTime() / 1000), Math.floor(now.getTime() / 1000), 360);
        }

        function reloadQueueChartWithTimeRange() {
            const start = document.getElementById("chartStartTime").value;
            const end = document.getElementById("chartEndTime").value;
            const curveSamplesCount = document.getElementById("curveSamplesCount").value;
            let start_ts = start ? (new Date(start).getTime() / 1000) : null;
            let end_ts = end ? (new Date(end).getTime() / 1000) : null;
            loadQueueChartData(currentChartQueueName, start_ts, end_ts, curveSamplesCount);
        }

        function loadQueueChartData(queueName, start_ts, end_ts, curveSamplesCount) {
            if (chartInstance) chartInstance.destroy();
            
            const chartCanvas = document.getElementById('queueDataChart');
            const ctx = chartCanvas.getContext('2d');
            ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            ctx.font = "16px 'Segoe UI'";
            ctx.fillStyle = "#a5b4fc";
            ctx.textAlign = "center";
            ctx.fillText("â³ æ­£åœ¨åŠ è½½æ•°æ®...", chartCanvas.width / 2, chartCanvas.height / 2);
            
            let url = `/queue/get_time_series_data/${queueName}`;
            let params = [];
            if (start_ts) params.push(`start_ts=${start_ts}`);
            if (end_ts) params.push(`end_ts=${end_ts}`);
            if (curveSamplesCount) params.push(`curve_samples_count=${curveSamplesCount}`);
            if (params.length > 0) url += '?' + params.join('&');
            
            $.get(url, function(response) {
                if (!response || response.length === 0) {
                    ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                    ctx.fillText("ğŸ“­ æš‚æ— å†å²æ•°æ®", chartCanvas.width / 2, chartCanvas.height / 2);
                    $('#chartModal').modal('show');
                    return;
                }
                
                const dataPointCount = response.length;
                const labels = response.map(dp => {
                    const d = new Date(dp.report_ts * 1000);
                    return d.toLocaleString('zh-CN', { hour12: false });
                });
                
                const datasets = Object.keys(CHARTABLE_FIELDS_MAP).map((fieldKey, index) => {
                    const displayName = CHARTABLE_FIELDS_MAP[fieldKey];
                    const isDefaultVisible = fieldKey === 'all_consumers_last_x_s_execute_count' || fieldKey === 'all_consumers_last_x_s_execute_count_fail';
                    
                    let pointRadius, tension, borderWidth;
                    if (dataPointCount > 800) {
                        pointRadius = 0;
                        tension = 0.65;
                        borderWidth = 1.5;
                    } else if (dataPointCount > 300) {
                        pointRadius = 0.3;
                        tension = 0.6;
                        borderWidth = 1.8;
                    } else {
                        pointRadius = 1;
                        tension = 0.5;
                        borderWidth = 2;
                    }
                    
                    return {
                        label: displayName,
                        data: response.map(dp => {
                            let v = dp.report_data[fieldKey];
                            if (typeof v === 'string') v = parseFloat(v);
                            return v === undefined || v === null ? NaN : v;
                        }),
                        fill: false,
                        borderColor: PREDEFINED_COLORS[index % PREDEFINED_COLORS.length],
                        backgroundColor: PREDEFINED_COLORS[index % PREDEFINED_COLORS.length] + '33',
                        tension: tension,
                        pointRadius: pointRadius,
                        pointHoverRadius: Math.max(3, pointRadius + 2),
                        borderWidth: borderWidth,
                        hidden: !isDefaultVisible,
                        cubicInterpolationMode: 'monotone',
                        spanGaps: true
                    };
                });
                
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: dataPointCount > 800 ? 0 : 1000,
                            easing: 'easeInOutQuart'
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'æ—¶é—´', color: '#a5b4fc' },
                                ticks: {
                                    autoSkip: true,
                                    maxTicksLimit: Math.min(20, Math.max(10, Math.floor(dataPointCount / 50))),
                                    color: '#888'
                                },
                                grid: { color: 'rgba(139, 92, 246, 0.1)' }
                            },
                            y: { 
                                beginAtZero: false, 
                                title: { display: true, text: 'æ•°å€¼', color: '#a5b4fc' },
                                ticks: { maxTicksLimit: 10, color: '#888' },
                                grid: { color: 'rgba(139, 92, 246, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { 
                                position: 'top',
                                labels: { color: '#e0e0e0' }
                            },
                            title: { 
                                display: true, 
                                text: `é˜Ÿåˆ— [${queueName}] å„é¡¹æŒ‡æ ‡å˜åŒ–è¶‹åŠ¿ (${dataPointCount}ä¸ªæ•°æ®ç‚¹)`,
                                color: '#ffffff'
                            },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false }
                    }
                });
                
                $('#chartModal').modal('show');
            }).fail(function(xhr, status, error) {
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                ctx.fillText("âŒ è·å–æ•°æ®å¤±è´¥: " + error, chartCanvas.width / 2, chartCanvas.height / 2);
                $('#chartModal').modal('show');
            });
        }

        $('#chartModal').on('hidden.bs.modal', function () {
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        });

        function showExplanationModal() {
            const explanationTextHtml = `
                <li style="margin-bottom: 12px;"><i class="fa fa-clock-o" style="color: #6366f1; margin-right: 8px;"></i>æ¶ˆæ¯é˜Ÿåˆ—çš„å„é¡¹æŒ‡æ ‡æ•°æ®æ˜¯ funboost æ¶ˆè´¹è€…æ¯éš”10ç§’å‘¨æœŸä¸ŠæŠ¥åˆ° redis çš„ï¼Œæ‰€ä»¥ä¸æ˜¯æ¯«ç§’çº§å®æ—¶ï¼Œè€Œæ˜¯10ç§’çº§å®æ—¶ã€‚</li>
                <li style="margin-bottom: 12px;"><i class="fa fa-refresh" style="color: #10b981; margin-right: 8px;"></i>"åˆ·æ–°æ‰€æœ‰æ¶ˆæ¯æ•°é‡"æŒ‰é’®å’Œè¡¨æ ¼"æ¶ˆæ¯æ•°é‡"åˆ—çš„è·å–æŒ‰é’®ï¼Œæ˜¯å®æ—¶æŸ¥è¯¢ broker çš„æ¶ˆæ¯æ•°é‡ï¼Œä¸æ˜¯åŸºäºæ¶ˆè´¹è€…ä¸ŠæŠ¥åˆ° redis çš„æ•°æ®ã€‚</li>
                <li><i class="fa fa-info-circle" style="color: #f59e0b; margin-right: 8px;"></i>å› ä¸ºæœ‰çš„é˜Ÿåˆ—å¯èƒ½æ²¡æœ‰å¯åŠ¨ç›¸åº”çš„æ¶ˆè´¹è€…ï¼Œä¹Ÿå°±æ²¡æœ‰ä¸ŠæŠ¥æ–¹ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬è·å–æ¶ˆæ¯æ•°é‡ã€‚</li>
            `;
            document.getElementById('explanation-text').innerHTML = explanationTextHtml;
            $('#explanationModal').modal('show');
        }

        document.getElementById('show-explanation-btn').addEventListener('click', showExplanationModal);

        function toggleActiveQueuesFilter() {
            try {
                updateTableFilters();
            } catch (error) {
                console.error("åˆ‡æ¢æ´»è·ƒé˜Ÿåˆ—è¿‡æ»¤å™¨æ—¶å‡ºé”™:", error);
            }
        }

        // æ˜¾ç¤ºæ›²çº¿å›¾æ•°æ®æ¥æºè¯´æ˜
        function showChartDataExplanation() {
            $('#chartDataExplanationModal').modal('show');
        }
    </script>
</body>
</html>
