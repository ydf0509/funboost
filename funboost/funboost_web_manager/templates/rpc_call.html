<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pytho万能分布式函数调度框架</title>
    <link href="{{ url_for('static',filename='css_cdn/twitter-bootstrap/3.3.7/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static',filename='css_cdn/font-awesome/4.7.0/css/font-awesome.min.css') }}" rel="stylesheet">
    <link rel="stylesheet"
        href="{{ url_for('static',filename='css_cdn/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='assets/css/jquery.mCustomScrollbar.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static',filename='assets/css/custom.css') }}">

    <!-- 在其他 link 标签后添加 -->
    <link href="{{ url_for('static',filename='css_cdn/select2/4.0.13/css/select2.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static',filename='css/content_page_style.css') }}" rel="stylesheet">


    <script src="{{ url_for('static',filename='js/jquery-1.11.0.min.js') }}" type="text/javascript"></script>
    <!-- <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.11.0/jquery.min.js"></script> -->
    <!-- 在其他 script 标签后添加 -->
    <!-- <script src="https://cdn.bootcdn.net/ajax/libs/select2/4.0.13/js/select2.min.js"></script> -->
    <script src="{{ url_for('static',filename='/js/select2.min.js') }}"></script>
    <script src="{{ url_for('static',filename='js_cdn/bootstrap/3.3.7/js/bootstrap.min.js') }}"></script>


    <script src="{{ url_for('static',filename='js/moment-with-locales.min.js') }}"></script>
    <script src="{{ url_for('static',filename='js/bootstrap-datetimepicker.min.js') }}"></script>
    <!-- <script src="https://cdn.bootcss.com/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script> -->
    <!-- <script type="text/javascript" src="https://cdn.bootcss.com/echarts/3.3.0/echarts.js"></script> -->
    <script type="text/javascript" src="{{ url_for('static',filename='js/echarts.min.js') }}"></script>

    <script src="{{ url_for('static',filename='assets/js/jquery.mCustomScrollbar.concat.min.js') }}"></script>
    <script src="{{ url_for('static',filename='assets/js/custom.js') }}"></script>

        
    <!-- 添加 Tabulator 样式和脚本 -->
    <link href="{{ url_for('static',filename='css_cdn/tabulator-tables@5.5.0/tabulator.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static',filename='css_cdn/tabulator-tables@5.5.0/tabulator_bootstrap3.min.css') }}" rel="stylesheet">
    <script type="text/javascript" src="{{ url_for('static',filename='js_cdn/tabulator-tables@5.5.0/dist/js/tabulator.min.js') }}"></script>

    <style>

    </style>
</head>

<body>

    <div class="container-fluid" style="margin-top: 5px;">
        <!-- 添加发布消息和RPC结果区域 -->
        <div class="row" style="margin-top: 20px;">
            <div class="col-md-6">
                <div style="background-color: #f9f9f9; border-radius: 8px; padding: 20px; border-left: 5px solid #3498db; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h1 style="margin-bottom: 20px;color: red;">发送rpc请求:</h1>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                         
                            <label for="col_name_search" style="margin-right: 5px; white-space: nowrap;">队列名字:</label>
                            <select class="form-control" id="col_name_search" style="width: 500px;">
                                <option value="">请选择队列名字...</option>
                            </select>
                        </div>
                        <textarea class="form-control" id="message_content" rows="7" placeholder="请先选择队列名称，将自动生成消息体 JSON 模板"></textarea>
                        <div id="rpc_func_params_info" style="margin-top: 8px; padding: 10px; background-color: #f0f7ff; border-radius: 4px; border-left: 3px solid #337ab7;">
                            <i class="fa fa-info-circle" style="color: #337ab7;"></i>
                            <span id="rpc_func_params_text">请先选择队列名称，将显示函数所需参数</span>
                        </div>
                    </div>
                    <div class="form-inline" style="margin-bottom: 15px;">
                        <div class="checkbox" style="margin-right: 20px;">
                            <label>
                                <input type="checkbox" id="need_result" checked> 需要返回结果
                            </label>
                        </div>
                        <div class="form-group" style="margin-right: 20px;">
                            <label for="timeout" style="margin-right: 5px;">超时时间(秒)：</label>
                            <input type="number" class="form-control" id="timeout" value="60" style="width: 80px;">
                        </div>
                        <button type="button" class="btn btn-primary" id="send_btn">发送RPC请求</button>
                    </div>
                    <div class="alert alert-info" id="status_display" style="margin-top: 10px;">
                        准备发送RPC请求，请选择队列名称并输入消息内容
                    </div>
                </div>

                <hr style="border-top: 2px dashed #3498db; margin: 40px 0;">

                <div style="background-color: #f9f9f9; border-radius: 8px; padding: 20px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h1 style="margin-bottom: 20px;color: red;">获取task_id结果:</h1>
                    <div class="form-group">
                        <div style="display: flex; align-items: center;">
                            <label for="task_id" style="margin-right: 5px; white-space: nowrap;">task_id:</label>
                            <input type="text" class="form-control" id="task_id" style="width: 500px; margin-right: 15px;">
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="margin-right: 20px; display: flex; align-items: center;">
                            <label for="task_timeout" style="margin-right: 5px; white-space: nowrap;">超时时间(秒):</label>
                            <input type="number" class="form-control" id="task_timeout" value="30" style="width: 80px;">
                        </div>
                        <button type="button" class="btn btn-primary" id="get_result_btn">获取结果</button>
                    </div>
                    <div class="alert alert-info" id="task_status_display" style="margin-top: 10px;">
                        准备获取结果，请输入task_id
                    </div>
                </div>
                    

            </div>


            <div class="col-md-6">
                <!-- 关键结果汇总区域（方便一眼看到结果/耗时/是否成功等） -->
                <div id="rpc_summary_area" style="background-color: #f9f9f9; border-radius: 8px; padding: 15px; border-left: 5px solid #2ecc71; box-shadow: 0 2px 5px rgba(0,0,0,0.08); margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="font-size: 15px;">关键结果</strong>
                        <span id="rpc_summary_success_badge" class="label label-default">-</span>
                    </div>

                    <div style="display: flex; flex-wrap: wrap;">
                        <div class="rpc-key-box">
                            <div class="rpc-key-title">task_id</div>
                            <div class="rpc-key-value" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <code id="rpc_summary_task_id">-</code>
                                <button type="button" class="btn btn-default btn-xs" id="copy_task_id_btn" title="复制 task_id">
                                    <i class="fa fa-copy"></i> 复制
                                </button>
                                <span id="copy_task_id_feedback" style="color: #5cb85c; display: none;"><i class="fa fa-check"></i> 已复制</span>
                            </div>
                        </div>
                        <div class="rpc-key-box">
                            <div class="rpc-key-title">queue</div>
                            <div class="rpc-key-value" id="rpc_summary_queue">-</div>
                        </div>
                        <div class="rpc-key-box">
                            <div class="rpc-key-title">function</div>
                            <div class="rpc-key-value" id="rpc_summary_function">-</div>
                        </div>
                        <div class="rpc-key-box">
                            <div class="rpc-key-title">run_status</div>
                            <div class="rpc-key-value" id="rpc_summary_run_status">-</div>
                        </div>
                        <div class="rpc-key-box">
                            <div class="rpc-key-title">耗时(秒)</div>
                            <div class="rpc-key-value" id="rpc_summary_time_cost">-</div>
                        </div>
                        <div class="rpc-key-box">
                            <div class="rpc-key-title">host_process</div>
                            <div class="rpc-key-value" id="rpc_summary_host_process">-</div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 10px; margin-bottom: 10px;">
                        <label style="margin-bottom: 6px;">函数结果 result：</label>
                        <textarea class="form-control" id="rpc_summary_result" rows="6" readonly style="background-color: #1e1e1e; color: #ffffff; font-family: Consolas, Monaco, 'Courier New', monospace; border: 1px solid #333;"></textarea>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="margin-bottom: 6px;">异常 exception：</label>
                        <textarea class="form-control" id="rpc_summary_exception" rows="4" readonly style="background-color: #1e1e1e; color: #ffffff; font-family: Consolas, Monaco, 'Courier New', monospace; border: 1px solid #333;"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label for="rpc_result">RPC status_and_result：
                        <button type="button" class="btn btn-default btn-xs" id="copy_rpc_result_btn" style="margin-left: 10px;" title="复制JSON">
                            <i class="fa fa-copy"></i> 复制
                        </button>
                        <span id="copy_rpc_result_feedback" style="margin-left: 8px; color: #5cb85c; display: none;"><i class="fa fa-check"></i> 已复制</span>
                    </label>
                    <textarea class="form-control" id="rpc_result" rows="24" readonly style="background-color: #1e1e1e; color: #ffffff; font-family: Consolas, Monaco, 'Courier New', monospace; border: 1px solid #333;"></textarea>
                </div>
            </div>
        </div>


        <div id="result-table" style="margin-top: 20px;"></div>
    </div>

    






    <script>

        // 在现有的变量声明后添加
        var allQueues = [];  // 存储所有队列数据
        var currentColName;
        var rpc_last_auto_filled_template = "";  // 上一次自动生成并填充的 JSON 模板
        var rpc_is_auto_filled = false;  // 当前 message_content 是否仍然是“自动生成内容”（用户未修改）
        var rpc_last_selected_queue = "";  // 上一次选择的队列（用于判断是否需要覆盖）
        var rpc_template_cache_by_queue = {};  // queue_name -> templateText（用于比较/覆盖）
        var rpc_latest_request_queue = "";  // 用于丢弃过期回包，避免快速切换队列导致覆盖错乱

        function resetRpcFuncParamsUI() {
            $("#rpc_func_params_text").html("请先选择队列名称，将显示函数所需参数");
            $("#message_content").attr("placeholder", "请先选择队列名称，将自动生成消息体 JSON 模板");
        }

        function normalizeJsonText(text) {
            var s = (text || "").trim();
            if (!s) {
                return "";
            }
            try {
                var obj = JSON.parse(s);
                // 模板应该是 object（kwargs），不是数组
                if (obj && typeof obj === "object" && !Array.isArray(obj)) {
                    return JSON.stringify(obj, null, 2);
                }
            } catch (e) {
                // ignore
            }
            return s;
        }

        function rpcStringifyAny(v) {
            if (v === undefined || v === null) {
                return "";
            }
            if (typeof v === "string") {
                return v;
            }
            try {
                return JSON.stringify(v, null, 2);
            } catch (e) {
                try {
                    return String(v);
                } catch (e2) {
                    return "";
                }
            }
        }

        function rpcCopyToClipboard(text, $feedback) {
            if (!text || text === "-") {
                return;
            }
            var show = function () {
                if ($feedback && $feedback.length) {
                    $feedback.fadeIn(200).delay(1500).fadeOut(400);
                }
            };
            var fallback = function () {
                var $temp = $("<textarea>");
                $("body").append($temp);
                $temp.val(text).select();
                try {
                    document.execCommand("copy");
                    show();
                } catch (e) {
                    alert("复制失败，请手动复制");
                }
                $temp.remove();
            };
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(show).catch(fallback);
            } else {
                fallback();
            }
        }

        function rpcResetSummaryUI() {
            $("#rpc_summary_success_badge").removeClass("label-success label-danger label-warning label-info").addClass("label-default").text("-");
            $("#rpc_summary_task_id").text("-");
            $("#rpc_summary_queue").text("-");
            $("#rpc_summary_function").text("-");
            $("#rpc_summary_run_status").text("-");
            $("#rpc_summary_time_cost").text("-");
            $("#rpc_summary_host_process").text("-");
            $("#rpc_summary_result").val("");
            $("#rpc_summary_exception").val("");
        }

        function rpcExtractTaskId(resp) {
            if (resp && resp.data && resp.data.task_id) {
                return resp.data.task_id;
            }
            if (resp && resp.task_id) {
                return resp.task_id;
            }
            return "";
        }

        function rpcExtractStatusAndResult(resp) {
            if (resp && resp.data && resp.data.hasOwnProperty("status_and_result")) {
                return resp.data.status_and_result;
            }
            if (resp && resp.hasOwnProperty("status_and_result")) {
                return resp.status_and_result;
            }
            return null;
        }

        function rpcIsSuccessValue(v) {
            if (v === true) return true;
            if (v === false) return false;
            if (v === 1) return true;
            if (v === 0) return false;
            if (typeof v === "string") {
                var s = v.toLowerCase();
                if (s === "true") return true;
                if (s === "false") return false;
            }
            return null;
        }

        function rpcUpdateSummaryFromResponse(resp) {
            var taskId = rpcExtractTaskId(resp);
            if (taskId) {
                $("#rpc_summary_task_id").text(taskId);
            } else {
                $("#rpc_summary_task_id").text("-");
            }

            var statusAndResult = rpcExtractStatusAndResult(resp);

            // 没有结果（例如 need_result=false 或结果未返回）
            if (!statusAndResult) {
                var publishSucc = !!(resp && resp.succ);
                if (publishSucc) {
                    $("#rpc_summary_success_badge").removeClass("label-default label-danger label-warning").addClass("label-info").text("已发布(无结果)");
                } else {
                    $("#rpc_summary_success_badge").removeClass("label-default label-success label-info").addClass("label-danger").text("失败");
                }
                $("#rpc_summary_result").val("");
                $("#rpc_summary_exception").val(resp && resp.msg ? String(resp.msg) : "");
                return;
            }

            // 基本字段
            $("#rpc_summary_queue").text(statusAndResult.queue_name || "-");
            $("#rpc_summary_function").text(statusAndResult.function || "-");
            $("#rpc_summary_run_status").text(statusAndResult.run_status || "-");
            $("#rpc_summary_host_process").text(statusAndResult.host_process || "-");

            // 耗时
            if (statusAndResult.time_cost !== undefined && statusAndResult.time_cost !== null && statusAndResult.time_cost !== "") {
                var tc = statusAndResult.time_cost;
                if (typeof tc === "number") {
                    $("#rpc_summary_time_cost").text(tc.toFixed(6));
                } else {
                    $("#rpc_summary_time_cost").text(String(tc));
                }
            } else {
                $("#rpc_summary_time_cost").text("-");
            }

            // 成功/失败
            var sVal = rpcIsSuccessValue(statusAndResult.success);
            if (sVal === true) {
                $("#rpc_summary_success_badge").removeClass("label-default label-danger label-warning label-info").addClass("label-success").text("成功");
            } else if (sVal === false) {
                $("#rpc_summary_success_badge").removeClass("label-default label-success label-warning label-info").addClass("label-danger").text("失败");
            } else {
                $("#rpc_summary_success_badge").removeClass("label-success label-danger label-warning label-info").addClass("label-default").text("-");
            }

            // result / exception
            $("#rpc_summary_result").val(rpcStringifyAny(statusAndResult.result));

            var exText = "";
            if (statusAndResult.exception) {
                exText = String(statusAndResult.exception);
            } else {
                var exParts = [];
                if (statusAndResult.exception_type) exParts.push(String(statusAndResult.exception_type));
                if (statusAndResult.exception_msg) exParts.push(String(statusAndResult.exception_msg));
                if (statusAndResult.rpc_chain_error_msg_dict) exParts.push(rpcStringifyAny(statusAndResult.rpc_chain_error_msg_dict));
                exText = exParts.join(" | ");
            }
            $("#rpc_summary_exception").val(exText);
        }

        function buildRpcTemplateText(paramsInfo) {
            if (!paramsInfo) {
                return "{}";
            }
            var mustArgs = paramsInfo.must_arg_name_list || [];
            var optionalArgs = paramsInfo.optional_arg_name_list || [];
            var templateObj = {};

            for (var i = 0; i < mustArgs.length; i++) {
                templateObj[mustArgs[i]] = "";
            }
            for (var j = 0; j < optionalArgs.length; j++) {
                var k = optionalArgs[j];
                if (!(k in templateObj)) {
                    templateObj[k] = "";
                }
            }
            if (Object.keys(templateObj).length === 0) {
                return "{}";
            }
            return JSON.stringify(templateObj, null, 2);
        }

        function renderRpcFuncParamsInfo(paramsInfo) {
            if (!paramsInfo) {
                $("#rpc_func_params_text").html("无法获取函数入参信息");
                return;
            }
            var funcName = paramsInfo.func_name || "未知函数";
            var mustArgs = paramsInfo.must_arg_name_list || [];
            var optionalArgs = paramsInfo.optional_arg_name_list || [];

            var html = "<strong>函数: " + funcName + "</strong><br>";
            if (mustArgs.length > 0) {
                html += '<span style="color: #d9534f;">必填参数:</span> <code>' + mustArgs.join("</code>, <code>") + "</code>";
            } else {
                html += '<span style="color: #5cb85c;">无必填参数</span>';
            }
            if (optionalArgs.length > 0) {
                html += '<br><span style="color: #f0ad4e;">可选参数:</span> <code>' + optionalArgs.join("</code>, <code>") + "</code>";
            }
            $("#rpc_func_params_text").html(html);
        }

        function loadRpcTemplateAndParamsInfo(queueName, prevQueueName) {
            if (!queueName) {
                resetRpcFuncParamsUI();
                return;
            }

            rpc_latest_request_queue = queueName;
            $("#rpc_func_params_text").html('<i class="fa fa-spinner fa-spin"></i> 加载中...');
            $.get("/funboost/get_one_queue_config?queue_name=" + encodeURIComponent(queueName), function (response) {
                // 如果用户快速切换队列，丢弃旧回包
                if (queueName !== rpc_latest_request_queue || queueName !== rpc_last_selected_queue) {
                    return;
                }
                if (response && response.succ && response.data && response.data.auto_generate_info) {
                    var paramsInfo = response.data.auto_generate_info.final_func_input_params_info;
                    renderRpcFuncParamsInfo(paramsInfo);

                    var templateText = buildRpcTemplateText(paramsInfo);
                    rpc_template_cache_by_queue[queueName] = templateText;

                    var currentText = $("#message_content").val();
                    var currentNorm = normalizeJsonText(currentText);
                    var prevTemplate = prevQueueName ? rpc_template_cache_by_queue[prevQueueName] : null;
                    var prevTemplateNorm = prevTemplate ? normalizeJsonText(prevTemplate) : null;

                    // 覆盖判定（更可靠）
                    // - 输入框为空
                    // - 输入框内容等于“上一次队列的默认模板”（忽略空白/缩进）
                    // - 或者仍被标记为自动生成内容（用户未改）
                    var shouldOverwrite = false;
                    if (!currentNorm) {
                        shouldOverwrite = true;
                    } else if (prevTemplateNorm && currentNorm === prevTemplateNorm) {
                        shouldOverwrite = true;
                    } else if (rpc_is_auto_filled === true) {
                        shouldOverwrite = true;
                    }

                    if (shouldOverwrite) {
                        $("#message_content").val(templateText);
                        rpc_last_auto_filled_template = templateText;
                        rpc_is_auto_filled = true;
                    }

                    $("#message_content").attr("placeholder", "已根据队列自动生成消息体 JSON 模板（可自行修改）");
                } else {
                    $("#rpc_func_params_text").html("无法获取队列配置信息");
                }
            }).fail(function () {
                $("#rpc_func_params_text").html("获取队列配置失败");
            });
        }

        // 页面加载完成后立即获取所有队列
        $(document).ready(function () {
            // 监听用户修改消息内容，用于判断是否需要自动覆盖模板
            $("#message_content").on("input propertychange", function () {
                var currentVal = $(this).val();
                if (normalizeJsonText(currentVal) === normalizeJsonText(rpc_last_auto_filled_template)) {
                    rpc_is_auto_filled = true;
                } else {
                    rpc_is_auto_filled = false;
                }
            });
            resetRpcFuncParamsUI();

            $.ajax({
                url: "{{ url_for('get_msg_num_all_queues')}}",
                data: {},
                async: true,
                success: function (result) {
                    var html = '<option value="">请选择队列名字...</option>';
                    for (var queueName in result) {
                        var msgCount = result[queueName];
                        html += '<option value="' + queueName + '">' +
                            queueName + '&nbsp;&nbsp;&nbsp;&nbsp;(msg_count:' + msgCount + ')</option>';
                    }
                    $("#col_name_search").html(html);

                    // 初始化选择框的搜索功能
                    $("#col_name_search").select2({
                        placeholder: "请输入队列名称搜索...",
                        allowClear: true,
                        width: '500px',
                        minimumResultsForSearch: 0
                    });

                    // 监听选择变化
                    $("#col_name_search").on('change', function () {
                        var selectedQueue = $(this).val();
                        console.log("Selected queue:", selectedQueue);
                        currentColName = selectedQueue;
                        var prevQueue = rpc_last_selected_queue;
                        rpc_last_selected_queue = selectedQueue || "";
                        loadRpcTemplateAndParamsInfo(selectedQueue, prevQueue);
                        // if(selectedQueue) {
                        //     queryResult(selectedQueue, 0, true);
                        // }
                    });
                }
            });
        });

        // 添加发送RPC请求的功能
        $(document).ready(function() {
            // 已有的队列加载代码...
            
            // 发送RPC请求按钮点击事件
            $("#send_btn").click(function() {
                var queueName = $("#col_name_search").val();
                var messageContent = $("#message_content").val();
                
                if (!queueName) {
                    alert("请先选择队列名称");
                    return;
                }
                
                if (!messageContent) {
                    alert("请输入消息内容");
                    return;
                }
                
                try {
                    // 尝试解析JSON，确保内容有效
                    JSON.parse(messageContent);
                } catch (e) {
                    alert("消息内容必须是有效的JSON格式");
                    return;
                }
                
                // 更新状态显示
                $("#status_display").removeClass("alert-info alert-success alert-danger").addClass("alert-warning");
                $("#status_display").text("正在发送RPC请求，请稍候...");

                // 重置关键结果显示
                rpcResetSummaryUI();
                
                // 清空结果框
                $("#rpc_result").val("");
                $("#rpc_result").css({"background-color": "#1e1e1e", "color": "#ffffff"});
                
                // 发送RPC请求
                $.ajax({
                    // 使用 funboost faas 的接口（flask_blueprint）
                    url: "/funboost/publish",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        queue_name: queueName,
                        msg_body: JSON.parse(messageContent),
                        need_result: $("#need_result").is(":checked"),
                        timeout: parseInt($("#timeout").val())
                    }),
                    success: function(result) {
                       
                        console.log(result)

                        // 优先显示 status_and_result，便于阅读；没有则显示原始返回
                        var statusAndResult = (result && result.data && result.data.status_and_result) ? result.data.status_and_result : null;
                        var displayObj = statusAndResult ? statusAndResult : result;
                        $("#rpc_result").val(JSON.stringify(displayObj, null, 2));

                        // 更新关键结果
                        rpcUpdateSummaryFromResponse(result);

                        // 自动回填 task_id，方便继续查询
                        try {
                            if (result && result.data && result.data.task_id) {
                                $("#task_id").val(result.data.task_id);
                            }
                        } catch (e) {}

                        // 兼容 publish 成功但函数执行失败的情况
                        var bizSucc = !!(result && result.succ);
                        statusAndResult = (result && result.data && result.data.status_and_result) ? result.data.status_and_result : null;
                        if (statusAndResult && (statusAndResult.success === false || statusAndResult.success === 'false' || statusAndResult.success === 0)) {
                            bizSucc = false;
                        }
                        
                        // 更新状态显示
                        if (bizSucc) {
                            $("#status_display").removeClass("alert-warning alert-danger").addClass("alert-success");
                            $("#status_display").text("RPC请求成功: " + result.msg);
                            $("#rpc_result").css({"background-color": "#5cb85c", "color": "#ffffff"});
                        } else {
                            $("#status_display").removeClass("alert-warning alert-success").addClass("alert-danger");
                            var failMsg = (result && result.msg) ? result.msg : "未知错误";
                            if (statusAndResult && (statusAndResult.success === false || statusAndResult.success === 'false' || statusAndResult.success === 0)) {
                                failMsg = failMsg + "（函数执行失败）";
                            }
                            $("#status_display").text("RPC请求失败: " + failMsg);
                            $("#rpc_result").css({"background-color": "#d9534f", "color": "#ffffff"});
                        }
                    },
                    error: function(xhr, status, error) {
                        // 尝试解析后端返回的 JSON 错误
                        var errText = "";
                        try {
                            var errJson = xhr.responseJSON ? xhr.responseJSON : JSON.parse(xhr.responseText);
                            $("#rpc_result").val(JSON.stringify(errJson, null, 2));
                            if (errJson && errJson.msg) {
                                errText = errJson.msg;
                            }
                        } catch (e) {
                            $("#rpc_result").val("请求失败: " + (xhr.responseText || error));
                            errText = xhr.responseText || error;
                        }
                        $("#rpc_result").css({"background-color": "#d9534f", "color": "#ffffff"});

                        // 失败时也展示错误到关键结果区
                        rpcResetSummaryUI();
                        $("#rpc_summary_success_badge").removeClass("label-default label-success label-info").addClass("label-danger").text("失败");
                        $("#rpc_summary_exception").val(errText || error || "");
                        
                        // 更新状态显示
                        $("#status_display").removeClass("alert-warning alert-success").addClass("alert-danger");
                        $("#status_display").text("RPC请求发送失败: " + (errText || error));
                    }
                });
            });
        });

        // 复制 RPC status_and_result 到剪贴板
        $(document).ready(function() {
            $("#copy_rpc_result_btn").click(function() {
                rpcCopyToClipboard($("#rpc_result").val(), $("#copy_rpc_result_feedback"));
            });

            $("#copy_task_id_btn").click(function() {
                rpcCopyToClipboard($("#rpc_summary_task_id").text(), $("#copy_task_id_feedback"));
            });
        });

        // 添加获取结果功能
        $(document).ready(function() {
            // 获取结果按钮点击事件
            $("#get_result_btn").click(function() {
                var taskId = $("#task_id").val();
                
                if (!taskId) {
                    alert("请先输入task_id");
                    return;
                }
                
                // 更新状态显示
                $("#task_status_display").removeClass("alert-info alert-success alert-danger").addClass("alert-warning");
                $("#task_status_display").text("正在获取结果，请稍候...");

                // 重置关键结果显示
                rpcResetSummaryUI();
                
                // 清空结果框
                $("#rpc_result").val("");
                $("#rpc_result").css({"background-color": "#1e1e1e", "color": "#ffffff"});
                
                // 获取结果
                $.ajax({
                    // 使用 funboost faas 的接口（flask_blueprint）
                    url: "/funboost/get_result",
                    type: "GET",
                    data: {
                        task_id: taskId,
                        timeout: parseInt($("#task_timeout").val())
                    },
                    success: function(result) {
                        console.log(result);
                        var statusAndResult = (result && result.data && result.data.status_and_result) ? result.data.status_and_result : null;
                        var displayObj = statusAndResult ? statusAndResult : result;
                        $("#rpc_result").val(JSON.stringify(displayObj, null, 2));

                        // 更新关键结果
                        rpcUpdateSummaryFromResponse(result);

                        var bizSucc = !!(result && result.succ);
                        statusAndResult = (result && result.data && result.data.status_and_result) ? result.data.status_and_result : null;
                        if (statusAndResult && (statusAndResult.success === false || statusAndResult.success === 'false' || statusAndResult.success === 0)) {
                            bizSucc = false;
                        }
                        
                        // 更新状态显示
                        if (bizSucc) {
                            $("#task_status_display").removeClass("alert-warning alert-danger").addClass("alert-success");
                            $("#task_status_display").text("获取结果成功");
                            $("#rpc_result").css({"background-color": "#5cb85c", "color": "#ffffff"});
                        } else {
                            $("#task_status_display").removeClass("alert-warning alert-success").addClass("alert-danger");
                            var failMsg = (result && result.msg) ? result.msg : "未知错误";
                            if (statusAndResult && (statusAndResult.success === false || statusAndResult.success === 'false' || statusAndResult.success === 0)) {
                                failMsg = failMsg + "（函数执行失败）";
                            }
                            $("#task_status_display").text("获取结果失败: " + failMsg);
                            $("#rpc_result").css({"background-color": "#d9534f", "color": "#ffffff"});
                        }
                    },
                    error: function(xhr, status, error) {
                        var errText = "";
                        try {
                            var errJson = xhr.responseJSON ? xhr.responseJSON : JSON.parse(xhr.responseText);
                            $("#rpc_result").val(JSON.stringify(errJson, null, 2));
                            if (errJson && errJson.msg) {
                                errText = errJson.msg;
                            }
                        } catch (e) {
                            $("#rpc_result").val("请求失败: " + (xhr.responseText || error));
                            errText = xhr.responseText || error;
                        }
                        $("#rpc_result").css({"background-color": "#d9534f", "color": "#ffffff"});

                        rpcResetSummaryUI();
                        $("#rpc_summary_success_badge").removeClass("label-default label-success label-info").addClass("label-danger").text("失败");
                        $("#rpc_summary_exception").val(errText || error || "");
                        
                        // 更新状态显示
                        $("#task_status_display").removeClass("alert-warning alert-success").addClass("alert-danger");
                        $("#task_status_display").text("获取结果失败: " + (errText || error));
                    }
                });
            });
        });

            








    </script>

    <style>
        .rpc-key-box {
            display: inline-block;
            vertical-align: top;
            margin: 0 10px 10px 0;
            padding: 10px 12px;
            background-color: #ffffff;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            min-width: 180px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .rpc-key-title {
            color: #777;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .rpc-key-value {
            font-size: 13px;
            font-weight: bold;
            word-break: break-all;
        }
        #rpc_summary_success_badge {
            font-size: 16px;
            padding: 8px 14px;
            border-radius: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
    </style>
</body>

</html>