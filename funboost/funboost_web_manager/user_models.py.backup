# -*- coding: utf-8 -*-
# @Author  : kiro
# @Time    : 2026/1/13
"""
Web Manager ç”¨æˆ·æ•°æ®æ¨¡å‹æ¨¡å—

æœ¬æ¨¡å—æä¾› SQLAlchemy ORM æ¨¡å‹å’Œæ•°æ®åº“æ“ä½œå‡½æ•°ï¼Œç”¨äºç®¡ç† funboost_web_manager çš„ç”¨æˆ·æ•°æ®ã€‚
æ”¯æŒ SQLiteã€MySQLã€PostgreSQL ç­‰ SQLAlchemy å…¼å®¹çš„æ•°æ®åº“ã€‚
"""

from datetime import datetime
from enum import Enum
from threading import Lock
from typing import Optional, Dict, Any

from sqlalchemy import create_engine, Column, Integer, String, DateTime, Boolean, Table, ForeignKey, Text, UniqueConstraint
from sqlalchemy.orm import sessionmaker, declarative_base, relationship
from sqlalchemy.exc import IntegrityError

Base = declarative_base()


class ActionType(str, Enum):
    """æ ‡å‡†æ“ä½œç±»å‹æšä¸¾
    
    å®šä¹‰æƒé™ç³»ç»Ÿæ”¯æŒçš„æ ‡å‡†æ“ä½œç±»å‹ï¼Œç”¨äºç»†ç²’åº¦æƒé™æ§åˆ¶ã€‚
    ç»§æ‰¿è‡ª str å’Œ Enumï¼Œä½¿å¾—æšä¸¾å€¼å¯ä»¥ç›´æ¥ä½œä¸ºå­—ç¬¦ä¸²ä½¿ç”¨ã€‚
    
    Attributes:
        CREATE: åˆ›å»ºæ“ä½œ
        READ: è¯»å–/æŸ¥çœ‹æ“ä½œ
        UPDATE: æ›´æ–°/ç¼–è¾‘æ“ä½œ
        DELETE: åˆ é™¤æ“ä½œ
        EXECUTE: æ‰§è¡Œæ“ä½œï¼ˆå¦‚æ‰§è¡Œä»»åŠ¡ã€è¿è¡Œå‘½ä»¤ç­‰ï¼‰
        EXPORT: å¯¼å‡ºæ“ä½œ
    """
    CREATE = 'create'
    READ = 'read'
    UPDATE = 'update'
    DELETE = 'delete'
    EXECUTE = 'execute'
    EXPORT = 'export'


# æ“ä½œç±»å‹æ˜¾ç¤ºåç§°æ˜ å°„
ACTION_TYPE_DISPLAY = {
    'create': 'åˆ›å»º',
    'read': 'æŸ¥çœ‹',
    'update': 'ç¼–è¾‘',
    'delete': 'åˆ é™¤',
    'execute': 'æ‰§è¡Œ',
    'export': 'å¯¼å‡º',
}


# å…³è”è¡¨ï¼šç”¨æˆ·-è§’è‰²å¤šå¯¹å¤šå…³ç³»
user_roles = Table('user_roles', Base.metadata,
    Column('user_id', Integer, ForeignKey('web_manager_users.id'), primary_key=True),
    Column('role_id', Integer, ForeignKey('roles.id'), primary_key=True)
)

# å…³è”è¡¨ï¼šè§’è‰²-æƒé™å¤šå¯¹å¤šå…³ç³»
role_permissions = Table('role_permissions', Base.metadata,
    Column('role_id', Integer, ForeignKey('roles.id'), primary_key=True),
    Column('permission_id', Integer, ForeignKey('permissions.id'), primary_key=True)
)

# å…³è”è¡¨ï¼šè§’è‰²-é¡¹ç›®å¤šå¯¹å¤šå…³ç³»
role_projects = Table('role_projects', Base.metadata,
    Column('role_id', Integer, ForeignKey('roles.id'), primary_key=True),
    Column('project_id', Integer, ForeignKey('projects.id'), primary_key=True)
)


class WebManagerUser(Base):
    """Web Manager ç”¨æˆ·æ¨¡å‹
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        user_name: ç”¨æˆ·åï¼Œå”¯ä¸€ç´¢å¼•
        password: å¯†ç ï¼ˆæ”¯æŒ bcrypt å“ˆå¸Œå’Œæ˜æ–‡å…¼å®¹ï¼‰
        email: é‚®ç®±åœ°å€
        status: ç”¨æˆ·çŠ¶æ€ (active, disabled, locked)
        force_password_change: æ˜¯å¦å¼ºåˆ¶ä¿®æ”¹å¯†ç 
        failed_login_count: ç™»å½•å¤±è´¥æ¬¡æ•°
        locked_until: é”å®šåˆ°æœŸæ—¶é—´
        created_at: åˆ›å»ºæ—¶é—´
        updated_at: æ›´æ–°æ—¶é—´
        roles: ç”¨æˆ·è§’è‰²ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
    """
    __tablename__ = 'web_manager_users'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_name = Column(String(64), unique=True, nullable=False, index=True)
    password = Column(String(128), nullable=False)
    email = Column(String(128), nullable=True)
    status = Column(String(20), default='active')  # active, disabled, locked
    force_password_change = Column(Boolean, default=False)
    failed_login_count = Column(Integer, default=0)
    locked_until = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=datetime.now)
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now)
    
    # å¤šå¯¹å¤šå…³ç³»ï¼šç”¨æˆ·-è§’è‰²
    roles = relationship('Role', secondary=user_roles, back_populates='users')
    
    # ä¸€å¯¹å¤šå…³ç³»ï¼šç”¨æˆ· -> ç”¨æˆ·é¡¹ç›®å…³è”
    user_projects = relationship('UserProject', back_populates='user', cascade='all, delete-orphan')
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼ï¼Œä¿æŒä¸åŸæœ‰ users åˆ—è¡¨æ ¼å¼å…¼å®¹"""
        return {
            'id': self.id,  # è¿”å›æ•°æ®åº“ä¸»é”®ï¼Œç”¨äºé¡¹ç›®ç”¨æˆ·ç®¡ç†ç­‰åŠŸèƒ½
            'user_name': self.user_name,
            'password': self.password,
            'email': self.email,
            'status': self.status,
            'force_password_change': self.force_password_change,
            'failed_login_count': self.failed_login_count,
            'locked_until': self.locked_until.isoformat() if self.locked_until else None,
            'roles': [role.name for role in self.roles] if self.roles else []
        }
    
    def __repr__(self) -> str:
        return f"<WebManagerUser(user_name='{self.user_name}', status='{self.status}')>"


class Role(Base):
    """è§’è‰²æ¨¡å‹
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        name: è§’è‰²åç§°ï¼Œå”¯ä¸€
        description: è§’è‰²æè¿°
        is_builtin: æ˜¯å¦ä¸ºå†…ç½®è§’è‰²ï¼ˆå†…ç½®è§’è‰²ä¸å¯åˆ é™¤ï¼‰
        created_at: åˆ›å»ºæ—¶é—´
        permissions: è§’è‰²æƒé™ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
        users: æ‹¥æœ‰æ­¤è§’è‰²çš„ç”¨æˆ·ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
        projects: è§’è‰²å…³è”çš„é¡¹ç›®ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
    """
    __tablename__ = 'roles'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(64), unique=True, nullable=False)
    description = Column(String(256), nullable=True)
    is_builtin = Column(Boolean, default=False)  # å†…ç½®è§’è‰²ä¸å¯åˆ é™¤
    created_at = Column(DateTime, default=datetime.now)
    
    # å¤šå¯¹å¤šå…³ç³»
    permissions = relationship('Permission', secondary=role_permissions, back_populates='roles')
    users = relationship('WebManagerUser', secondary=user_roles, back_populates='roles')
    projects = relationship('Project', secondary=role_projects, back_populates='roles')
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
        return {
            'id': self.id,
            'name': self.name,
            'description': self.description,
            'is_builtin': self.is_builtin,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'permissions': [perm.code for perm in self.permissions] if self.permissions else [],
            'projects': [{'id': p.id, 'code': p.code, 'name': p.name} for p in self.projects] if self.projects else []
        }
    
    def __repr__(self) -> str:
        return f"<Role(name='{self.name}', builtin={self.is_builtin})>"


class PermissionCategory(Base):
    """æƒé™åˆ†ç±»æ¨¡å‹ï¼ˆå¢å¼ºç‰ˆï¼‰
    
    æ”¯æŒå¤šå±‚çº§ç»“æ„ï¼šé€šè¿‡ parent_code å®ç°å­åˆ†ç±»ã€‚
    ç”¨äºå°†æƒé™æŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç»„ï¼Œä»¥æ ‘å½¢ç»“æ„å±•ç¤ºã€‚
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        code: åˆ†ç±»ä»£ç ï¼Œå”¯ä¸€ (e.g., 'user', 'role', 'queue')
        name: åˆ†ç±»åç§° (e.g., 'ç”¨æˆ·ç®¡ç†', 'è§’è‰²ç®¡ç†')
        description: åˆ†ç±»æè¿°
        sort_order: æ’åºé¡ºåºï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºé¡ºåº
        icon: å›¾æ ‡ï¼ˆemoji æˆ–å›¾æ ‡ç±»åï¼‰
        parent_code: çˆ¶åˆ†ç±»ä»£ç ï¼Œnull è¡¨ç¤ºé¡¶çº§åˆ†ç±»
        created_at: åˆ›å»ºæ—¶é—´
        parent: çˆ¶åˆ†ç±»ï¼ˆè‡ªå¼•ç”¨å…³ç³»ï¼‰
        subcategories: å­åˆ†ç±»åˆ—è¡¨ï¼ˆè‡ªå¼•ç”¨å…³ç³»ï¼‰
        permissions: è¯¥åˆ†ç±»ä¸‹çš„æƒé™åˆ—è¡¨ï¼ˆä¸€å¯¹å¤šå…³ç³»ï¼‰
    """
    __tablename__ = 'permission_categories'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    code = Column(String(64), unique=True, nullable=False, index=True)
    name = Column(String(64), nullable=False)
    description = Column(String(256), nullable=True)
    sort_order = Column(Integer, default=0)
    icon = Column(String(16), nullable=True)
    parent_code = Column(String(64), ForeignKey('permission_categories.code'), nullable=True, index=True)
    created_at = Column(DateTime, default=datetime.now)
    
    # è‡ªå¼•ç”¨å…³ç³»ï¼šå­åˆ†ç±»
    parent = relationship('PermissionCategory', remote_side=[code], backref='subcategories', foreign_keys=[parent_code])
    # ä¸€å¯¹å¤šå…³ç³»ï¼šåˆ†ç±» -> æƒé™
    permissions = relationship('Permission', back_populates='category', order_by='Permission.sort_order')
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
        return {
            'id': self.id,
            'code': self.code,
            'name': self.name,
            'description': self.description,
            'sort_order': self.sort_order,
            'icon': self.icon,
            'parent_code': self.parent_code,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
    
    def to_tree_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºæ ‘å½¢ç»“æ„å­—å…¸æ ¼å¼ï¼ˆåŒ…å«å­åˆ†ç±»å’Œæƒé™åˆ—è¡¨ï¼‰"""
        return {
            'code': self.code,
            'name': self.name,
            'description': self.description,
            'sort_order': self.sort_order,
            'icon': self.icon,
            'parent_code': self.parent_code,
            'subcategories': [sub.to_tree_dict() for sub in self.subcategories] if self.subcategories else [],
            'permissions': [perm.to_dict() for perm in self.permissions] if self.permissions else []
        }
    
    def is_subcategory(self) -> bool:
        """åˆ¤æ–­æ˜¯å¦ä¸ºå­åˆ†ç±»ï¼ˆparent_code éç©ºï¼‰"""
        return self.parent_code is not None
    
    def __repr__(self) -> str:
        return f"<PermissionCategory(code='{self.code}', name='{self.name}', parent_code={self.parent_code!r})>"


class Permission(Base):
    """æƒé™æ¨¡å‹ï¼ˆå¢å¼ºç‰ˆï¼‰
    
    æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶ï¼ŒåŒ…æ‹¬æ“ä½œç±»å‹å’Œé¡¹ç›®ä½œç”¨åŸŸã€‚
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        code: æƒé™ä»£ç ï¼Œå”¯ä¸€ (e.g., 'user:read', 'user:write', 'projectA:queue:task:create')
        name: æƒé™åç§°
        description: æƒé™æè¿°
        category_code: æ‰€å±åˆ†ç±»ä»£ç ï¼ˆå¤–é”®ï¼‰
        sort_order: æ’åºé¡ºåºï¼Œç”¨äºæ§åˆ¶åœ¨åˆ†ç±»å†…çš„æ˜¾ç¤ºé¡ºåº
        action_type: æ“ä½œç±»å‹ (create, read, update, delete, execute, export)ï¼Œæ”¯æŒç´¢å¼•æŸ¥è¯¢
        project_scope: é¡¹ç›®ä½œç”¨åŸŸï¼Œnull è¡¨ç¤ºå…¨å±€æƒé™ï¼Œéç©ºè¡¨ç¤ºé¡¹ç›®ç‰¹å®šæƒé™
        roles: æ‹¥æœ‰æ­¤æƒé™çš„è§’è‰²ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
        category: æ‰€å±åˆ†ç±»ï¼ˆå¤šå¯¹ä¸€å…³ç³»ï¼‰
    """
    __tablename__ = 'permissions'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    code = Column(String(128), unique=True, nullable=False, index=True)  # æ‰©å±•é•¿åº¦ä»¥æ”¯æŒæ›´é•¿çš„æƒé™ä»£ç 
    name = Column(String(128), nullable=False)
    description = Column(String(256), nullable=True)
    category_code = Column(String(64), ForeignKey('permission_categories.code'), nullable=True, index=True)
    sort_order = Column(Integer, default=0)
    
    # æ–°å¢å­—æ®µï¼šæ“ä½œç±»å‹å’Œé¡¹ç›®ä½œç”¨åŸŸ
    action_type = Column(String(32), nullable=True, index=True)  # create, read, update, delete, execute, export
    project_scope = Column(String(64), nullable=True, index=True)  # é¡¹ç›®ä½œç”¨åŸŸï¼Œnull è¡¨ç¤ºå…¨å±€
    
    # å¤šå¯¹å¤šå…³ç³»
    roles = relationship('Role', secondary=role_permissions, back_populates='permissions')
    # å¤šå¯¹ä¸€å…³ç³»ï¼šæƒé™ -> åˆ†ç±»
    category = relationship('PermissionCategory', back_populates='permissions')
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼
        
        Returns:
            åŒ…å«æ‰€æœ‰æƒé™å­—æ®µçš„å­—å…¸ï¼ŒåŒ…æ‹¬æ–°å¢çš„ action_type å’Œ project_scope å­—æ®µ
        """
        return {
            'id': self.id,
            'code': self.code,
            'name': self.name,
            'description': self.description,
            'category_code': self.category_code,
            'sort_order': self.sort_order,
            'action_type': self.action_type,
            'action_type_display': ACTION_TYPE_DISPLAY.get(self.action_type, self.action_type) if self.action_type else None,
            'project_scope': self.project_scope
        }
    
    def is_global(self) -> bool:
        """åˆ¤æ–­æ˜¯å¦ä¸ºå…¨å±€æƒé™ï¼ˆproject_scope ä¸ºç©ºï¼‰
        
        Returns:
            True å¦‚æœæ˜¯å…¨å±€æƒé™ï¼ŒFalse å¦‚æœæ˜¯é¡¹ç›®ç‰¹å®šæƒé™
        """
        return self.project_scope is None
    
    def is_project_specific(self) -> bool:
        """åˆ¤æ–­æ˜¯å¦ä¸ºé¡¹ç›®ç‰¹å®šæƒé™ï¼ˆproject_scope éç©ºï¼‰
        
        Returns:
            True å¦‚æœæ˜¯é¡¹ç›®ç‰¹å®šæƒé™ï¼ŒFalse å¦‚æœæ˜¯å…¨å±€æƒé™
        """
        return self.project_scope is not None
    
    def __repr__(self) -> str:
        return f"<Permission(code='{self.code}', name='{self.name}', action_type={self.action_type!r}, project_scope={self.project_scope!r})>"


class PermissionTemplate(Base):
    """æƒé™æ¨¡æ¿æ¨¡å‹
    
    ç”¨äºå¿«é€Ÿé…ç½®è§’è‰²æƒé™ï¼Œæ”¯æŒé¢„å®šä¹‰æ¨¡æ¿å’Œè‡ªå®šä¹‰æ¨¡æ¿ã€‚
    æ”¯æŒæ¨¡æ¿ç»§æ‰¿ï¼Œå­æ¨¡æ¿å¯ä»¥ç»§æ‰¿çˆ¶æ¨¡æ¿çš„æ‰€æœ‰æƒé™ã€‚
    
    é¢„å®šä¹‰æ¨¡æ¿åŒ…æ‹¬ï¼š
    - åªè¯»ç”¨æˆ· (readonly): åªæœ‰æŸ¥çœ‹æƒé™
    - æ“ä½œå‘˜ (operator): æŸ¥çœ‹å’Œæ‰§è¡Œæƒé™
    - ç®¡ç†å‘˜ (admin): æ‰€æœ‰æƒé™
    - é¡¹ç›®ç®¡ç†å‘˜ (project_admin): é¡¹ç›®çº§åˆ«çš„æ‰€æœ‰æƒé™
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        code: æ¨¡æ¿ä»£ç ï¼Œå”¯ä¸€æ ‡è¯† (e.g., 'readonly', 'operator', 'admin')
        name: æ¨¡æ¿åç§° (e.g., 'åªè¯»ç”¨æˆ·', 'æ“ä½œå‘˜', 'ç®¡ç†å‘˜')
        description: æ¨¡æ¿æè¿°
        permissions: æƒé™ä»£ç åˆ—è¡¨ï¼ŒJSON æ•°ç»„æ ¼å¼å­˜å‚¨
        parent_template_code: çˆ¶æ¨¡æ¿ä»£ç ï¼Œç”¨äºæ¨¡æ¿ç»§æ‰¿
        is_builtin: æ˜¯å¦ä¸ºå†…ç½®æ¨¡æ¿ï¼ˆå†…ç½®æ¨¡æ¿ä¸å¯åˆ é™¤ï¼‰
        created_at: åˆ›å»ºæ—¶é—´
    """
    __tablename__ = 'permission_templates'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    code = Column(String(64), unique=True, nullable=False, index=True)
    name = Column(String(64), nullable=False)
    description = Column(String(256), nullable=True)
    permissions = Column(Text, nullable=False)  # JSON array of permission codes
    parent_template_code = Column(String(64), nullable=True, index=True)  # ç»§æ‰¿çš„çˆ¶æ¨¡æ¿
    is_builtin = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.now)
    
    def get_permissions(self) -> list:
        """è·å–æ¨¡æ¿åŒ…å«çš„æƒé™åˆ—è¡¨ï¼ˆä¸åŒ…å«ç»§æ‰¿çš„æƒé™ï¼‰
        
        Returns:
            æƒé™ä»£ç å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå¦‚æœ permissions ä¸ºç©ºåˆ™è¿”å›ç©ºåˆ—è¡¨
        """
        import json
        if not self.permissions:
            return []
        try:
            return json.loads(self.permissions)
        except (json.JSONDecodeError, TypeError):
            return []
    
    def get_all_permissions(self, session) -> list:
        """è·å–åŒ…å«ç»§æ‰¿çš„æ‰€æœ‰æƒé™
        
        é€’å½’è·å–çˆ¶æ¨¡æ¿çš„æƒé™ï¼Œåˆå¹¶åè¿”å›å»é‡çš„æƒé™åˆ—è¡¨ã€‚
        æ”¯æŒå¤šçº§ç»§æ‰¿ï¼ˆå¦‚ï¼šç®¡ç†å‘˜ extends æ“ä½œå‘˜ extends åªè¯»ç”¨æˆ·ï¼‰ã€‚
        
        Args:
            session: SQLAlchemy æ•°æ®åº“ä¼šè¯ï¼Œç”¨äºæŸ¥è¯¢çˆ¶æ¨¡æ¿
            
        Returns:
            åŒ…å«æ‰€æœ‰æƒé™ï¼ˆå«ç»§æ‰¿ï¼‰çš„å­—ç¬¦ä¸²åˆ—è¡¨ï¼Œå·²å»é‡
        """
        # è·å–å½“å‰æ¨¡æ¿çš„æƒé™
        perms = set(self.get_permissions())
        
        # å¦‚æœæœ‰çˆ¶æ¨¡æ¿ï¼Œé€’å½’è·å–çˆ¶æ¨¡æ¿çš„æƒé™
        if self.parent_template_code:
            parent = session.query(PermissionTemplate).filter_by(
                code=self.parent_template_code
            ).first()
            if parent:
                # é€’å½’è·å–çˆ¶æ¨¡æ¿çš„æ‰€æœ‰æƒé™å¹¶åˆå¹¶
                perms.update(parent.get_all_permissions(session))
        
        return list(perms)
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼
        
        Returns:
            åŒ…å«æ‰€æœ‰æ¨¡æ¿å­—æ®µçš„å­—å…¸
        """
        return {
            'id': self.id,
            'code': self.code,
            'name': self.name,
            'description': self.description,
            'permissions': self.get_permissions(),
            'parent_template_code': self.parent_template_code,
            'is_builtin': self.is_builtin,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
    
    def to_dict_with_all_permissions(self, session) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼ï¼ˆåŒ…å«ç»§æ‰¿çš„æ‰€æœ‰æƒé™ï¼‰
        
        Args:
            session: SQLAlchemy æ•°æ®åº“ä¼šè¯ï¼Œç”¨äºæŸ¥è¯¢çˆ¶æ¨¡æ¿
            
        Returns:
            åŒ…å«æ‰€æœ‰æ¨¡æ¿å­—æ®µçš„å­—å…¸ï¼Œpermissions å­—æ®µåŒ…å«ç»§æ‰¿çš„æƒé™
        """
        result = self.to_dict()
        result['all_permissions'] = self.get_all_permissions(session)
        return result
    
    def __repr__(self) -> str:
        return f"<PermissionTemplate(code='{self.code}', name='{self.name}', parent={self.parent_template_code!r})>"


class LoginAttempt(Base):
    """ç™»å½•å°è¯•è®°å½•æ¨¡å‹
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        user_id: ç”¨æˆ·IDï¼ˆå¤–é”®ï¼Œå¯ä¸ºç©ºï¼Œå› ä¸ºå¯èƒ½æ˜¯ä¸å­˜åœ¨çš„ç”¨æˆ·åï¼‰
        user_name: å°è¯•ç™»å½•çš„ç”¨æˆ·å
        ip_address: ç™»å½•IPåœ°å€
        user_agent: ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²
        success: ç™»å½•æ˜¯å¦æˆåŠŸ
        created_at: åˆ›å»ºæ—¶é—´ï¼ˆå¸¦ç´¢å¼•ï¼‰
    """
    __tablename__ = 'login_attempts'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey('web_manager_users.id'), nullable=True)
    user_name = Column(String(64), nullable=False)  # è®°å½•å°è¯•çš„ç”¨æˆ·å
    ip_address = Column(String(45), nullable=False)  # æ”¯æŒ IPv6
    user_agent = Column(String(256), nullable=True)
    success = Column(Boolean, nullable=False)
    created_at = Column(DateTime, default=datetime.now, index=True)
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
        return {
            'id': self.id,
            'user_id': self.user_id,
            'user_name': self.user_name,
            'ip_address': self.ip_address,
            'user_agent': self.user_agent,
            'success': self.success,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
    
    def __repr__(self) -> str:
        return f"<LoginAttempt(user='{self.user_name}', success={self.success}, ip='{self.ip_address}')>"


class PasswordResetToken(Base):
    """å¯†ç é‡ç½®ä»¤ç‰Œæ¨¡å‹
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        user_id: ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰
        token: é‡ç½®ä»¤ç‰Œï¼Œå”¯ä¸€ä¸”å¸¦ç´¢å¼•
        expires_at: è¿‡æœŸæ—¶é—´
        used: æ˜¯å¦å·²ä½¿ç”¨
        created_at: åˆ›å»ºæ—¶é—´
    """
    __tablename__ = 'password_reset_tokens'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey('web_manager_users.id'), nullable=False)
    token = Column(String(64), unique=True, nullable=False, index=True)
    expires_at = Column(DateTime, nullable=False)
    used = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.now)
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
        return {
            'id': self.id,
            'user_id': self.user_id,
            'token': self.token,
            'expires_at': self.expires_at.isoformat() if self.expires_at else None,
            'used': self.used,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
    
    def __repr__(self) -> str:
        return f"<PasswordResetToken(user_id={self.user_id}, used={self.used}, expires={self.expires_at})>"


class AuditLog(Base):
    """å®¡è®¡æ—¥å¿—æ¨¡å‹
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        event_type: äº‹ä»¶ç±»å‹ï¼ˆå¸¦ç´¢å¼•ï¼‰
        user_name: ç”¨æˆ·åï¼ˆå¸¦ç´¢å¼•ï¼Œå¯ä¸ºç©ºï¼‰
        ip_address: IPåœ°å€
        user_agent: ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²
        details: äº‹ä»¶è¯¦æƒ…ï¼ˆJSONæ ¼å¼ï¼‰
        created_at: åˆ›å»ºæ—¶é—´ï¼ˆå¸¦ç´¢å¼•ï¼‰
    """
    __tablename__ = 'audit_logs'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    event_type = Column(String(64), nullable=False, index=True)
    user_name = Column(String(64), nullable=True, index=True)
    ip_address = Column(String(45), nullable=True)
    user_agent = Column(String(256), nullable=True)
    details = Column(Text, nullable=True)  # JSON æ ¼å¼
    created_at = Column(DateTime, default=datetime.now, index=True)
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
        return {
            'id': self.id,
            'event_type': self.event_type,
            'user_name': self.user_name,
            'ip_address': self.ip_address,
            'user_agent': self.user_agent,
            'details': self.details,
            'created_at': self.created_at.isoformat() if self.created_at else None
        }
    
    def __repr__(self) -> str:
        return f"<AuditLog(event='{self.event_type}', user='{self.user_name}', time={self.created_at})>"


class EmailConfig(Base):
    """é‚®ä»¶é…ç½®æ¨¡å‹
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        smtp_host: SMTPæœåŠ¡å™¨åœ°å€
        smtp_port: SMTPç«¯å£
        smtp_username: SMTPç”¨æˆ·å
        smtp_password: SMTPå¯†ç ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
        use_tls: æ˜¯å¦ä½¿ç”¨TLS
        use_ssl: æ˜¯å¦ä½¿ç”¨SSL
        sender_name: å‘ä»¶äººåç§°
        sender_email: å‘ä»¶äººé‚®ç®±
        updated_at: æ›´æ–°æ—¶é—´
    """
    __tablename__ = 'email_config'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    smtp_host = Column(String(128), nullable=False)
    smtp_port = Column(Integer, default=587)
    smtp_username = Column(String(128), nullable=True)
    smtp_password = Column(String(256), nullable=True)  # åŠ å¯†å­˜å‚¨
    use_tls = Column(Boolean, default=True)
    use_ssl = Column(Boolean, default=False)
    sender_name = Column(String(64), nullable=True)
    sender_email = Column(String(128), nullable=False)
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now)
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
        return {
            'id': self.id,
            'smtp_host': self.smtp_host,
            'smtp_port': self.smtp_port,
            'smtp_username': self.smtp_username,
            'smtp_password': '***' if self.smtp_password else None,  # ä¸æš´éœ²å¯†ç 
            'use_tls': self.use_tls,
            'use_ssl': self.use_ssl,
            'sender_name': self.sender_name,
            'sender_email': self.sender_email,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self) -> str:
        return f"<EmailConfig(host='{self.smtp_host}', port={self.smtp_port})>"


class SystemConfig(Base):
    """ç³»ç»Ÿé…ç½®æ¨¡å‹
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        key: é…ç½®é”®ï¼Œå”¯ä¸€
        value: é…ç½®å€¼
        description: é…ç½®æè¿°
        updated_at: æ›´æ–°æ—¶é—´
    """
    __tablename__ = 'system_config'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    key = Column(String(64), unique=True, nullable=False)
    value = Column(String(256), nullable=True)
    description = Column(String(256), nullable=True)
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now)
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼"""
        return {
            'id': self.id,
            'key': self.key,
            'value': self.value,
            'description': self.description,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def __repr__(self) -> str:
        return f"<SystemConfig(key='{self.key}', value='{self.value}')>"


class Project(Base):
    """é¡¹ç›®æ¨¡å‹
    
    ç”¨äºå®ç°å¤šé¡¹ç›®æ•°æ®éš”ç¦»ï¼Œå…è®¸ä¸åŒé¡¹ç›®çš„é˜Ÿåˆ—æ•°æ®ç›¸äº’ç‹¬ç«‹ã€‚
    ç”¨æˆ·å¯ä»¥è¢«åˆ†é…ç‰¹å®šé¡¹ç›®çš„è®¿é—®æƒé™ã€‚
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        name: é¡¹ç›®åç§°ï¼Œå”¯ä¸€ï¼Œç”¨äºæ˜¾ç¤º
        code: é¡¹ç›®ä»£ç ï¼Œå”¯ä¸€ï¼Œç”¨äºæƒé™æ ‡è¯†ï¼ˆå¦‚ projectA:queue:readï¼‰
        description: é¡¹ç›®æè¿°
        status: é¡¹ç›®çŠ¶æ€ (active, archived)
        created_at: åˆ›å»ºæ—¶é—´
        updated_at: æ›´æ–°æ—¶é—´
        user_projects: ç”¨æˆ·-é¡¹ç›®å…³è”å…³ç³»ï¼ˆä¸€å¯¹å¤šï¼‰
        roles: å…³è”çš„è§’è‰²ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
    
    Requirements:
        - US-1.1: åˆ›å»ºã€ç¼–è¾‘å’Œåˆ é™¤é¡¹ç›®
        - US-1.2: ä¸ºé¡¹ç›®è®¾ç½®åç§°ã€æè¿°å’ŒçŠ¶æ€
    """
    __tablename__ = 'projects'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(64), unique=True, nullable=False, index=True)
    code = Column(String(32), unique=True, nullable=False, index=True)
    description = Column(String(256), nullable=True)
    status = Column(String(20), default='active')  # active, archived
    created_at = Column(DateTime, default=datetime.now)
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now)
    
    # ä¸€å¯¹å¤šå…³ç³»ï¼šé¡¹ç›® -> ç”¨æˆ·é¡¹ç›®å…³è”
    user_projects = relationship('UserProject', back_populates='project', cascade='all, delete-orphan')
    # å¤šå¯¹å¤šå…³ç³»ï¼šé¡¹ç›® -> è§’è‰²
    roles = relationship('Role', secondary=role_projects, back_populates='projects')
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼
        
        Returns:
            åŒ…å«æ‰€æœ‰é¡¹ç›®å­—æ®µçš„å­—å…¸
        """
        return {
            'id': self.id,
            'name': self.name,
            'code': self.code,
            'description': self.description,
            'status': self.status,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'updated_at': self.updated_at.isoformat() if self.updated_at else None
        }
    
    def is_active(self) -> bool:
        """åˆ¤æ–­é¡¹ç›®æ˜¯å¦ä¸ºæ´»è·ƒçŠ¶æ€
        
        Returns:
            True å¦‚æœé¡¹ç›®çŠ¶æ€ä¸º activeï¼Œå¦åˆ™ False
        """
        return self.status == 'active'
    
    def is_archived(self) -> bool:
        """åˆ¤æ–­é¡¹ç›®æ˜¯å¦å·²å½’æ¡£
        
        Returns:
            True å¦‚æœé¡¹ç›®çŠ¶æ€ä¸º archivedï¼Œå¦åˆ™ False
        """
        return self.status == 'archived'
    
    def __repr__(self) -> str:
        return f"<Project(name='{self.name}', code='{self.code}', status='{self.status}')>"


class UserProject(Base):
    """ç”¨æˆ·-é¡¹ç›®å…³è”æ¨¡å‹
    
    ç”¨äºå®ç°ç”¨æˆ·ä¸é¡¹ç›®çš„å¤šå¯¹å¤šå…³ç³»ï¼Œå¹¶è®°å½•ç”¨æˆ·åœ¨é¡¹ç›®ä¸­çš„æƒé™çº§åˆ«ã€‚
    æ”¯æŒç»†ç²’åº¦çš„é¡¹ç›®çº§æƒé™æ§åˆ¶ã€‚
    
    Attributes:
        id: è‡ªå¢ä¸»é”®
        user_id: ç”¨æˆ·IDï¼ˆå¤–é”®ï¼Œå…³è” web_manager_users.idï¼‰
        project_id: é¡¹ç›®IDï¼ˆå¤–é”®ï¼Œå…³è” projects.idï¼‰
        permission_level: æƒé™çº§åˆ« (read, write, admin)
        created_at: åˆ›å»ºæ—¶é—´
        user: å…³è”çš„ç”¨æˆ·å¯¹è±¡ï¼ˆå¤šå¯¹ä¸€å…³ç³»ï¼‰
        project: å…³è”çš„é¡¹ç›®å¯¹è±¡ï¼ˆå¤šå¯¹ä¸€å…³ç³»ï¼‰
    
    å”¯ä¸€çº¦æŸ:
        (user_id, project_id) - ç¡®ä¿æ¯ä¸ªç”¨æˆ·åœ¨æ¯ä¸ªé¡¹ç›®ä¸­åªæœ‰ä¸€æ¡è®°å½•
    
    Requirements:
        - US-2.1: å°†ç”¨æˆ·åˆ†é…åˆ°ç‰¹å®šé¡¹ç›®
        - US-2.2: ä¸ºç”¨æˆ·è®¾ç½®é¡¹ç›®çº§åˆ«çš„æƒé™
    """
    __tablename__ = 'user_projects'
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    user_id = Column(Integer, ForeignKey('web_manager_users.id'), nullable=False, index=True)
    project_id = Column(Integer, ForeignKey('projects.id'), nullable=False, index=True)
    permission_level = Column(String(20), default='read', nullable=False)  # read, write, admin
    created_at = Column(DateTime, default=datetime.now)
    
    # å”¯ä¸€çº¦æŸï¼šç¡®ä¿æ¯ä¸ªç”¨æˆ·åœ¨æ¯ä¸ªé¡¹ç›®ä¸­åªæœ‰ä¸€æ¡è®°å½•
    __table_args__ = (
        UniqueConstraint('user_id', 'project_id', name='uq_user_project'),
    )
    
    # å¤šå¯¹ä¸€å…³ç³»
    user = relationship('WebManagerUser', back_populates='user_projects')
    project = relationship('Project', back_populates='user_projects')
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼
        
        Returns:
            åŒ…å«æ‰€æœ‰å­—æ®µçš„å­—å…¸ï¼ŒåŒ…æ‹¬å…³è”çš„ç”¨æˆ·åå’Œé¡¹ç›®å
        """
        return {
            'id': self.id,
            'user_id': self.user_id,
            'project_id': self.project_id,
            'permission_level': self.permission_level,
            'created_at': self.created_at.isoformat() if self.created_at else None,
            'user_name': self.user.user_name if self.user else None,
            'project_name': self.project.name if self.project else None,
            'project_code': self.project.code if self.project else None
        }
    
    def has_read_access(self) -> bool:
        """åˆ¤æ–­æ˜¯å¦æœ‰è¯»å–æƒé™
        
        Returns:
            True å¦‚æœæƒé™çº§åˆ«ä¸º readã€write æˆ– admin
        """
        return self.permission_level in ('read', 'write', 'admin')
    
    def has_write_access(self) -> bool:
        """åˆ¤æ–­æ˜¯å¦æœ‰å†™å…¥æƒé™
        
        Returns:
            True å¦‚æœæƒé™çº§åˆ«ä¸º write æˆ– admin
        """
        return self.permission_level in ('write', 'admin')
    
    def has_admin_access(self) -> bool:
        """åˆ¤æ–­æ˜¯å¦æœ‰ç®¡ç†æƒé™
        
        Returns:
            True å¦‚æœæƒé™çº§åˆ«ä¸º admin
        """
        return self.permission_level == 'admin'
    
    def __repr__(self) -> str:
        return f"<UserProject(user_id={self.user_id}, project_id={self.project_id}, level='{self.permission_level}')>"


# æ•°æ®åº“å¼•æ“å’Œä¼šè¯å·¥å‚ï¼ˆæ”¯æŒå¤šä¸ªæ•°æ®åº“URLï¼‰
_engines = {}  # å­˜å‚¨ä¸åŒURLå¯¹åº”çš„å¼•æ“
_session_factories = {}  # å­˜å‚¨ä¸åŒURLå¯¹åº”çš„ä¼šè¯å·¥å‚
_engine_lock = Lock()


def get_db_url() -> str:
    """è·å–æ•°æ®åº“ URL
    
    ä¼˜å…ˆä» funboost_config.py çš„ FunboostCommonConfig è¯»å– WEB_MANAGER_DB_URLï¼Œ
    å¦‚æœè¯»å–å¤±è´¥åˆ™ä½¿ç”¨é»˜è®¤çš„ SQLite æ•°æ®åº“è·¯å¾„ã€‚
    
    Returns:
        æ•°æ®åº“è¿æ¥ URL å­—ç¬¦ä¸²
    """
    try:
        from funboost.funboost_config_deafult import FunboostCommonConfig
        return getattr(FunboostCommonConfig, 'WEB_MANAGER_DB_URL', 
                      'sqlite:///./web_manager_users.db')
    except Exception:
        return 'sqlite:///./web_manager_users.db'


def get_engine(db_url: Optional[str] = None):
    """è·å–æ•°æ®åº“å¼•æ“ï¼ˆæ”¯æŒå¤šä¸ªæ•°æ®åº“URLï¼‰
    
    Args:
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
        
    Returns:
        SQLAlchemy Engine å®ä¾‹
    """
    global _engines
    url = db_url or get_db_url()
    
    with _engine_lock:
        if url not in _engines:
            # SQLite éœ€è¦ç‰¹æ®Šçš„è¿æ¥å‚æ•°
            connect_args = {}
            if url.startswith('sqlite'):
                connect_args = {
                    'timeout': 30,  # ç­‰å¾…é”çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
                    'check_same_thread': False  # å…è®¸å¤šçº¿ç¨‹è®¿é—®
                }
            _engines[url] = create_engine(
                url,
                pool_pre_ping=True,  # è¿æ¥æ± å¥åº·æ£€æŸ¥
                echo=False,
                connect_args=connect_args
            )
    return _engines[url]


def get_session(db_url: Optional[str] = None):
    """è·å–æ•°æ®åº“ä¼šè¯
    
    Args:
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
        
    Returns:
        SQLAlchemy Session å®ä¾‹
    """
    global _session_factories
    url = db_url or get_db_url()
    
    # å…ˆè·å– engine
    engine = get_engine(url)
    
    with _engine_lock:
        if url not in _session_factories:
            _session_factories[url] = sessionmaker(bind=engine)
    
    return _session_factories[url]()


def reset_engine():
    """é‡ç½®æ•°æ®åº“å¼•æ“å’Œä¼šè¯å·¥å‚ï¼ˆä¸»è¦ç”¨äºæµ‹è¯•ï¼‰"""
    global _engines, _session_factories
    with _engine_lock:
        for engine in _engines.values():
            engine.dispose()
        _engines.clear()
        _session_factories.clear()


def init_db(db_url: Optional[str] = None) -> None:
    """åˆå§‹åŒ–æ•°æ®åº“è¡¨
    
    å¦‚æœè¡¨ä¸å­˜åœ¨åˆ™åˆ›å»ºã€‚
    
    Args:
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
    """
    engine = get_engine(db_url)
    Base.metadata.create_all(engine)


def init_default_users(db_url: Optional[str] = None, create_defaults: bool = True) -> None:
    """åˆå§‹åŒ–é»˜è®¤ç”¨æˆ·
    
    å¦‚æœç”¨æˆ·ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå·²å­˜åœ¨åˆ™è·³è¿‡ï¼ˆå¹‚ç­‰æ“ä½œï¼‰ã€‚
    é»˜è®¤ç”¨æˆ·åŒ…æ‹¬ï¼šTomã€userã€admin
    æ–°åˆ›å»ºçš„ç”¨æˆ·å¯†ç ä½¿ç”¨ bcrypt å“ˆå¸Œå­˜å‚¨
    å¯¹äºå·²å­˜åœ¨çš„ç”¨æˆ·ï¼Œå¦‚æœå¯†ç æ˜¯æ˜æ–‡æ ¼å¼ï¼Œæ ‡è®°ä¸ºéœ€è¦å‡çº§
    
    Args:
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
        create_defaults: æ˜¯å¦åˆ›å»ºé»˜è®¤ç”¨æˆ·ï¼ŒFalse æ—¶åªå¤„ç†ç°æœ‰ç”¨æˆ·çš„å‡çº§
    """
    # å¯¼å…¥å¯†ç æœåŠ¡
    from funboost.funboost_web_manager.services.password_service import PasswordService
    
    if not create_defaults:
        # åªå¤„ç†ç°æœ‰ç”¨æˆ·çš„å¯†ç å‡çº§ï¼Œä¸åˆ›å»ºæ–°çš„é»˜è®¤ç”¨æˆ·
        session = get_session(db_url)
        try:
            users = session.query(WebManagerUser).all()
            for user in users:
                if not _is_password_hashed(user.password):
                    user.force_password_change = True
            session.commit()
        except Exception:
            session.rollback()
            raise
        finally:
            session.close()
        return
    
    default_users = [
        {"user_name": "Tom", "password": "111111", "email": None},
        {"user_name": "user", "password": "mtfy123", "email": None},
        {"user_name": "admin", "password": "123456", "email": "qiannanlin@fxwljy.com"},
    ]
    
    session = get_session(db_url)
    try:
        for user_data in default_users:
            existing = session.query(WebManagerUser).filter_by(
                user_name=user_data['user_name']
            ).first()
            if not existing:
                # åˆ›å»ºæ–°ç”¨æˆ·ï¼Œä½¿ç”¨å“ˆå¸Œå¯†ç 
                hashed_password = PasswordService.hash_password(user_data['password'])
                user = WebManagerUser(
                    user_name=user_data['user_name'],
                    password=hashed_password,  # ä½¿ç”¨å“ˆå¸Œå¯†ç 
                    email=user_data['email'],
                    force_password_change=True  # ä»ç„¶å¼ºåˆ¶ä¿®æ”¹å¯†ç ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
                )
                session.add(user)
            else:
                # æ£€æŸ¥ç°æœ‰ç”¨æˆ·æ˜¯å¦éœ€è¦å‡çº§
                if not _is_password_hashed(existing.password):
                    existing.force_password_change = True
                    if user_data['email'] and not existing.email:
                        existing.email = user_data['email']
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()


def _is_password_hashed(password: str) -> bool:
    """æ£€æŸ¥å¯†ç æ˜¯å¦å·²ç»æ˜¯å“ˆå¸Œæ ¼å¼"""
    return password.startswith('$2b$') or password.startswith('$2a$')


def migrate_database(db_url: Optional[str] = None) -> None:
    """æ•°æ®åº“è¿ç§»è„šæœ¬
    
    å¤„ç†ä»æ—§ç‰ˆæœ¬åˆ°æ–°ç‰ˆæœ¬çš„æ•°æ®åº“å‡çº§ï¼š
    1. åˆ›å»ºæ‰€æœ‰æ–°è¡¨
    2. ä¸ºç°æœ‰è¡¨æ·»åŠ æ–°åˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    3. ä¸ºç°æœ‰ç”¨æˆ·æ·»åŠ æ–°å­—æ®µçš„é»˜è®¤å€¼
    4. æ ‡è®°æ˜æ–‡å¯†ç ç”¨æˆ·éœ€è¦å¼ºåˆ¶ä¿®æ”¹å¯†ç 
    5. åˆå§‹åŒ–é»˜è®¤æƒé™åˆ†ç±»ï¼ˆå«å­åˆ†ç±»ï¼‰
    6. åˆå§‹åŒ–é»˜è®¤æƒé™ï¼ˆå« action_typeï¼‰
    7. åˆå§‹åŒ–é»˜è®¤è§’è‰²
    8. ä¸ºadminç”¨æˆ·åˆ†é…adminè§’è‰²
    9. åˆå§‹åŒ–ç³»ç»Ÿé…ç½®
    10. åˆå§‹åŒ–é»˜è®¤æƒé™æ¨¡æ¿
    
    æ–°å¢å­—æ®µå¤„ç†ï¼š
    - permission_categories.parent_code: æ”¯æŒå­åˆ†ç±»
    - permissions.action_type: æ“ä½œç±»å‹
    - permissions.project_scope: é¡¹ç›®ä½œç”¨åŸŸ
    
    Args:
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
        
    Requirements:
    - 1.1: æ”¯æŒä¸‰çº§å±‚æ¬¡ç»“æ„ Category > Subcategory > Permission_Item
    - 2.1: å®šä¹‰æ ‡å‡†æ“ä½œç±»å‹ create, read, update, delete, execute, export
    - 14.1: æä¾›é¢„å®šä¹‰æƒé™æ¨¡æ¿
    """
    from sqlalchemy import inspect, text
    
    engine = get_engine(db_url)
    session = get_session(db_url)
    
    try:
        # 1. åˆ›å»ºæ‰€æœ‰è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        init_db(db_url)
        
        # 1.1 åˆ›å»º role_projects å…³è”è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        inspector = inspect(engine)
        if 'role_projects' not in inspector.get_table_names():
            with engine.connect() as conn:
                conn.execute(text('''
                    CREATE TABLE IF NOT EXISTS role_projects (
                        role_id INTEGER NOT NULL,
                        project_id INTEGER NOT NULL,
                        PRIMARY KEY (role_id, project_id),
                        FOREIGN KEY (role_id) REFERENCES roles(id),
                        FOREIGN KEY (project_id) REFERENCES projects(id)
                    )
                '''))
                conn.commit()
        
        # 2. æ£€æŸ¥å¹¶æ·»åŠ  permissions è¡¨çš„æ–°åˆ—
        inspector = inspect(engine)
        if 'permissions' in inspector.get_table_names():
            existing_columns = [col['name'] for col in inspector.get_columns('permissions')]
            
            # æ·»åŠ  category_code åˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if 'category_code' not in existing_columns:
                with engine.connect() as conn:
                    conn.execute(text('ALTER TABLE permissions ADD COLUMN category_code VARCHAR(64)'))
                    conn.commit()
            
            # æ·»åŠ  sort_order åˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if 'sort_order' not in existing_columns:
                with engine.connect() as conn:
                    conn.execute(text('ALTER TABLE permissions ADD COLUMN sort_order INTEGER DEFAULT 0'))
                    conn.commit()
            
            # æ·»åŠ  action_type åˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰- æ–°å¢å­—æ®µ
            if 'action_type' not in existing_columns:
                with engine.connect() as conn:
                    conn.execute(text('ALTER TABLE permissions ADD COLUMN action_type VARCHAR(32)'))
                    conn.commit()
            
            # æ·»åŠ  project_scope åˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰- æ–°å¢å­—æ®µ
            if 'project_scope' not in existing_columns:
                with engine.connect() as conn:
                    conn.execute(text('ALTER TABLE permissions ADD COLUMN project_scope VARCHAR(64)'))
                    conn.commit()
        
        # 3. æ£€æŸ¥å¹¶æ·»åŠ  permission_categories è¡¨çš„æ–°åˆ—
        if 'permission_categories' in inspector.get_table_names():
            existing_columns = [col['name'] for col in inspector.get_columns('permission_categories')]
            
            # æ·»åŠ  parent_code åˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰- æ”¯æŒå­åˆ†ç±»
            if 'parent_code' not in existing_columns:
                with engine.connect() as conn:
                    conn.execute(text('ALTER TABLE permission_categories ADD COLUMN parent_code VARCHAR(64)'))
                    conn.commit()
        
        # 4. æ£€æŸ¥å¹¶æ›´æ–°ç°æœ‰ç”¨æˆ·çš„æ–°å­—æ®µ
        users = session.query(WebManagerUser).all()
        for user in users:
            # å¦‚æœæ˜¯æ˜æ–‡å¯†ç ï¼Œæ ‡è®°éœ€è¦å¼ºåˆ¶ä¿®æ”¹
            if not _is_password_hashed(user.password):
                user.force_password_change = True
            
            # ç¡®ä¿çŠ¶æ€å­—æ®µæœ‰é»˜è®¤å€¼
            if not user.status:
                user.status = 'active'
            
            # ç¡®ä¿å¤±è´¥è®¡æ•°æœ‰é»˜è®¤å€¼
            if user.failed_login_count is None:
                user.failed_login_count = 0
        
        # 5. åˆå§‹åŒ–é»˜è®¤æƒé™åˆ†ç±»ï¼ˆå¿…é¡»åœ¨æƒé™ä¹‹å‰ï¼Œæ”¯æŒå­åˆ†ç±»ï¼‰
        _init_default_categories(session)
        
        # 6. åˆå§‹åŒ–é»˜è®¤æƒé™ï¼ˆå« action_typeï¼‰
        _init_default_permissions(session)
        
        # 7. ä¸ºç°æœ‰æƒé™è‡ªåŠ¨åˆ†é…åˆ†ç±»å’Œæ“ä½œç±»å‹
        _auto_assign_permission_categories(session)
        _auto_assign_permission_action_types(session)
        
        # 8. åˆå§‹åŒ–é»˜è®¤è§’è‰²
        _init_default_roles(session)
        
        # 9. ä¸ºadminç”¨æˆ·åˆ†é…adminè§’è‰²
        _assign_admin_role(session)
        
        # 10. åˆå§‹åŒ–ç³»ç»Ÿé…ç½®
        _init_system_config(session)
        
        # 11. åˆå§‹åŒ–é»˜è®¤æƒé™æ¨¡æ¿
        _init_default_permission_templates(session)
        
        # 12. åˆå§‹åŒ–é»˜è®¤é¡¹ç›®å¹¶å°†ç°æœ‰ç”¨æˆ·æ·»åŠ åˆ°é»˜è®¤é¡¹ç›®
        _init_default_project(session)
        
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()


# é»˜è®¤æƒé™åˆ†ç±»é…ç½®ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒå¤šå±‚çº§ç»“æ„ï¼‰
# æ”¯æŒä¸‰çº§å±‚æ¬¡ç»“æ„ï¼šCategory > Subcategory > Permission_Item
# é€šè¿‡ parent_code å­—æ®µå®ç°å­åˆ†ç±»å…³ç³»
DEFAULT_PERMISSION_CATEGORIES = [
    # é¡¶çº§åˆ†ç±»
    {"code": "system", "name": "ç³»ç»Ÿç®¡ç†", "description": "ç³»ç»Ÿçº§åˆ«ç®¡ç†åŠŸèƒ½", "sort_order": 1, "icon": "âš™ï¸", "parent_code": None},
    {"code": "queue", "name": "é˜Ÿåˆ—ç®¡ç†", "description": "æ¶ˆæ¯é˜Ÿåˆ—æ“ä½œ", "sort_order": 2, "icon": "ğŸ“¦", "parent_code": None},
    {"code": "monitor", "name": "ç›‘æ§", "description": "ç³»ç»Ÿç›‘æ§åŠŸèƒ½", "sort_order": 3, "icon": "ğŸ“Š", "parent_code": None},
    
    # ç³»ç»Ÿç®¡ç†å­åˆ†ç±»
    {"code": "user", "name": "ç”¨æˆ·ç®¡ç†", "description": "ç”¨æˆ·è´¦æˆ·ç›¸å…³æƒé™", "sort_order": 1, "icon": "ğŸ‘¤", "parent_code": "system"},
    {"code": "role", "name": "è§’è‰²ç®¡ç†", "description": "è§’è‰²å’Œæƒé™é…ç½®", "sort_order": 2, "icon": "ğŸ­", "parent_code": "system"},
    {"code": "audit", "name": "å®¡è®¡æ—¥å¿—", "description": "ç³»ç»Ÿå®¡è®¡å’Œæ—¥å¿—æŸ¥çœ‹", "sort_order": 3, "icon": "ğŸ“‹", "parent_code": "system"},
    {"code": "config", "name": "ç³»ç»Ÿé…ç½®", "description": "ç³»ç»Ÿè®¾ç½®å’Œé…ç½®", "sort_order": 4, "icon": "ğŸ”§", "parent_code": "system"},
    {"code": "project", "name": "é¡¹ç›®ç®¡ç†", "description": "é¡¹ç›®ç®¡ç†ç›¸å…³æƒé™", "sort_order": 5, "icon": "ğŸ“", "parent_code": "system"},
    
    # é˜Ÿåˆ—ç®¡ç†å­åˆ†ç±»
    {"code": "queue:task", "name": "ä»»åŠ¡ç®¡ç†", "description": "é˜Ÿåˆ—ä»»åŠ¡æ“ä½œ", "sort_order": 1, "icon": "ğŸ“", "parent_code": "queue"},
    {"code": "queue:consumer", "name": "æ¶ˆè´¹è€…ç®¡ç†", "description": "æ¶ˆè´¹è€…æ“ä½œ", "sort_order": 2, "icon": "ğŸ”„", "parent_code": "queue"},
    
    # å¼€å‘å·¥å…·åˆ†ç±»
    {"code": "devtools", "name": "å¼€å‘å·¥å…·", "description": "å¼€å‘å’Œè°ƒè¯•å·¥å…·", "sort_order": 4, "icon": "ğŸ› ï¸", "parent_code": None},
    
    # å¼€å‘å·¥å…·å­åˆ†ç±»
    {"code": "code_editor", "name": "ä»£ç ç¼–è¾‘å™¨", "description": "åœ¨çº¿ä»£ç ç¼–è¾‘å’Œæ‰§è¡Œ", "sort_order": 1, "icon": "ğŸ“", "parent_code": "devtools"},
]

# é»˜è®¤æƒé™é…ç½®ï¼ˆå¢å¼ºç‰ˆï¼šåŒ…å« action_type å­—æ®µï¼‰
# æ”¯æŒæ ‡å‡†æ“ä½œç±»å‹ï¼šcreate, read, update, delete, execute, export
DEFAULT_PERMISSIONS = [
    # ç”¨æˆ·ç®¡ç†æƒé™
    {"code": "user:create", "name": "åˆ›å»ºç”¨æˆ·", "description": "åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ·", "category_code": "user", "action_type": "create", "sort_order": 1},
    {"code": "user:read", "name": "æŸ¥çœ‹ç”¨æˆ·", "description": "æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨å’Œè¯¦æƒ…", "category_code": "user", "action_type": "read", "sort_order": 2},
    {"code": "user:update", "name": "ç¼–è¾‘ç”¨æˆ·", "description": "ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯", "category_code": "user", "action_type": "update", "sort_order": 3},
    {"code": "user:delete", "name": "åˆ é™¤ç”¨æˆ·", "description": "åˆ é™¤ç”¨æˆ·è´¦æˆ·", "category_code": "user", "action_type": "delete", "sort_order": 4},
    {"code": "user:export", "name": "å¯¼å‡ºç”¨æˆ·", "description": "å¯¼å‡ºç”¨æˆ·æ•°æ®", "category_code": "user", "action_type": "export", "sort_order": 5},
    
    # è§’è‰²ç®¡ç†æƒé™
    {"code": "role:create", "name": "åˆ›å»ºè§’è‰²", "description": "åˆ›å»ºæ–°è§’è‰²", "category_code": "role", "action_type": "create", "sort_order": 1},
    {"code": "role:read", "name": "æŸ¥çœ‹è§’è‰²", "description": "æŸ¥çœ‹è§’è‰²åˆ—è¡¨å’Œè¯¦æƒ…", "category_code": "role", "action_type": "read", "sort_order": 2},
    {"code": "role:update", "name": "ç¼–è¾‘è§’è‰²", "description": "ç¼–è¾‘è§’è‰²ä¿¡æ¯å’Œæƒé™", "category_code": "role", "action_type": "update", "sort_order": 3},
    {"code": "role:delete", "name": "åˆ é™¤è§’è‰²", "description": "åˆ é™¤è§’è‰²", "category_code": "role", "action_type": "delete", "sort_order": 4},
    
    # å®¡è®¡æ—¥å¿—æƒé™
    {"code": "audit:read", "name": "æŸ¥çœ‹å®¡è®¡æ—¥å¿—", "description": "æŸ¥çœ‹ç³»ç»Ÿå®¡è®¡æ—¥å¿—", "category_code": "audit", "action_type": "read", "sort_order": 1},
    {"code": "audit:export", "name": "å¯¼å‡ºå®¡è®¡æ—¥å¿—", "description": "å¯¼å‡ºå®¡è®¡æ—¥å¿—æ•°æ®", "category_code": "audit", "action_type": "export", "sort_order": 2},
    
    # ç³»ç»Ÿé…ç½®æƒé™
    {"code": "config:read", "name": "æŸ¥çœ‹ç³»ç»Ÿé…ç½®", "description": "æŸ¥çœ‹ç³»ç»Ÿé…ç½®", "category_code": "config", "action_type": "read", "sort_order": 1},
    {"code": "config:update", "name": "ä¿®æ”¹ç³»ç»Ÿé…ç½®", "description": "ä¿®æ”¹ç³»ç»Ÿé…ç½®", "category_code": "config", "action_type": "update", "sort_order": 2},
    
    # é¡¹ç›®ç®¡ç†æƒé™
    {"code": "project:create", "name": "åˆ›å»ºé¡¹ç›®", "description": "åˆ›å»ºæ–°é¡¹ç›®", "category_code": "project", "action_type": "create", "sort_order": 1},
    {"code": "project:read", "name": "æŸ¥çœ‹é¡¹ç›®", "description": "æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨å’Œè¯¦æƒ…", "category_code": "project", "action_type": "read", "sort_order": 2},
    {"code": "project:update", "name": "ç¼–è¾‘é¡¹ç›®", "description": "ç¼–è¾‘é¡¹ç›®ä¿¡æ¯", "category_code": "project", "action_type": "update", "sort_order": 3},
    {"code": "project:delete", "name": "åˆ é™¤é¡¹ç›®", "description": "åˆ é™¤é¡¹ç›®", "category_code": "project", "action_type": "delete", "sort_order": 4},
    {"code": "project:admin", "name": "é¡¹ç›®ç®¡ç†å‘˜", "description": "ç®¡ç†é¡¹ç›®ç”¨æˆ·å’Œæƒé™", "category_code": "project", "action_type": "execute", "sort_order": 5},
    
    # é˜Ÿåˆ—ç®¡ç†æƒé™
    {"code": "queue:read", "name": "æŸ¥çœ‹é˜Ÿåˆ—", "description": "æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€", "category_code": "queue", "action_type": "read", "sort_order": 1},
    {"code": "queue:execute", "name": "æ‰§è¡Œé˜Ÿåˆ—æ“ä½œ", "description": "æ‰§è¡Œé˜Ÿåˆ—ç›¸å…³æ“ä½œ", "category_code": "queue", "action_type": "execute", "sort_order": 2},
    {"code": "queue:task:create", "name": "åˆ›å»ºä»»åŠ¡", "description": "åˆ›å»ºé˜Ÿåˆ—ä»»åŠ¡", "category_code": "queue:task", "action_type": "create", "sort_order": 1},
    {"code": "queue:task:read", "name": "æŸ¥çœ‹ä»»åŠ¡", "description": "æŸ¥çœ‹é˜Ÿåˆ—ä»»åŠ¡", "category_code": "queue:task", "action_type": "read", "sort_order": 2},
    {"code": "queue:task:delete", "name": "åˆ é™¤ä»»åŠ¡", "description": "åˆ é™¤é˜Ÿåˆ—ä»»åŠ¡", "category_code": "queue:task", "action_type": "delete", "sort_order": 3},
    
    # ä»£ç ç¼–è¾‘å™¨æƒé™
    {"code": "code_editor:read", "name": "æŸ¥çœ‹ä»£ç ", "description": "æŸ¥çœ‹ä»£ç æ–‡ä»¶å’Œç¼–è¾‘å™¨ç•Œé¢", "category_code": "code_editor", "action_type": "read", "sort_order": 1},
    {"code": "code_editor:write", "name": "ç¼–è¾‘ä»£ç ", "description": "åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ä»£ç æ–‡ä»¶", "category_code": "code_editor", "action_type": "update", "sort_order": 2},
    {"code": "code_editor:execute", "name": "æ‰§è¡Œä»£ç ", "description": "è¿è¡Œä»£ç æ–‡ä»¶", "category_code": "code_editor", "action_type": "execute", "sort_order": 3},
]

# é»˜è®¤æƒé™æ¨¡æ¿é…ç½®
# æ”¯æŒæ¨¡æ¿ç»§æ‰¿ï¼šé€šè¿‡ parent_template_code å®ç°
DEFAULT_PERMISSION_TEMPLATES = [
    {
        "code": "viewer",
        "name": "åªè¯»ç”¨æˆ·",
        "description": "åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½ä¿®æ”¹",
        "permissions": ["user:read", "role:read", "audit:read", "config:read", "queue:read", "queue:task:read"],
        "parent_template_code": None,
        "is_builtin": True
    },
    {
        "code": "operator",
        "name": "æ“ä½œå‘˜",
        "description": "å¯ä»¥æ‰§è¡Œé˜Ÿåˆ—æ“ä½œ",
        "permissions": ["queue:execute", "queue:task:create", "queue:task:delete"],
        "parent_template_code": "viewer",
        "is_builtin": True
    },
    {
        "code": "admin",
        "name": "ç®¡ç†å‘˜",
        "description": "æ‹¥æœ‰æ‰€æœ‰æƒé™",
        "permissions": ["user:*", "role:*", "audit:*", "config:*", "queue:*", "project:*", "code_editor:*"],
        "parent_template_code": None,
        "is_builtin": True
    },
    {
        "code": "project_admin",
        "name": "é¡¹ç›®ç®¡ç†å‘˜",
        "description": "é¡¹ç›®çº§åˆ«çš„ç®¡ç†æƒé™",
        "permissions": ["queue:*", "queue:task:*"],
        "parent_template_code": "viewer",
        "is_builtin": True
    }
]


def _init_default_categories(session) -> None:
    """åˆå§‹åŒ–é»˜è®¤æƒé™åˆ†ç±»ï¼ˆå¹‚ç­‰æ“ä½œï¼‰
    
    æ”¯æŒå¤šå±‚çº§ç»“æ„ï¼šå…ˆåˆ›å»ºé¡¶çº§åˆ†ç±»ï¼Œå†åˆ›å»ºå­åˆ†ç±»ã€‚
    é€šè¿‡ parent_code å­—æ®µå®ç°åˆ†ç±»å±‚çº§å…³ç³»ã€‚
    """
    # åˆ†ç¦»é¡¶çº§åˆ†ç±»å’Œå­åˆ†ç±»ï¼Œç¡®ä¿å…ˆåˆ›å»ºé¡¶çº§åˆ†ç±»
    top_level_categories = [cat for cat in DEFAULT_PERMISSION_CATEGORIES if cat.get('parent_code') is None]
    sub_categories = [cat for cat in DEFAULT_PERMISSION_CATEGORIES if cat.get('parent_code') is not None]
    
    # å…ˆåˆ›å»ºé¡¶çº§åˆ†ç±»
    for cat_data in top_level_categories:
        existing = session.query(PermissionCategory).filter_by(code=cat_data['code']).first()
        if not existing:
            category = PermissionCategory(**cat_data)
            session.add(category)
        else:
            # æ›´æ–°ç°æœ‰åˆ†ç±»çš„å­—æ®µï¼ˆå¦‚æœéœ€è¦ï¼‰
            if existing.icon != cat_data.get('icon'):
                existing.icon = cat_data.get('icon')
            if existing.sort_order != cat_data.get('sort_order', 0):
                existing.sort_order = cat_data.get('sort_order', 0)
    
    # æäº¤é¡¶çº§åˆ†ç±»ï¼Œç¡®ä¿å¤–é”®çº¦æŸå¯ä»¥æ»¡è¶³
    session.flush()
    
    # å†åˆ›å»ºå­åˆ†ç±»
    for cat_data in sub_categories:
        existing = session.query(PermissionCategory).filter_by(code=cat_data['code']).first()
        if not existing:
            category = PermissionCategory(**cat_data)
            session.add(category)
        else:
            # æ›´æ–°ç°æœ‰åˆ†ç±»çš„å­—æ®µï¼ˆå¦‚æœéœ€è¦ï¼‰
            if existing.parent_code != cat_data.get('parent_code'):
                existing.parent_code = cat_data.get('parent_code')
            if existing.icon != cat_data.get('icon'):
                existing.icon = cat_data.get('icon')
            if existing.sort_order != cat_data.get('sort_order', 0):
                existing.sort_order = cat_data.get('sort_order', 0)


def _auto_assign_permission_categories(session) -> None:
    """ä¸ºç°æœ‰æƒé™è‡ªåŠ¨åˆ†é…åˆ†ç±»
    
    æ ¹æ®æƒé™ä»£ç å‰ç¼€ï¼ˆå¦‚ user:read -> userï¼‰è‡ªåŠ¨åˆ†é…åˆ°å¯¹åº”åˆ†ç±»
    """
    permissions = session.query(Permission).filter(Permission.category_code.is_(None)).all()
    for perm in permissions:
        # ä»æƒé™ä»£ç æå–åˆ†ç±»ä»£ç ï¼ˆå¦‚ user:read -> userï¼‰
        if ':' in perm.code:
            category_code = perm.code.split(':')[0]
            # æ£€æŸ¥åˆ†ç±»æ˜¯å¦å­˜åœ¨
            category = session.query(PermissionCategory).filter_by(code=category_code).first()
            if category:
                perm.category_code = category_code


def _auto_assign_permission_action_types(session) -> None:
    """ä¸ºç°æœ‰æƒé™è‡ªåŠ¨åˆ†é…æ“ä½œç±»å‹
    
    æ ¹æ®æƒé™ä»£ç åç¼€ï¼ˆå¦‚ user:read -> readï¼‰è‡ªåŠ¨åˆ†é…æ“ä½œç±»å‹ã€‚
    æ”¯æŒæ ‡å‡†æ“ä½œç±»å‹ï¼šcreate, read, update, delete, execute, export
    ä»¥åŠæ—§ç‰ˆæœ¬çš„ write ç±»å‹ï¼ˆæ˜ å°„åˆ° updateï¼‰ã€‚
    
    Requirements:
    - 2.1: å®šä¹‰æ ‡å‡†æ“ä½œç±»å‹
    - 2.4: ä»æƒé™ä»£ç æå–æ“ä½œç±»å‹
    """
    # æ ‡å‡†æ“ä½œç±»å‹
    standard_action_types = {'create', 'read', 'update', 'delete', 'execute', 'export'}
    # æ—§ç‰ˆæœ¬æ“ä½œç±»å‹æ˜ å°„
    legacy_action_mapping = {
        'write': 'update',  # æ—§ç‰ˆ write æ˜ å°„åˆ° update
    }
    
    permissions = session.query(Permission).filter(Permission.action_type.is_(None)).all()
    for perm in permissions:
        if ':' in perm.code:
            # ä»æƒé™ä»£ç æå–æ“ä½œç±»å‹ï¼ˆæœ€åä¸€æ®µï¼‰
            action = perm.code.split(':')[-1]
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºæ ‡å‡†æ“ä½œç±»å‹
            if action in standard_action_types:
                perm.action_type = action
            # æ£€æŸ¥æ˜¯å¦ä¸ºæ—§ç‰ˆæ“ä½œç±»å‹
            elif action in legacy_action_mapping:
                perm.action_type = legacy_action_mapping[action]
            # å…¶ä»–è‡ªå®šä¹‰æ“ä½œç±»å‹ä¿æŒåŸæ ·
            else:
                perm.action_type = action


def _init_default_permissions(session) -> None:
    """åˆå§‹åŒ–é»˜è®¤æƒé™ï¼ˆåŒ…å«åˆ†ç±»ã€æ“ä½œç±»å‹å’Œæ’åºä¿¡æ¯ï¼‰
    
    ä½¿ç”¨ DEFAULT_PERMISSIONS é…ç½®ï¼Œæ”¯æŒï¼š
    - category_code: æƒé™æ‰€å±åˆ†ç±»
    - action_type: æ“ä½œç±»å‹ï¼ˆcreate, read, update, delete, execute, exportï¼‰
    - sort_order: æ’åºé¡ºåº
    - project_scope: é¡¹ç›®ä½œç”¨åŸŸï¼ˆå¯é€‰ï¼‰
    """
    for perm_data in DEFAULT_PERMISSIONS:
        existing = session.query(Permission).filter_by(code=perm_data['code']).first()
        if not existing:
            permission = Permission(**perm_data)
            session.add(permission)
        else:
            # æ›´æ–°ç°æœ‰æƒé™çš„å­—æ®µï¼ˆå¦‚æœæœªè®¾ç½®æˆ–éœ€è¦æ›´æ–°ï¼‰
            if existing.category_code is None and 'category_code' in perm_data:
                existing.category_code = perm_data['category_code']
            if existing.sort_order == 0 and 'sort_order' in perm_data:
                existing.sort_order = perm_data['sort_order']
            # æ›´æ–° action_typeï¼ˆæ–°å¢å­—æ®µï¼‰
            if existing.action_type is None and 'action_type' in perm_data:
                existing.action_type = perm_data['action_type']
            # æ›´æ–° project_scopeï¼ˆæ–°å¢å­—æ®µï¼‰
            if existing.project_scope is None and 'project_scope' in perm_data:
                existing.project_scope = perm_data.get('project_scope')
            # æ›´æ–°æè¿°ï¼ˆå¦‚æœä¸ºç©ºï¼‰
            if existing.description is None and 'description' in perm_data:
                existing.description = perm_data['description']


def _init_default_roles(session) -> None:
    """åˆå§‹åŒ–é»˜è®¤è§’è‰²
    
    ä½¿ç”¨æ–°çš„ç»†ç²’åº¦æƒé™ä»£ç ï¼ˆåŒ…å« action_typeï¼‰ã€‚
    """
    default_roles = [
        {
            "name": "admin",
            "description": "ç³»ç»Ÿç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™",
            "is_builtin": True,
            "permissions": [
                "user:create", "user:read", "user:update", "user:delete", "user:export",
                "role:create", "role:read", "role:update", "role:delete",
                "audit:read", "audit:export",
                "config:read", "config:update",
                "project:create", "project:read", "project:update", "project:delete", "project:admin",
                "queue:read", "queue:execute",
                "queue:task:create", "queue:task:read", "queue:task:delete",
                "code_editor:read", "code_editor:write", "code_editor:execute"
            ]
        },
        {
            "name": "operator",
            "description": "æ“ä½œå‘˜ï¼Œå¯ä»¥ç®¡ç†é˜Ÿåˆ—",
            "is_builtin": True,
            "permissions": [
                "user:read",
                "queue:read", "queue:execute",
                "queue:task:create", "queue:task:read", "queue:task:delete"
            ]
        },
        {
            "name": "viewer",
            "description": "åªè¯»ç”¨æˆ·ï¼Œåªèƒ½æŸ¥çœ‹",
            "is_builtin": True,
            "permissions": [
                "user:read", "role:read", "audit:read", "config:read",
                "queue:read", "queue:task:read"
            ]
        }
    ]
    
    for role_data in default_roles:
        existing = session.query(Role).filter_by(name=role_data['name']).first()
        if not existing:
            role = Role(
                name=role_data['name'],
                description=role_data['description'],
                is_builtin=role_data['is_builtin']
            )
            
            # åˆ†é…æƒé™
            for perm_code in role_data['permissions']:
                permission = session.query(Permission).filter_by(code=perm_code).first()
                if permission:
                    role.permissions.append(permission)
            
            session.add(role)


def _assign_admin_role(session) -> None:
    """ä¸ºadminç”¨æˆ·åˆ†é…adminè§’è‰²"""
    admin_user = session.query(WebManagerUser).filter_by(user_name='admin').first()
    admin_role = session.query(Role).filter_by(name='admin').first()
    
    if admin_user and admin_role:
        # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰adminè§’è‰²
        if admin_role not in admin_user.roles:
            admin_user.roles.append(admin_role)


def _init_system_config(session) -> None:
    """åˆå§‹åŒ–ç³»ç»Ÿé…ç½®"""
    default_configs = [
        {"key": "audit_retention_days", "value": "30", "description": "å®¡è®¡æ—¥å¿—ä¿ç•™å¤©æ•°"}
    ]
    
    for config_data in default_configs:
        existing = session.query(SystemConfig).filter_by(key=config_data['key']).first()
        if not existing:
            config = SystemConfig(**config_data)
            session.add(config)


def _init_default_permission_templates(session) -> None:
    """åˆå§‹åŒ–é»˜è®¤æƒé™æ¨¡æ¿ï¼ˆå¹‚ç­‰æ“ä½œï¼‰
    
    åˆ›å»ºé¢„å®šä¹‰çš„æƒé™æ¨¡æ¿ï¼Œæ”¯æŒæ¨¡æ¿ç»§æ‰¿ã€‚
    æ¨¡æ¿åŒ…æ‹¬ï¼šåªè¯»ç”¨æˆ·ã€æ“ä½œå‘˜ã€ç®¡ç†å‘˜ã€é¡¹ç›®ç®¡ç†å‘˜
    
    Requirements:
    - 14.1: æä¾›é¢„å®šä¹‰æƒé™æ¨¡æ¿
    """
    import json
    
    for template_data in DEFAULT_PERMISSION_TEMPLATES:
        existing = session.query(PermissionTemplate).filter_by(code=template_data['code']).first()
        if not existing:
            template = PermissionTemplate(
                code=template_data['code'],
                name=template_data['name'],
                description=template_data.get('description'),
                permissions=json.dumps(template_data['permissions']),
                parent_template_code=template_data.get('parent_template_code'),
                is_builtin=template_data.get('is_builtin', False)
            )
            session.add(template)
        else:
            # æ›´æ–°ç°æœ‰æ¨¡æ¿çš„å­—æ®µï¼ˆå¦‚æœéœ€è¦ï¼‰
            if existing.description != template_data.get('description'):
                existing.description = template_data.get('description')
            if existing.parent_template_code != template_data.get('parent_template_code'):
                existing.parent_template_code = template_data.get('parent_template_code')
            # æ›´æ–°æƒé™åˆ—è¡¨ï¼ˆä»…å¯¹å†…ç½®æ¨¡æ¿ï¼‰
            if existing.is_builtin:
                existing.permissions = json.dumps(template_data['permissions'])


def _init_default_project(session) -> None:
    """åˆå§‹åŒ–é»˜è®¤é¡¹ç›®å¹¶å°†ç°æœ‰ç”¨æˆ·æ·»åŠ åˆ°é»˜è®¤é¡¹ç›®ï¼ˆå¹‚ç­‰æ“ä½œï¼‰
    
    åˆ›å»ºé»˜è®¤é¡¹ç›® "default"ï¼ˆcode: "default", name: "é»˜è®¤é¡¹ç›®"ï¼‰ï¼Œ
    å¹¶å°†æ‰€æœ‰ç°æœ‰ç”¨æˆ·æ·»åŠ åˆ°é»˜è®¤é¡¹ç›®ï¼Œä»¥ä¿æŒå‘åå…¼å®¹ã€‚
    
    è¿ç§»ç­–ç•¥ï¼š
    1. åˆ›å»ºé»˜è®¤é¡¹ç›®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    2. å°†æ‰€æœ‰ç°æœ‰ç”¨æˆ·æ·»åŠ åˆ°é»˜è®¤é¡¹ç›®ï¼ˆpermission_level="admin"ï¼‰
    3. ç¡®ä¿æ“ä½œå¹‚ç­‰ï¼ˆå¯å¤šæ¬¡è¿è¡Œè€Œä¸äº§ç”Ÿé‡å¤æ•°æ®ï¼‰
    
    Requirements:
    - AC-1: é¡¹ç›® CRUD - åˆ›å»ºé»˜è®¤é¡¹ç›®
    - è¿ç§»ç­–ç•¥: å°†æ‰€æœ‰ç”¨æˆ·æ·»åŠ åˆ°é»˜è®¤é¡¹ç›®ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
    """
    # 1. åˆ›å»ºé»˜è®¤é¡¹ç›®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    default_project = session.query(Project).filter_by(code='default').first()
    if not default_project:
        default_project = Project(
            name='é»˜è®¤é¡¹ç›®',
            code='default',
            description='ç³»ç»Ÿé»˜è®¤é¡¹ç›®ï¼Œç”¨äºå‘åå…¼å®¹',
            status='active'
        )
        session.add(default_project)
        # åˆ·æ–°ä»¥è·å–è‡ªåŠ¨ç”Ÿæˆçš„ id
        session.flush()
    
    # 2. å°†æ‰€æœ‰ç°æœ‰ç”¨æˆ·æ·»åŠ åˆ°é»˜è®¤é¡¹ç›®ï¼ˆå¦‚æœå°šæœªæ·»åŠ ï¼‰
    all_users = session.query(WebManagerUser).all()
    for user in all_users:
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»åœ¨é»˜è®¤é¡¹ç›®ä¸­
        existing_user_project = session.query(UserProject).filter_by(
            user_id=user.id,
            project_id=default_project.id
        ).first()
        
        if not existing_user_project:
            # æ·»åŠ ç”¨æˆ·åˆ°é»˜è®¤é¡¹ç›®ï¼Œæƒé™çº§åˆ«ä¸º adminï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
            user_project = UserProject(
                user_id=user.id,
                project_id=default_project.id,
                permission_level='admin'
            )
            session.add(user_project)


def query_user_by_name(user_name: str, db_url: Optional[str] = None) -> Optional[Dict[str, Any]]:
    """æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
    
    Args:
        user_name: è¦æŸ¥è¯¢çš„ç”¨æˆ·å
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
        
    Returns:
        ç”¨æˆ·å­—å…¸ï¼ˆåŒ…å« idã€user_nameã€passwordï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› None
    """
    session = get_session(db_url)
    try:
        user = session.query(WebManagerUser).filter_by(user_name=user_name).first()
        return user.to_dict() if user else None
    finally:
        session.close()


def query_user_by_id(user_id: str, db_url: Optional[str] = None) -> Optional[Dict[str, Any]]:
    """æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢ç”¨æˆ·
    
    æ³¨æ„ï¼šä¸ºä¿æŒä¸åŸæœ‰ Flask-Login é›†æˆå…¼å®¹ï¼Œuser_id å®é™…ä¸Šæ˜¯ user_name
    
    Args:
        user_id: ç”¨æˆ·IDï¼ˆå³ user_nameï¼‰
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
        
    Returns:
        ç”¨æˆ·å­—å…¸ï¼ˆåŒ…å« idã€user_nameã€passwordï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å› None
    """
    return query_user_by_name(user_id, db_url)


def add_user(user_name: str, password: str, email: str = None, 
             status: str = 'active', force_password_change: bool = False,
             db_url: Optional[str] = None) -> WebManagerUser:
    """æ·»åŠ æ–°ç”¨æˆ·
    
    Args:
        user_name: ç”¨æˆ·å
        password: å¯†ç ï¼ˆå¦‚æœä¸æ˜¯å“ˆå¸Œæ ¼å¼ï¼Œå°†è‡ªåŠ¨å“ˆå¸Œï¼‰
        email: é‚®ç®±åœ°å€
        status: ç”¨æˆ·çŠ¶æ€ï¼Œé»˜è®¤ä¸º 'active'
        force_password_change: æ˜¯å¦å¼ºåˆ¶ä¿®æ”¹å¯†ç ï¼Œé»˜è®¤ä¸º False
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
        
    Returns:
        åˆ›å»ºçš„ç”¨æˆ·å¯¹è±¡
        
    Raises:
        IntegrityError: å¦‚æœç”¨æˆ·åå·²å­˜åœ¨
    """
    # å¯¼å…¥å¯†ç æœåŠ¡
    from funboost.funboost_web_manager.services.password_service import PasswordService
    
    session = get_session(db_url)
    try:
        # å¦‚æœå¯†ç ä¸æ˜¯å“ˆå¸Œæ ¼å¼ï¼Œè¿›è¡Œå“ˆå¸Œ
        if not PasswordService.is_hashed(password):
            password = PasswordService.hash_password(password)
        
        user = WebManagerUser(
            user_name=user_name, 
            password=password,
            email=email,
            status=status,
            force_password_change=force_password_change
        )
        session.add(user)
        session.commit()
        # åˆ·æ–°ä»¥è·å–è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µ
        session.refresh(user)
        return user
    except IntegrityError:
        session.rollback()
        raise
    finally:
        session.close()


def count_users(db_url: Optional[str] = None) -> int:
    """ç»Ÿè®¡ç”¨æˆ·æ•°é‡
    
    Args:
        db_url: å¯é€‰çš„æ•°æ®åº“ URLï¼Œå¦‚æœä¸æä¾›åˆ™ä»é…ç½®è·å–
        
    Returns:
        ç”¨æˆ·æ€»æ•°
    """
    session = get_session(db_url)
    try:
        return session.query(WebManagerUser).count()
    finally:
        session.close()
