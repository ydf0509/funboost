# RabbitMQ Headers è·¯ç”±æ¨¡å¼ç¤ºä¾‹

æœ¬ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ä½¿ç”¨ funboost æ¡†æ¶å®ç° RabbitMQ çš„ Headers è·¯ç”±æ¨¡å¼ã€‚

## Headers è·¯ç”±æ¨¡å¼ç‰¹ç‚¹

Headers è·¯ç”±æ¨¡å¼æ˜¯ RabbitMQ ä¸­æœ€çµæ´»çš„è·¯ç”±æ–¹å¼ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- ğŸ·ï¸ **åŸºäºæ¶ˆæ¯å¤´å±æ€§**ï¼šå®Œå…¨æ ¹æ®æ¶ˆæ¯çš„å¤´éƒ¨å±æ€§è¿›è¡Œè·¯ç”±ï¼Œå¿½ç•¥è·¯ç”±é”®
- ğŸ¯ **çµæ´»çš„åŒ¹é…è§„åˆ™**ï¼šæ”¯æŒ `all`ï¼ˆå…¨åŒ¹é…ï¼‰å’Œ `any`ï¼ˆä»»æ„åŒ¹é…ï¼‰ä¸¤ç§ç­–ç•¥
- ğŸ”§ **å¤æ‚æ¡ä»¶è·¯ç”±**ï¼šå¯ä»¥å®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘è·¯ç”±æ¡ä»¶
- ğŸ“Š **å¤šç»´åº¦åŒ¹é…**ï¼šæ”¯æŒå¤šä¸ªå¤´å±æ€§çš„ç»„åˆåŒ¹é…

## æ–‡ä»¶è¯´æ˜

- `t_headers_consume.py`: æ¶ˆè´¹è€…ç¤ºä¾‹ï¼Œå±•ç¤ºä¸åŒçš„å¤´å±æ€§ç»‘å®šè§„åˆ™
- `t_headers_pub.py`: å‘å¸ƒè€…ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨åŠ¨æ€æ¶ˆæ¯å¤´å‘å¸ƒæ¶ˆæ¯

## ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹

æœ¬ç¤ºä¾‹æ¨¡æ‹Ÿäº†ä¸€ä¸ªæ™ºèƒ½é€šçŸ¥ç³»ç»Ÿï¼Œæ ¹æ®æ¶ˆæ¯çš„ä¸åŒå±æ€§å°†é€šçŸ¥è·¯ç”±åˆ°ç›¸åº”çš„å¤„ç†æœåŠ¡ï¼š

### æ¶ˆè´¹è€…æœåŠ¡åŠç»‘å®šè§„åˆ™

1. **ğŸš¨ ç´§æ€¥é€šçŸ¥æœåŠ¡** (`q_urgent_notifications`)
   - ç»‘å®šæ¡ä»¶: `priority=high` **AND** `urgent=true`
   - åŒ¹é…ç­–ç•¥: `all` (å¿…é¡»åŒæ—¶æ»¡è¶³æ‰€æœ‰æ¡ä»¶)
   - å¤„ç†: æœ€é«˜ä¼˜å…ˆçº§çš„ç´§æ€¥é€šçŸ¥

2. **âš¡ é«˜ä¼˜å…ˆçº§é€šçŸ¥æœåŠ¡** (`q_high_priority_notifications`)
   - ç»‘å®šæ¡ä»¶: `priority=high`
   - åŒ¹é…ç­–ç•¥: `all`
   - å¤„ç†: æ‰€æœ‰é«˜ä¼˜å…ˆçº§é€šçŸ¥

3. **ğŸ“± ç§»åŠ¨ç«¯é€šçŸ¥æœåŠ¡** (`q_mobile_notifications`)
   - ç»‘å®šæ¡ä»¶: `platform=mobile` **OR** `device_type=phone`
   - åŒ¹é…ç­–ç•¥: `any` (æ»¡è¶³ä»»æ„ä¸€ä¸ªæ¡ä»¶å³å¯)
   - å¤„ç†: ç§»åŠ¨ç«¯ç›¸å…³é€šçŸ¥

4. **ğŸ”§ ç³»ç»Ÿç®¡ç†é€šçŸ¥æœåŠ¡** (`q_system_admin_notifications`)
   - ç»‘å®šæ¡ä»¶: `category=system` **AND** `role=admin`
   - åŒ¹é…ç­–ç•¥: `all`
   - å¤„ç†: ç³»ç»Ÿç®¡ç†å‘˜ä¸“ç”¨é€šçŸ¥

5. **ğŸ“¢ è¥é”€é€šçŸ¥æœåŠ¡** (`q_marketing_notifications`)
   - ç»‘å®šæ¡ä»¶: `category=marketing` **OR** `priority=low`
   - åŒ¹é…ç­–ç•¥: `any`
   - å¤„ç†: è¥é”€æ¨å¹¿ç›¸å…³é€šçŸ¥

6. **ğŸ“‹ å®¡è®¡é€šçŸ¥æœåŠ¡** (`q_audit_all_notifications`)
   - ç»‘å®šæ¡ä»¶: `has_user_id=true`
   - åŒ¹é…ç­–ç•¥: `all`
   - å¤„ç†: æ‰€æœ‰éœ€è¦å®¡è®¡çš„é€šçŸ¥è®°å½•

## è¿è¡Œç¤ºä¾‹

### 1. å¯åŠ¨æ¶ˆè´¹è€…

```bash
cd test_frame/test_broker_rabbitmq/test_rabbitmq_complex_routing/t_headers
python t_headers_consume.py
```

### 2. å‘å¸ƒæ¶ˆæ¯

åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œï¼š

```bash
cd test_frame/test_broker_rabbitmq/test_rabbitmq_complex_routing/t_headers
python t_headers_pub.py
```

## æ¶ˆæ¯è·¯ç”±ç¤ºä¾‹

| æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯å¤´å±æ€§ | åŒ¹é…çš„æ¶ˆè´¹è€… |
|---------|-----------|-------------|
| ç³»ç»Ÿä¸¥é‡æ•…éšœ | `priority=high, urgent=true, category=system, role=admin` | ğŸš¨ç´§æ€¥ + âš¡é«˜ä¼˜å…ˆçº§ + ğŸ”§ç³»ç»Ÿç®¡ç† + ğŸ“‹å®¡è®¡ |
| è®¢å•æ”¯ä»˜æˆåŠŸ | `priority=high, platform=mobile` | âš¡é«˜ä¼˜å…ˆçº§ + ğŸ“±ç§»åŠ¨ç«¯ + ğŸ“‹å®¡è®¡ |
| æ–°åŠŸèƒ½ä¸Šçº¿ | `priority=low, category=marketing` | ğŸ“¢è¥é”€é€šçŸ¥ + ğŸ“‹å®¡è®¡ |
| è´¦æˆ·å®‰å…¨æé†’ | `priority=high, urgent=true, device_type=phone` | ğŸš¨ç´§æ€¥ + âš¡é«˜ä¼˜å…ˆçº§ + ğŸ“±ç§»åŠ¨ç«¯ + ğŸ“‹å®¡è®¡ |
| ç³»ç»Ÿç»´æŠ¤é€šçŸ¥ | `category=system, role=admin, priority=medium` | ğŸ”§ç³»ç»Ÿç®¡ç† + ğŸ“‹å®¡è®¡ |

## æ ¸å¿ƒé…ç½®è¯´æ˜

### æ¶ˆè´¹è€…é…ç½®

```python
@BoosterParams(
    queue_name='é˜Ÿåˆ—åç§°',
    broker_kind=BrokerEnum.RABBITMQ_COMPLEX_ROUTING,
    broker_exclusive_config={
        'exchange_name': 'headers_notification_exchange',
        'exchange_type': 'headers',
        'headers_for_bind': {
            'priority': 'high',      # å¤´å±æ€§åŒ¹é…æ¡ä»¶
            'urgent': 'true'         # å¯ä»¥è®¾ç½®å¤šä¸ªæ¡ä»¶
        },
        'x_match_for_bind': 'all',   # 'all' æˆ– 'any'
    })
def consumer_function(user_id: str, title: str, content: str, timestamp: str):
    # æ¶ˆè´¹è€…å‡½æ•°çš„å‚æ•°åå¿…é¡»ä¸å‘å¸ƒçš„å­—å…¸ keys å®Œå…¨ä¸€è‡´
    pass
```

### å‘å¸ƒè€…é…ç½®

```python
headers_publisher = BoostersManager.get_cross_project_publisher(PublisherParams(
    queue_name='å‘å¸ƒè€…å®ä¾‹å',
    broker_kind=BrokerEnum.RABBITMQ_COMPLEX_ROUTING,
    broker_exclusive_config={
        'exchange_name': 'headers_notification_exchange',
        'exchange_type': 'headers',
        # headers æ¨¡å¼ä¸ä½¿ç”¨è·¯ç”±é”®
    }
))

# å‘å¸ƒæ¶ˆæ¯æ—¶æŒ‡å®šå¤´å±æ€§
headers_publisher.publish(
    {'user_id': 'user001', 'title': 'æ ‡é¢˜', 'content': 'å†…å®¹', 'timestamp': 'æ—¶é—´'},
    priority_control_config=PriorityConsumingControlConfig(
        other_extra_params={
            'headers_for_publish': {
                'priority': 'high',
                'urgent': 'true',
                'category': 'system'
            }
        }
    )
)
```

## åŒ¹é…ç­–ç•¥è¯´æ˜

### `x_match_for_bind: 'all'` (å…¨åŒ¹é…)
- æ¶ˆæ¯å¤´å¿…é¡»åŒ…å«**æ‰€æœ‰**æŒ‡å®šçš„å±æ€§ï¼Œä¸”å€¼å®Œå…¨åŒ¹é…
- é€‚ç”¨äºéœ€è¦ä¸¥æ ¼æ¡ä»¶æ§åˆ¶çš„åœºæ™¯

### `x_match_for_bind: 'any'` (ä»»æ„åŒ¹é…)  
- æ¶ˆæ¯å¤´åªéœ€åŒ…å«**ä»»æ„ä¸€ä¸ª**æŒ‡å®šçš„å±æ€§åŒ¹é…å³å¯
- é€‚ç”¨äºå¤šç§æ¡ä»¶éƒ½å¯ä»¥è§¦å‘çš„åœºæ™¯

## ä½¿ç”¨åœºæ™¯

Headers è·¯ç”±æ¨¡å¼ç‰¹åˆ«é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š

1. **æ™ºèƒ½é€šçŸ¥ç³»ç»Ÿ**: æ ¹æ®ä¼˜å…ˆçº§ã€å¹³å°ã€ç”¨æˆ·è§’è‰²ç­‰å¤šç»´åº¦è·¯ç”±
2. **å¤šç§Ÿæˆ·ç³»ç»Ÿ**: æ ¹æ®ç§Ÿæˆ·IDã€æƒé™çº§åˆ«ç­‰å±æ€§è·¯ç”±
3. **å†…å®¹åˆ†å‘ç³»ç»Ÿ**: æ ¹æ®å†…å®¹ç±»å‹ã€åœ°åŒºã€è¯­è¨€ç­‰å±æ€§è·¯ç”±
4. **ç›‘æ§å‘Šè­¦ç³»ç»Ÿ**: æ ¹æ®å‘Šè­¦çº§åˆ«ã€æœåŠ¡ç±»å‹ã€è´£ä»»äººç­‰è·¯ç”±
5. **å·¥ä½œæµç³»ç»Ÿ**: æ ¹æ®ä»»åŠ¡ç±»å‹ã€å¤„ç†äººã€ä¼˜å…ˆçº§ç­‰è·¯ç”±
6. **APIç½‘å…³**: æ ¹æ®è¯·æ±‚æ¥æºã€è®¤è¯çº§åˆ«ã€APIç‰ˆæœ¬ç­‰è·¯ç”±

## ä¸å…¶ä»–è·¯ç”±æ¨¡å¼çš„å¯¹æ¯”

| è·¯ç”±æ¨¡å¼ | è·¯ç”±ä¾æ® | çµæ´»æ€§ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|--------|---------|
| **Headers** | æ¶ˆæ¯å¤´å±æ€§ | æœ€é«˜ | æœ€å¤æ‚ | å¤æ‚çš„å¤šç»´åº¦è·¯ç”± |
| **Topic** | é€šé…ç¬¦è·¯ç”±é”® | é«˜ | ä¸­ç­‰ | å±‚æ¬¡åŒ–çš„æ¶ˆæ¯åˆ†ç±» |
| **Direct** | ç²¾ç¡®è·¯ç”±é”® | ä¸­ç­‰ | ç®€å• | ç‚¹å¯¹ç‚¹æˆ–ç®€å•åˆ†ç»„ |
| **Fanout** | æ— æ¡ä»¶å¹¿æ’­ | æœ€ä½ | æœ€ç®€å• | å¹¿æ’­é€šçŸ¥ |

## æ³¨æ„äº‹é¡¹

1. **å‚æ•°åŒ¹é…è§„åˆ™**: å‘å¸ƒè€…å‘å¸ƒçš„å­—å…¸ keys å¿…é¡»ä¸æ¶ˆè´¹è€…å‡½æ•°çš„å‚æ•°åå®Œå…¨ä¸€è‡´
   - å‘å¸ƒ: `{'user_id': '...', 'title': '...', 'content': '...', 'timestamp': '...'}`
   - æ¶ˆè´¹: `def consumer(user_id: str, title: str, content: str, timestamp: str):`

2. **å¤´å±æ€§ç±»å‹**: æ‰€æœ‰å¤´å±æ€§å€¼éƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œéœ€è¦æ³¨æ„ç±»å‹è½¬æ¢

3. **æ€§èƒ½è€ƒè™‘**: Headers è·¯ç”±æ¯”å…¶ä»–æ¨¡å¼ç¨æ…¢ï¼Œå› ä¸ºéœ€è¦æ£€æŸ¥å¤šä¸ªå¤´å±æ€§

4. **è·¯ç”±é”®è¢«å¿½ç•¥**: Headers æ¨¡å¼å®Œå…¨å¿½ç•¥è·¯ç”±é”®ï¼ŒåªåŸºäºå¤´å±æ€§è·¯ç”±

5. **åŒ¹é…ç­–ç•¥é€‰æ‹©**: 
   - ä½¿ç”¨ `all` æ—¶è¦ç¡®ä¿æ¶ˆæ¯å¤´åŒ…å«æ‰€æœ‰å¿…éœ€å±æ€§
   - ä½¿ç”¨ `any` æ—¶è¦æ³¨æ„å¯èƒ½çš„æ„å¤–åŒ¹é…

6. **è°ƒè¯•å»ºè®®**: å»ºè®®åœ¨å¼€å‘é˜¶æ®µæ·»åŠ å®¡è®¡é˜Ÿåˆ—æ¥è§‚å¯Ÿæ‰€æœ‰æ¶ˆæ¯çš„è·¯ç”±æƒ…å†µ
