# Funboost 定时任务管理界面规划文档

## 一、现有管理界面分析

### 1.1 当前页面结构
现有管理界面采用**左侧导航栏 + 右侧内容区（iframe）**的经典布局：

**左侧导航栏页面**：
1. 函数结果表 - `fun_result_table.html`
2. 消费速率图 - `conusme_speed.html`
3. 运行中消费者(by ip) - `running_consumer_by_ip.html`
4. 运行中消费者(by queue) - `running_consumer_by_queue_name.html`
5. **队列操作** - `queue_op.html` (最复杂的页面，包含表格、图表、模态框等)
6. rpc调用 - `rpc_call.html`
7. 说明 - `about.html`

### 1.2 现有设计风格
- **UI框架**: Bootstrap 3.3.7
- **表格工具**: Tabulator 5.5.0
- **图表工具**: Chart.js
- **配色**: 深色调配色方案（sidebar: #296074，激活状态: #0BBAF8）
- **图标**: Font Awesome 4.7.0
- **交互模式**: 模态框为主，避免页面跳转

## 二、定时任务管理界面设计方案 ⭐

### 2.1 推荐方案：单页面集成模式（最佳）

**核心思路**：在**一个页面**中集成所有定时任务管理功能，类似现有的 `queue_op.html`

#### 页面名称
`timing_jobs_management.html`

#### 导航栏新增项
```
定时任务管理 (图标: fa-clock-o)
```

#### 页面布局结构

```
┌─────────────────────────────────────────────────────────┐
│  [搜索框: 队列名/任务ID]  [筛选: 所有/运行中/已暂停]     │
│  [按钮: 添加任务] [按钮: 刷新列表] [按钮: 自动刷新]      │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    定时任务列表表格                        │
│ ┌───────┬────────┬────────┬──────────┬────────┬────────┐ │
│ │任务ID │队列名称│触发器  │下次执行时间│状态   │操作   │ │
│ ├───────┼────────┼────────┼──────────┼────────┼────────┤ │
│ │job_001│test_q  │interval│2025-12-11│运行中  │[详情] │ │
│ │       │        │10s     │16:45:00   │        │[暂停] │ │
│ │       │        │        │           │        │[删除] │ │
│ ├───────┼────────┼────────┼──────────┼────────┼────────┤ │
│ │job_002│data_q  │cron    │2025-12-12│运行中  │[详情] │ │
│ │       │        │每天2点  │02:00:00   │        │[暂停] │ │
│ │       │        │        │           │        │[删除] │ │
│ └───────┴────────┴────────┴──────────┴────────┴────────┘ │
│                  [分页控件]                               │
└─────────────────────────────────────────────────────────┘
```

#### 功能模块划分

##### 1. **顶部操作栏**
- 搜索框（支持队列名、任务ID搜索）
- 筛选下拉框（所有任务/运行中/已暂停）
- 按队列筛选下拉框（动态加载队列列表）
- 添加任务按钮（打开添加任务模态框）
- 刷新列表按钮
- 自动刷新切换开关（10秒自动刷新）

##### 2. **任务列表表格**（使用 Tabulator）
| 列名 | 字段 | 说明 |
|------|------|------|
| 任务ID | job_id | 点击可复制 |
| 队列名称 | queue_name | 显示队列名 |
| 触发器 | trigger | interval/cron/date |
| 触发参数 | trigger_params | 悬停显示详细参数 |
| 下次执行时间 | next_run_time | 实时倒计时 |
| 状态 | status | 运行中/已暂停 |
| 操作 | actions | 详情/编辑/暂停/恢复/删除 |

##### 3. **模态框设计**

###### 3.1 添加任务模态框
```
┌────────────────  添加定时任务  ────────────────┐
│                                                 │
│  队列名称: [下拉选择框] ────────────────────┐   │
│                                              │   │
│  任务ID: [输入框] (可选，留空自动生成)        │   │
│                                              │   │
│  触发器类型: ○ 一次性  ○ 间隔执行  ● 定时执行 │   │
│                                              │   │
│  ┌─── 定时执行配置 (cron) ───────────────┐  │   │
│  │ 年:   [*    ] 月: [*    ] 日: [*    ] │  │   │
│  │ 周:   [     ] 星期: [   ] 时: [9    ] │  │   │
│  │ 分:   [0    ] 秒: [0    ]             │  │   │
│  │                                        │  │   │
│  │ 说明: 每天上午9点执行                   │  │   │
│  │ 预览: 下次执行时间 2025-12-12 09:00:00  │  │   │
│  └────────────────────────────────────────┘  │   │
│                                              │   │
│  存储方式: ○ Redis (推荐)  ○ 内存            │   │
│                                              │   │
│  [取消]  [预览执行时间]  [确定添加]           │   │
└──────────────────────────────────────────────┘
```

###### 3.2 任务详情模态框
```
┌────────────────  任务详情  ────────────────┐
│                                             │
│  任务ID: job_test_001                       │
│  队列名称: test_queue                        │
│  触发器类型: interval                        │
│  触发参数:                                   │
│    - seconds: 10                            │
│  状态: 运行中                                │
│  创建时间: 2025-12-11 16:30:00              │
│  下次执行: 2025-12-11 16:45:30 (剩余 58秒)  │
│  上次执行: 2025-12-11 16:45:20              │
│  执行次数: 1,234 次                          │
│  失败次数: 5 次                              │
│  存储方式: redis                             │
│                                             │
│  [关闭]  [编辑]  [删除]                      │
└─────────────────────────────────────────────┘
```

###### 3.3 批量操作确认框
```
┌────────  确认删除  ────────┐
│                            │
│  确定要删除以下任务吗？      │
│                            │
│  • job_001 (test_queue)    │
│  • job_002 (data_queue)    │
│                            │
│  此操作不可撤销！           │
│                            │
│  [取消]  [确认删除]         │
└────────────────────────────┘
```

### 2.2 备选方案：多页面分离模式

如果觉得单页面太复杂，可以拆分为2个页面：

#### 页面1：`timing_jobs_list.html` - 任务列表
- 任务列表表格
- 搜索、筛选
- 基础操作（暂停、恢复、删除）
- 导航按钮：[添加任务] 跳转到添加页面

#### 页面2：`timing_jobs_add.html` - 添加/编辑任务
- 表单式布局
- 三种触发器的配置界面
- 即时预览功能
- 返回列表按钮

**不推荐理由**：
- 增加页面跳转，用户体验不如单页面
- 与现有管理界面风格不统一（现有页面都是单页面设计）

### 2.3 最简方案：集成到队列操作页面

在现有的 `queue_op.html` 页面中增加一个 Tab 标签页：

```
[队列列表] | [定时任务]
```

**优点**：
- 不需要新增导航项
- 队列和定时任务高度相关，放在一起合理

**缺点**：
- 队列操作页面已经很复杂，再加定时任务会更臃肿
- 不易扩展和维护

## 三、推荐的功能清单

### 3.1 基础功能（必须）
✅ 查看所有定时任务列表
✅ 添加定时任务（三种触发器）
✅ 删除单个任务
✅ 暂停/恢复任务
✅ 查看任务详情
✅ 搜索和筛选

### 3.2 进阶功能（建议）
🔶 批量删除任务
🔶 编辑任务（先删除后添加）
🔶 执行记录查看（如果有日志）
🔶 下次执行时间倒计时
🔶 触发器参数预览和验证
🔶 任务模板（常用配置快速添加）

### 3.3 高级功能（可选）
⭕ 任务执行历史统计
⭕ 任务依赖关系可视化
⭕ 导入/导出任务配置
⭕ 任务执行日志实时查看
⭕ 错误重试配置

## 四、技术实现要点

### 4.1 前端
- **表格**: Tabulator（与现有队列操作页面一致）
- **模态框**: Bootstrap Modal
- **AJAX**: jQuery（与现有代码一致）
- **表单验证**: 客户端实时验证 + 服务端验证
- **实时更新**: 可选的10秒自动刷新

### 4.2 后端接口（已完成）
已经在 `flask_blueprint` 中实现了7个接口：
- POST `/funboost/add_timing_job` - 添加任务
- GET `/funboost/get_timing_jobs` - 获取任务列表
- GET `/funboost/get_timing_job` - 获取任务详情
- DELETE `/funboost/delete_timing_job` - 删除任务
- DELETE `/funboost/delete_all_timing_jobs` - 批量删除
- POST `/funboost/pause_timing_job` - 暂停任务
- POST `/funboost/resume_timing_job` - 恢复任务

### 4.3 数据流
```
用户操作 → 前端事件 → AJAX 请求 → Flask Blueprint 
→ ApsJobAdder → APScheduler → Redis/Memory
```

## 五、UI/UX 设计要点

### 5.1 用户友好性
1. **表单智能化**：
   - 选择队列后自动加载队列信息
   - 触发器类型切换时动态显示对应配置项
   - 输入参数时实时预览下次执行时间

2. **操作反馈**：
   - 所有操作都有加载状态提示
   - 成功/失败都有明确的消息提示
   - 危险操作（删除）需要二次确认

3. **数据可视化**：
   - 状态用颜色区分（运行中=绿色，已暂停=黄色）
   - 下次执行时间显示倒计时
   - 触发器参数用人性化语言描述

### 5.2 一致性保持
- 按钮样式与队列操作页面一致
- 表格配色与现有表格一致
- 模态框布局与现有模态框一致
- 图标使用 Font Awesome 4.7.0

### 5.3 响应式设计
- 表格支持横向滚动（列较多时）
- 模态框在小屏幕上自适应
- 操作按钮在小屏幕上堆叠显示

## 六、开发建议

### 6.1 分阶段实现

**第一阶段：MVP（最小可行产品）**
1. 任务列表展示
2. 添加任务（三种触发器）
3. 删除任务
4. 基础搜索

**第二阶段：功能完善**
5. 暂停/恢复任务
6. 任务详情查看
7. 高级筛选
8. 自动刷新

**第三阶段：体验优化**
9. 参数预览和验证
10. 批量操作
11. 执行历史
12. 错误处理优化

### 6.2 代码组织
```
timing_jobs_management.html
├── HEAD: 引入 CSS/JS
├── BODY:
│   ├── 顶部操作栏
│   ├── 任务列表表格 (Tabulator)
│   ├── 添加任务模态框
│   ├── 任务详情模态框
│   └── 各种确认对话框
└── SCRIPT:
    ├── Tabulator 初始化
    ├── 模态框控制
    ├── AJAX 请求封装
    └── 工具函数（时间格式化等）
```

## 七、总结与建议

### 推荐实现方案
**单页面集成模式** (`timing_jobs_management.html`)

### 推荐理由
1. ✅ 符合现有管理界面的设计模式
2. ✅ 用户体验流畅，无需页面跳转
3. ✅ 易于维护和扩展
4. ✅ 可以复用现有的 CSS/JS 组件
5. ✅ 与队列操作页面风格统一

### 核心特点
- **一个导航项**：定时任务管理
- **一个页面文件**：timing_jobs_management.html
- **三个主要模态框**：添加任务、任务详情、确认对话框
- **一个表格**：Tabulator 任务列表
- **七个后端接口**：已完成（Flask Blueprint）

### 预期效果
用户可以在一个页面中完成所有定时任务管理操作，无需跳转，体验流畅，与现有管理界面风格完全统一。

---

## 附录：参考示例

### Cron 表达式友好提示
```javascript
const cronExamples = {
    '每天上午9点': { hour: '9', minute: '0', second: '0' },
    '每2小时': { hour: '*/2', minute: '0', second: '0' },
    '工作日上午10点': { day_of_week: '0-4', hour: '10', minute: '0' },
    '每月1号凌晨2点': { day: '1', hour: '2', minute: '0' }
};
```

### 触发器类型说明
```
date: 一次性任务，在指定时间执行一次
interval: 间隔任务，按固定间隔重复执行
cron: 定时任务，按 Cron 表达式执行
```

### 状态颜色规范
```css
.status-running { background-color: #4CAF50; } /* 绿色 */
.status-paused { background-color: #FF9800; }  /* 橙色 */
.status-error { background-color: #F44336; }   /* 红色 */
```
