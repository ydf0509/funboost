# Funboost ä»»åŠ¡é“¾è·¯è¿½è¸ªå®ç°æ–¹æ¡ˆ

## ä¸€ã€æ˜¯å¦å¸¸è§éœ€æ±‚ï¼Ÿ

**éå¸¸å¸¸è§**ï¼Œå°¤å…¶åœ¨ä»¥ä¸‹åœºæ™¯ï¼š

1. **å¾®æœåŠ¡æ¶æ„**ï¼šä¸€ä¸ªè¯·æ±‚å¯èƒ½è§¦å‘å¤šä¸ªé˜Ÿåˆ—ä»»åŠ¡ï¼Œéœ€è¦è¿½è¸ªå®Œæ•´è°ƒç”¨é“¾
2. **RPC é“¾å¼è°ƒç”¨**ï¼šå‡½æ•° A è°ƒç”¨å‡½æ•° Bï¼ŒB åˆè°ƒç”¨ Cï¼Œéœ€è¦çŸ¥é“å®Œæ•´è·¯å¾„
3. **é—®é¢˜æ’æŸ¥**ï¼šå½“æŸä¸ªä»»åŠ¡å¤±è´¥æ—¶ï¼Œéœ€è¦çŸ¥é“æ˜¯è°è§¦å‘çš„ã€å½±å“äº†è°
4. **æ€§èƒ½åˆ†æ**ï¼šåˆ†ææ•´ä¸ªè°ƒç”¨é“¾çš„è€—æ—¶ç“¶é¢ˆ

ä¸šç•Œæˆç†Ÿæ–¹æ¡ˆå¦‚ **Jaeger**ã€**Zipkin**ã€**SkyWalking**ã€**é˜¿é‡Œé¹°çœ¼** éƒ½æ˜¯åšè¿™ä¸ªçš„ã€‚

---

## äºŒã€å®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é“¾è·¯è¿½è¸ªæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   Task A (root)                                             â”‚
â”‚   trace_id: abc123                                          â”‚
â”‚   task_id: task_001                                         â”‚
â”‚   parent_task_id: null                                      â”‚
â”‚        â”‚                                                    â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚        â–¼              â–¼              â–¼                      â”‚
â”‚   Task B          Task C          Task D                    â”‚
â”‚   trace_id: abc123  trace_id: abc123  trace_id: abc123      â”‚
â”‚   task_id: task_002  task_id: task_003  task_id: task_004   â”‚
â”‚   parent: task_001   parent: task_001   parent: task_001    â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚   Task E                                                    â”‚
â”‚   trace_id: abc123                                          â”‚
â”‚   task_id: task_005                                         â”‚
â”‚   parent: task_002                                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¦‚å¿µ

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `trace_id` | æ•´æ¡è°ƒç”¨é“¾çš„å”¯ä¸€æ ‡è¯†ï¼Œä»æ ¹ä»»åŠ¡ä¸€ç›´ä¼ é€’åˆ°æœ€æœ«ç«¯ |
| `task_id` | å½“å‰ä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼ˆfunboost å·²æœ‰ï¼‰ |
| `parent_task_id` | çˆ¶ä»»åŠ¡çš„ task_idï¼Œç”¨äºæ„å»ºè°ƒç”¨æ ‘ |
| `span_id` | å¯é€‰ï¼Œæ›´ç»†ç²’åº¦çš„è¿½è¸ªï¼ˆå¦‚å‡½æ•°å†…éƒ¨å¤šæ¬¡è°ƒç”¨ï¼‰ |
| `depth` | è°ƒç”¨æ·±åº¦ï¼Œç”¨äºé™åˆ¶é“¾è·¯å±‚çº§é˜²æ­¢æ— é™é€’å½’ |

---

## ä¸‰ã€å®ç°æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®æ¨¡å‹æ‰©å±•

åœ¨æ¶ˆæ¯ä½“å’Œç»“æœæŒä¹…åŒ–ä¸­å¢åŠ è¿½è¸ªå­—æ®µï¼š

```python
# æ¶ˆæ¯ä½“æ‰©å±•
{
    "task_id": "task_001",
    "trace_id": "trace_abc123",      # æ–°å¢ï¼šé“¾è·¯è¿½è¸ªID
    "parent_task_id": "task_000",    # æ–°å¢ï¼šçˆ¶ä»»åŠ¡ID
    "depth": 2,                       # æ–°å¢ï¼šè°ƒç”¨æ·±åº¦
    # ... åŸæœ‰å­—æ®µ
}
```

### ç¬¬äºŒæ­¥ï¼šä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶

```python
# æ–¹æ¡ˆï¼šä½¿ç”¨ contextvars åœ¨å‡½æ•°æ‰§è¡ŒæœŸé—´ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡
import contextvars

# å½“å‰ä»»åŠ¡çš„è¿½è¸ªä¸Šä¸‹æ–‡
_trace_context = contextvars.ContextVar('trace_context', default=None)

class TraceContext:
    trace_id: str
    task_id: str
    depth: int
```

å½“æ¶ˆè´¹è€…æ‰§è¡Œå‡½æ•°æ—¶ï¼š
1. ä»æ¶ˆæ¯ä¸­æå– `trace_id`ã€`parent_task_id`
2. è®¾ç½®åˆ° `contextvars` ä¸­
3. å¦‚æœå‡½æ•°å†…éƒ¨è°ƒç”¨äº†å…¶ä»– funboost é˜Ÿåˆ—ï¼Œè‡ªåŠ¨æ³¨å…¥è¿½è¸ªä¿¡æ¯

### ç¬¬ä¸‰æ­¥ï¼šè‡ªåŠ¨æ³¨å…¥æœºåˆ¶

ä¿®æ”¹ `publisher.publish()` æ–¹æ³•ï¼š

```python
def publish(self, msg_body, task_id=None, ...):
    # è·å–å½“å‰è¿½è¸ªä¸Šä¸‹æ–‡
    ctx = _trace_context.get()
    
    if ctx:
        # å­ä»»åŠ¡ç»§æ‰¿çˆ¶ä»»åŠ¡çš„ trace_id
        trace_id = ctx.trace_id
        parent_task_id = ctx.task_id
        depth = ctx.depth + 1
    else:
        # æ ¹ä»»åŠ¡ï¼Œç”Ÿæˆæ–°çš„ trace_id
        trace_id = generate_trace_id()
        parent_task_id = None
        depth = 0
    
    # æ³¨å…¥åˆ°æ¶ˆæ¯ä½“
    full_msg = {
        **msg_body,
        '_trace_id': trace_id,
        '_parent_task_id': parent_task_id,
        '_depth': depth,
    }
```

### ç¬¬å››æ­¥ï¼šå­˜å‚¨æ‰©å±•

MongoDB ç»“æœè¡¨å¢åŠ ç´¢å¼•ï¼š

```python
# ç´¢å¼•è®¾è®¡
db.collection.create_index([('trace_id', 1)])
db.collection.create_index([('parent_task_id', 1)])
db.collection.create_index([('trace_id', 1), ('depth', 1)])
```

### ç¬¬äº”æ­¥ï¼šWeb é¡µé¢å®ç°

#### 1. é“¾è·¯è¿½è¸ªæŸ¥è¯¢é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” é“¾è·¯è¿½è¸ªæŸ¥è¯¢                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Trace ID: [_______________]  æˆ–  Task ID: [__________] â”‚
â”‚                                        [ğŸ” æŸ¥è¯¢]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. è°ƒç”¨é“¾å¯è§†åŒ–ï¼ˆæ ‘å½¢ç»“æ„ï¼‰

```
ğŸ“ trace_id: abc123  æ€»è€—æ—¶: 2.5s  ä»»åŠ¡æ•°: 5

â”œâ”€ âœ… my_consuming_function [task_001]
â”‚     â””â”€ è€—æ—¶: 0.3s | é˜Ÿåˆ—: queue_a | å¼€å§‹: 14:30:01
â”‚
â”œâ”€â”€â”€ âœ… process_data [task_002]
â”‚       â””â”€ è€—æ—¶: 1.2s | é˜Ÿåˆ—: queue_b | å¼€å§‹: 14:30:02
â”‚
â”‚     â”œâ”€â”€â”€ âœ… save_to_db [task_005]
â”‚     â”‚       â””â”€ è€—æ—¶: 0.5s | é˜Ÿåˆ—: queue_c | å¼€å§‹: 14:30:03
â”‚
â”œâ”€â”€â”€ âœ… send_notification [task_003]
â”‚       â””â”€ è€—æ—¶: 0.2s | é˜Ÿåˆ—: queue_d | å¼€å§‹: 14:30:02
â”‚
â””â”€â”€â”€ âŒ update_cache [task_004]
        â””â”€ è€—æ—¶: 0.8s | é˜Ÿåˆ—: queue_e | å¤±è´¥: Redis è¿æ¥è¶…æ—¶
```

#### 3. æ—¶é—´çº¿è§†å›¾ï¼ˆç”˜ç‰¹å›¾ï¼‰

```
æ—¶é—´è½´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
        0s        1s        2s        3s
        â”‚         â”‚         â”‚         â”‚
task_001 â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
task_002 â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
task_005 â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
task_003 â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
task_004 â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ âŒ
```

---

## å››ã€æŸ¥è¯¢ API è®¾è®¡

```python
# 1. æ ¹æ® trace_id è·å–å®Œæ•´è°ƒç”¨é“¾
GET /funboost/trace/{trace_id}
# è¿”å›: è¯¥ trace ä¸‹æ‰€æœ‰ä»»åŠ¡ï¼ŒæŒ‰ depth å’Œæ—¶é—´æ’åº

# 2. æ ¹æ® task_id è·å–æ‰€å±è°ƒç”¨é“¾
GET /funboost/trace/by_task/{task_id}
# è¿”å›: å…ˆæŸ¥å‡º trace_idï¼Œå†è¿”å›å®Œæ•´è°ƒç”¨é“¾

# 3. è·å–ä»»åŠ¡çš„å­ä»»åŠ¡
GET /funboost/task/{task_id}/children
# è¿”å›: parent_task_id = task_id çš„æ‰€æœ‰ä»»åŠ¡
```

---

## äº”ã€å®ç°éš¾åº¦è¯„ä¼°

| æ¨¡å— | éš¾åº¦ | å·¥ä½œé‡ | è¯´æ˜ |
|------|------|--------|------|
| æ•°æ®æ¨¡å‹æ‰©å±• | â­ | 1å¤© | å¢åŠ å­—æ®µï¼Œå…¼å®¹æ—§æ•°æ® |
| ä¸Šä¸‹æ–‡ä¼ é€’ | â­â­ | 2å¤© | contextvars + æ¶ˆè´¹è€…æ”¹é€  |
| Publisher è‡ªåŠ¨æ³¨å…¥ | â­â­ | 1å¤© | æ”¹é€  publish æ–¹æ³• |
| MongoDB å­˜å‚¨ | â­ | 0.5å¤© | ç´¢å¼•ä¼˜åŒ– |
| Web æŸ¥è¯¢é¡µé¢ | â­â­ | 2å¤© | åŸºç¡€è¡¨æ ¼å±•ç¤º |
| å¯è§†åŒ–è°ƒç”¨å›¾ | â­â­â­ | 3å¤© | éœ€è¦å‰ç«¯å›¾å½¢åº“ï¼ˆå¦‚ D3.js/AntVï¼‰ |

**æ€»è®¡çº¦ 1-2 å‘¨**

---

## å…­ã€å»ºè®®å®æ–½é¡ºåº

### ç¬¬ä¸€é˜¶æ®µï¼ˆMVPï¼‰
- å¢åŠ  `trace_id`ã€`parent_task_id` å­—æ®µ
- æ‰‹åŠ¨ä¼ é€’ï¼ˆç”¨æˆ·åœ¨ publish æ—¶å¯é€‰ä¼ å…¥ï¼‰
- Web é¡µé¢æ”¯æŒæŒ‰ trace_id æŸ¥è¯¢

### ç¬¬äºŒé˜¶æ®µï¼ˆè‡ªåŠ¨åŒ–ï¼‰
- ä½¿ç”¨ `contextvars` å®ç°è‡ªåŠ¨ä¸Šä¸‹æ–‡ä¼ é€’
- å­ä»»åŠ¡è‡ªåŠ¨ç»§æ‰¿çˆ¶ä»»åŠ¡çš„ trace_id

### ç¬¬ä¸‰é˜¶æ®µï¼ˆå¯è§†åŒ–ï¼‰
- è°ƒç”¨é“¾æ ‘å½¢å±•ç¤º
- æ—¶é—´çº¿ç”˜ç‰¹å›¾
- æ€§èƒ½åˆ†æï¼ˆç“¶é¢ˆè¯†åˆ«ï¼‰

---

## ä¸ƒã€ä¸ç°æœ‰ä»£ç çš„å…³è”

### ç°æœ‰ current_task æ¨¡å—

Funboost å·²æœ‰ `funboost/core/current_task.py`ï¼Œæä¾›äº†åœ¨å‡½æ•°æ‰§è¡ŒæœŸé—´è·å–å½“å‰ä»»åŠ¡ä¿¡æ¯çš„èƒ½åŠ›ï¼š

```python
from funboost import current_task

# åœ¨è¢«è£…é¥°çš„å‡½æ•°å†…éƒ¨å¯ä»¥è·å–
task_id = current_task.task_id
queue_name = current_task.queue_name
```

é“¾è·¯è¿½è¸ªå¯ä»¥æ‰©å±•æ­¤æ¨¡å—ï¼Œå¢åŠ ï¼š
- `current_task.trace_id`
- `current_task.parent_task_id`
- `current_task.depth`

### ç°æœ‰ç»“æœæŒä¹…åŒ–

`funboost/core/function_result_status_saver.py` å·²ç»å®ç°äº†ä»»åŠ¡çŠ¶æ€å’Œç»“æœçš„ MongoDB æŒä¹…åŒ–ã€‚

é“¾è·¯è¿½è¸ªéœ€è¦åœ¨ä¿å­˜æ—¶å¢åŠ  `trace_id` å’Œ `parent_task_id` å­—æ®µã€‚

